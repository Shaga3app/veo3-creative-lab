<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shaga3app ¬∑ AI Creative Playground</title>

  <style>
    :root{
      --bg:#0b0f18;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.12);
      --accent:#5b5cff;
      --accent2:#22c55e;
      --btnText:#07120a;

      --radius:18px;
      --radius2:16px;
      --shadow:0 18px 40px rgba(0,0,0,.35);

      --heroGradA: rgba(91,92,255,.25);
      --heroGradB: rgba(34,197,94,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 900px at 25% -10%, var(--heroGradA), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, var(--heroGradB), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width:900px;margin:0 auto;padding:16px 14px 36px;}
    .card{
      background:linear-gradient(180deg, var(--panel), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topBar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--panel2);
    }
    .brandLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .brandLogo{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
    }
    .brandLogo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:42vw;
      opacity:.95;
    }

    .topRight{display:flex;align-items:center;gap:10px;flex:0 0 auto;}
    .pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid color-mix(in srgb, var(--accent) 55%, transparent);
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .langBtn{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); color: var(--text);
      background: rgba(255,255,255,.06);
      font-weight:900; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .hero{margin:18px 0 10px}
    .hero h1{font-size:52px;line-height:1.05;margin:6px 0 8px;font-weight:950;letter-spacing:-.02em}
    .hero p{color:var(--muted);font-size:16px;max-width:560px;line-height:1.4;margin:0}

    .sectionLabel{
      margin:18px 0 8px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:color-mix(in srgb, var(--muted) 85%, transparent);
    }

    .lockedBox{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .lockedTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .lockedTag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:800;
    }
    .lockedPrompt{
      margin-top:10px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      line-height:1.45;
      color: rgba(229,231,235,.82);
      white-space:pre-wrap;
      max-height: 160px;
      overflow:auto;
    }

    .previewCard{
      margin-top:12px;
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .previewHeader{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:10px;
      color:color-mix(in srgb, var(--muted) 90%, transparent);
      font-size:12px;font-weight:800;
    }
    .badge{
      padding:5px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:900;
      color: rgba(229,231,235,.9);
      white-space:nowrap;
    }

    .mainStage{
      position:relative;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      min-height: 320px;
      aspect-ratio: 9 / 16;
    }
    .mainStage img,
    .mainStage video{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }
    .mainStage video{
      display:none;
      background:#000;
    }
    .playOverlay{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    .playBtn{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:12px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      backdrop-filter: blur(8px);
    }

    .thumbRowWrap{
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:10px;
    }
    .thumbRow{
      display:flex;gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .thumbRow::-webkit-scrollbar{height:8px}
    .thumbRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

    .thumb{
      flex:0 0 auto;
      width:110px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      cursor:pointer;
      scroll-snap-align:start;
      position:relative;
      transition: transform .12s ease, border-color .12s ease;
    }
    .thumb:hover{transform: translateY(-1px)}
    .thumb.on{border-color: color-mix(in srgb, var(--accent2) 70%, white 0%); box-shadow:0 0 0 2px rgba(34,197,94,.12) inset;}
    .thumb img{width:100%;height:70px;object-fit:cover;display:block}
    .thumbMeta{
      padding:7px 8px 8px;
      display:flex;justify-content:space-between;align-items:center;
      gap:6px;
      font-size:11px;
      color: rgba(229,231,235,.9);
    }
    .thumbTag{
      font-size:10px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .thumbPlay{
      position:absolute;left:8px;top:8px;
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
    }
    .thumbDots{
      display:flex;justify-content:center;gap:6px;
      padding-top:8px;
    }
    .dot{width:6px;height:6px;border-radius:999px;background:rgba(255,255,255,.18)}
    .dot.on{background: color-mix(in srgb, var(--accent2) 80%, transparent);}

    .modeBar{
      margin-top:14px;
      display:flex;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      background: var(--panel2);
    }
    .modeBtn{
      flex:1;
      padding:10px;
      border-radius:12px;
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
    }
    .modeBtn.on{
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}

    .field{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .field label{font-size:13px;margin-bottom:6px;display:block;font-weight:800;color:rgba(229,231,235,.92)}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .field input::placeholder{color:rgba(148,163,184,.65)}
    .miniHint{margin-top:10px;font-size:12px;color: var(--muted);line-height:1.35;opacity:.95}

    .result{
      display:none;
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: var(--panel2);
    }
    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:none;
      font-weight:950;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      width:100%;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
    }
    .btn.primary{
      background:linear-gradient(180deg, var(--accent2), color-mix(in srgb, var(--accent2) 70%, #000 30%));
      color:var(--btnText);
      border:1px solid rgba(0,0,0,.10);
    }

    .actionsUnderInputs{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .actionsUnderInputs .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media(min-width:720px){
      .actionsUnderInputs .row2{max-width:520px}
      .actionsUnderInputs .primaryWrap{max-width:520px}
    }

    body[dir="rtl"] .hero h1{letter-spacing:0}
    body[dir="rtl"] .brandTitle{max-width:50vw}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="topBar">
        <div class="brandLeft">
          <div class="brandLogo"><img id="brandLogo" alt="logo"></div>
          <div class="brandTitle" id="brandTitle">Shaga3app ¬∑ AI Video Lab</div>
        </div>

        <div class="topRight">
          <button class="langBtn" id="langToggle" type="button">AR</button>
          <div class="pill" id="betaPill">Beta ¬∑ Shaga3app powered</div>
        </div>
      </div>

      <div class="hero">
        <h1 id="heroTitle">Play with our<br>guided video<br>prompt</h1>
        <p id="heroDesc">You get up to <b id="triesInline">2</b> tries. The core concept is fixed by us; you just add your creative twist ‚ú®</p>
      </div>

      <div class="sectionLabel" id="baseLabel">BASE CONCEPT (LOCKED)</div>
      <div class="lockedBox">
        <div class="lockedTop">
          <div class="lockedTag" id="lockedTag">üîí Locked</div>
          <div class="lockedTag"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">2</b></div>
        </div>
        <div class="lockedPrompt" id="basePrompt"></div>
      </div>

      <div class="previewCard">
        <div class="previewHeader">
          <div id="selectedLabel">Selected demo</div>
          <div class="badge" id="formatBadge">9:16 ‚Ä¢ 5‚Äì8s</div>
        </div>

        <div class="mainStage">
          <img id="mainPoster" alt="Selected poster" />
          <video id="mainVideo" controls playsinline preload="metadata"></video>

          <div class="playOverlay">
            <button class="playBtn" id="playBtn" type="button">‚ñ∂ <span id="playTxt">Play</span></button>
          </div>
        </div>

        <div class="thumbRowWrap" id="thumbRowWrap">
          <div class="thumbRow" id="thumbRow"></div>
          <div class="thumbDots" id="thumbDots"></div>
        </div>

        <div class="miniHint" id="saveWarn" style="margin-top:10px;">
          This page does not save your generated video. Please download it or copy the link before leaving.
        </div>
      </div>

      <div class="sectionLabel" id="modeLabel">CHOOSE INPUT MODE</div>
      <div class="modeBar">
        <button class="modeBtn on" id="modeText" type="button">üìù <span id="modeTextTxt">Text prompt</span></button>
        <button class="modeBtn" id="modeImages" type="button">üñºÔ∏è <span id="modeImgTxt">Image guidance</span></button>
      </div>

      <div class="field span2" id="imagesBox" style="display:none; margin-top:10px;">
        <label id="lblImages">Start image (required) + End image (optional)</label>
        <input type="file" id="startImg" accept="image/*">
        <input type="file" id="endImg" accept="image/*" style="margin-top:8px;">

        <div id="i2vPreview" style="display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column; gap:6px;">
            <div style="font-size:12px; opacity:.75;" id="startPrevLbl">Start image (required)</div>
            <img id="startPreview" alt="start preview"
                 style="width:120px; height:120px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.12); display:block; opacity:0;">
          </div>

          <div style="display:flex; flex-direction:column; gap:6px;">
            <div style="font-size:12px; opacity:.75;" id="endPrevLbl">End image (optional)</div>
            <img id="endPreview" alt="end preview"
                 style="width:120px; height:120px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.12); display:block; opacity:0;">
          </div>
        </div>

        <div class="miniHint" id="hintImages">
          Upload a start image to guide the video. Add an optional end image if you want the motion to land on a final frame.
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label id="lblSubject">Main subject / character</label>
          <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
        </div>
        <div class="field">
          <label id="lblLocation">Location / environment</label>
          <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
        </div>

        <div class="field span2">
          <label id="lblTwist">Extra creative twist</label>
          <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
        </div>
      </div>

      <div class="actionsUnderInputs">
        <div class="primaryWrap">
          <button class="btn primary" id="generateBtn" type="button">‚ö° <span id="genTxt">Generate video</span></button>
        </div>
        <div class="row2">
          <button class="btn secondary" id="copyBtn" type="button">üîó <span id="copyTxt">Copy link</span></button>
          <button class="btn secondary" id="downloadBtn" type="button">‚¨á <span id="dlTxt">Download</span></button>
        </div>
      </div>

      <div class="result" id="resultBox">
        <div class="miniHint" id="timerText" style="display:block;margin-top:0;margin-bottom:10px;"></div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="miniHint" id="resultNote" style="margin-top:10px; white-space:pre-wrap;"></div>
      </div>

    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);

  let I2V_START_FILE = null;
  let I2V_END_FILE = null;

  function setPreview(imgEl, file){
    if(!imgEl) return;
    if(!file){
      imgEl.src = "";
      imgEl.style.opacity = "0";
      return;
    }
    const url = URL.createObjectURL(file);
    imgEl.src = url;
    imgEl.style.opacity = "1";
  }

  function initI2VInputs(){
    const startInput = $("startImg");
    const endInput = $("endImg");
    const startPreview = $("startPreview");
    const endPreview = $("endPreview");

    startInput.addEventListener("change", () => {
      I2V_START_FILE = startInput.files && startInput.files[0] ? startInput.files[0] : null;
      setPreview(startPreview, I2V_START_FILE);
    });

    endInput.addEventListener("change", () => {
      I2V_END_FILE = endInput.files && endInput.files[0] ? endInput.files[0] : null;
      setPreview(endPreview, I2V_END_FILE);
    });
  }

  const DEVICE_ID_KEY = "shaga3_device_id";
  function getDeviceId(){
    try{
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if(!id){
        id = "dev_" + (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random().toString(16).slice(2)));
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    }catch(e){
      return "dev_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }
  }

  const TRIALS_MAX = 2;
  const TRIALS_STATE_KEY = "shaga3_trials_state_v1";
  const TRIALS_WINDOW_MS = 24 * 60 * 60 * 1000;

  function loadTrialsState(){
    try{
      const raw = localStorage.getItem(TRIALS_STATE_KEY);
      if(!raw) return { windowStart: Date.now(), used: 0 };
      const s = JSON.parse(raw);
      if(!s || typeof s.windowStart !== "number" || typeof s.used !== "number"){
        return { windowStart: Date.now(), used: 0 };
      }
      if(Date.now() - s.windowStart >= TRIALS_WINDOW_MS){
        return { windowStart: Date.now(), used: 0 };
      }
      s.used = Math.max(0, Math.min(TRIALS_MAX, Math.floor(s.used)));
      return s;
    }catch(e){
      return { windowStart: Date.now(), used: 0 };
    }
  }

  function saveTrialsState(state){
    try{ localStorage.setItem(TRIALS_STATE_KEY, JSON.stringify(state)); }catch(e){}
  }

  function getTrialsLeftFromState(state){
    return Math.max(0, TRIALS_MAX - (state.used || 0));
  }

  let trialsState = loadTrialsState();
  let trials = getTrialsLeftFromState(trialsState);

  function setTrialsLeft(n){
    trials = Math.max(0, Math.min(TRIALS_MAX, Number(n||0)));
    $("trialsLeft").textContent = (currentLang==="ar") ? toArabicDigits(String(trials)) : String(trials);
    const triesNum = (currentLang==="ar") ? toArabicDigits(String(trials)) : String(trials);
    const t = i18n[currentLang];
    $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;
  }

  function consumeOneTrial(){
    const s = loadTrialsState();
    s.used = Math.min(TRIALS_MAX, (s.used||0) + 1);
    saveTrialsState(s);
    setTrialsLeft(getTrialsLeftFromState(s));
  }

  function hardLockTrialsToZero(){
    const s = loadTrialsState();
    s.used = TRIALS_MAX;
    saveTrialsState(s);
    setTrialsLeft(0);
  }

  const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
  const MODEL_ID = "veo-3.1-generate-001";
  const API_KEY = "v3_9f8c2d1a_6b7c8d9e_0a1b2c3d4e5f9n5v";

  const LAST_URL_KEY = "shaga3app_last_video_url";
  function saveLastUrl(url){ try{ localStorage.setItem(LAST_URL_KEY, url); }catch(e){} }
  function loadLastUrl(){ try{ return localStorage.getItem(LAST_URL_KEY) || ""; }catch(e){ return ""; } }

  const i18n = {
    en: {
      heroTitle: "Play with our<br>guided video<br>prompt",
      heroDescStart: "You get up to ",
      heroDescEnd: " tries. The core concept is fixed by us; you just add your creative twist ‚ú®",
      baseLabel: "BASE CONCEPT (LOCKED)",
      locked: "üîí Locked",
      trialsLabel: "Trials left:",
      selectedDemo: "Selected demo",
      play: "Play",
      modeLabel: "CHOOSE INPUT MODE",
      modeText: "Text prompt",
      modeImg: "Image guidance",
      lblSubject: "Main subject / character",
      lblLocation: "Location / environment",
      lblTwist: "Extra creative twist",
      lblImages: "Start image (required) + End image (optional)",
      hintImages: "Upload a start image to guide the video. Add an optional end image if you want the motion to land on a final frame.",
      phSubject: "Who is the main character? (age, style, wardrobe, vibe)",
      phLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
      phTwist: "Optional: camera move, mood, style, or one special detail.",
      gen: "Generate video",
      dl: "Download",
      copy: "Copy link",
      saveWarn: "This page does not save your generated video. Please download it or copy the link before leaving.",
      waiting: "Waiting for video‚Ä¶",
      ready: "Ready ‚úÖ",
      copied: "Link copied ‚úÖ",
      demoTag: "Demo",
      limitReached: "‚ùå You reached the max trials for today. Try again tomorrow.",
      startPrev: "Start image (required)",
      endPrev: "End image (optional)"
    },
    ar: {
      heroTitle: "ÿ¨ÿ±Ÿëÿ® ŸÖÿπÿßŸÜÿß<br>ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÅŸäÿØŸäŸà<br>ŸÖŸèŸàÿ¨ŸëŸéŸá",
      heroDescStart: "ŸÑÿØŸäŸÉ ",
      heroDescEnd: " ŸÖÿ≠ÿßŸàŸÑÿßÿ™. ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ´ÿßÿ®ÿ™ÿ©ÿõ ÿ£ŸÜÿ™ ŸÅŸÇÿ∑ ÿ£ÿ∂ŸêŸÅ ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸäÿ© ‚ú®",
      baseLabel: "ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä (ŸÖŸÇŸÅŸàŸÑ)",
      locked: "üîí ŸÖŸÇŸÅŸàŸÑ",
      trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
      selectedDemo: "ÿßŸÑÿØŸäŸÖŸà ÿßŸÑŸÖÿÆÿ™ÿßÿ±",
      play: "ÿ™ÿ¥ÿ∫ŸäŸÑ",
      modeLabel: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
      modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
      modeImg: "ÿ™Ÿàÿ¨ŸäŸá ÿ®ÿßŸÑÿµŸàÿ±",
      lblSubject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
      lblLocation: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
      lblTwist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ©",
      lblImages: "ÿµŸàÿ±ÿ© ÿ®ÿØÿßŸäÿ© (ÿ•ÿ¨ÿ®ÿßÿ±Ÿä) + ÿµŸàÿ±ÿ© ŸÜŸáÿßŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
      hintImages: "ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÑÿ™Ÿàÿ¨ŸäŸá ÿßŸÑŸÅŸäÿØŸäŸà. ŸàÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ© ŸÑŸà ÿπÿßŸäÿ≤ ÿßŸÑÿ≠ÿ±ŸÉÿ© ÿ™ŸÜÿ™ŸáŸä ÿπŸÑŸâ ŸÅÿ±ŸäŸÖ ŸÖÿ≠ÿØÿØ.",
      phSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
      phLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
      phTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
      gen: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
      dl: "ÿ™ÿ≠ŸÖŸäŸÑ",
      copy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
      saveWarn: "ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿß ÿ™ÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑŸÅŸäÿØŸäŸà ÿßŸÑŸÜÿßÿ™ÿ¨. ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ŸÖŸëŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿ£Ÿà ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨.",
      waiting: "ÿ®ŸÜÿ≥ÿ™ŸÜŸâ ÿßŸÑŸÅŸäÿØŸäŸà‚Ä¶",
      ready: "ÿ¨ÿßŸáÿ≤ ‚úÖ",
      copied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ",
      demoTag: "ÿØŸäŸÖŸà",
      limitReached: "‚ùå ŸàÿµŸÑÿ™ ŸÑŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÜŸáÿßÿ±ÿØÿ©. ÿ¨ÿ±Ÿëÿ® ÿ®ŸÉÿ±ÿ©.",
      startPrev: "ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© (ÿ•ÿ¨ÿ®ÿßÿ±Ÿä)",
      endPrev: "ÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)"
    }
  };

  function toArabicDigits(str){
    const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
    return String(str).replace(/[0-9]/g, d => map[d]);
  }

  let currentLang = "en";

  // =========================
  // FIX #1. Image uploads MUST include b64
  // =========================
  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const dataUrl = String(fr.result || "");
        const b64 = dataUrl.includes(",") ? dataUrl.split(",")[1] : "";
        if(!b64) return reject(new Error("Failed to read image"));
        resolve(b64);
      };
      fr.onerror = () => reject(new Error("Failed to read image"));
      fr.readAsDataURL(file);
    });
  }

  function assertStartFile(){
    if(!I2V_START_FILE){
      throw new Error(currentLang==="ar" ? "ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©." : "Please upload a Start image.");
    }
    const maxBytes = 3 * 1024 * 1024;
    if(I2V_START_FILE.size > maxBytes){
      throw new Error(currentLang==="ar" ? "ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØŸãÿß. ÿ¨ÿ±Ÿëÿ® ÿ£ŸÇŸÑ ŸÖŸÜ 3MB." : "Start image is too large. Please use under 3MB.");
    }
    if(I2V_END_FILE && I2V_END_FILE.size > maxBytes){
      throw new Error(currentLang==="ar" ? "ÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØŸãÿß. ÿ¨ÿ±Ÿëÿ® ÿ£ŸÇŸÑ ŸÖŸÜ 3MB." : "End image is too large. Please use under 3MB.");
    }
  }

  async function postJSON(payload){
    const url = API_URL + "?t=" + Date.now();
    const r = await fetch(url,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-API-KEY": API_KEY
      },
      body: JSON.stringify(payload),
    });

    const text = await r.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){ data = { raw:text }; }

    if(!r.ok){
      const msg = data?.error || data?.message || data?.raw || ("HTTP " + r.status);
      throw new Error(`${msg} (HTTP ${r.status})`);
    }
    return data;
  }

  const basePromptEN =
`BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and realistic lighting.
The Coca-Cola can must look ultra-real and naturally part of the scene.
Keep it emotional, human, and authentic. no fake product placement look.
We will inject the user details below.

---`;

  $("basePrompt").textContent = basePromptEN;

  let INPUT_MODE = "text";
  let generating = false;

  // =========================
  // FIX #2. Restore demo strip + show videos correctly
  // =========================
  // Put your real demo MP4 + poster URLs here.
  // If you leave this empty. the demo strip will hide automatically.
  const DEMOS = [
    // Example:
    // { poster: "https://your-cdn/demo1.jpg", video: "https://your-cdn/demo1.mp4", tag: "Demo 1" },
    // { poster: "https://your-cdn/demo2.jpg", video: "https://your-cdn/demo2.mp4", tag: "Demo 2" },
  ];

  let selectedDemoIndex = 0;

  function showPosterOnly(posterUrl){
    const poster = $("mainPoster");
    const vid = $("mainVideo");
    vid.pause();
    vid.removeAttribute("src");
    vid.load();

    vid.style.display = "none";
    poster.style.display = "block";
    poster.src = posterUrl || "";
    $("playBtn").style.display = "inline-flex";
  }

  function showVideo(videoUrl, posterUrl){
    const poster = $("mainPoster");
    const vid = $("mainVideo");

    // Show video
    vid.style.display = "block";
    poster.style.display = "none";

    // Some browsers like having a poster even if we hide the <img>
    vid.poster = posterUrl || "";

    // Force reload
    vid.pause();
    vid.src = videoUrl;
    vid.load();

    $("playBtn").style.display = "inline-flex";
  }

  function setMainToDemo(i){
    const d = DEMOS[i];
    if(!d) return;

    selectedDemoIndex = i;
    $("selectedLabel").textContent = (currentLang==="ar") ? i18n.ar.selectedDemo : i18n.en.selectedDemo;

    // We show demo as poster first. Play button will start it.
    showPosterOnly(d.poster);

    // highlight
    renderDemoStrip();
  }

  function renderDemoStrip(){
    const wrap = $("thumbRowWrap");
    const row = $("thumbRow");
    const dots = $("thumbDots");

    if(!Array.isArray(DEMOS) || DEMOS.length === 0){
      wrap.style.display = "none";
      return;
    }
    wrap.style.display = "block";

    row.innerHTML = "";
    dots.innerHTML = "";

    DEMOS.forEach((d, idx)=>{
      const el = document.createElement("div");
      el.className = "thumb" + (idx === selectedDemoIndex ? " on" : "");
      el.innerHTML = `
        <div class="thumbPlay">‚ñ∂</div>
        <img src="${d.poster || ""}" alt="demo"/>
        <div class="thumbMeta">
          <span>${(currentLang==="ar") ? i18n.ar.demoTag : i18n.en.demoTag}</span>
          <span class="thumbTag">${d.tag || ("#" + (idx+1))}</span>
        </div>
      `;
      el.addEventListener("click", ()=> setMainToDemo(idx));
      row.appendChild(el);

      const dot = document.createElement("div");
      dot.className = "dot" + (idx === selectedDemoIndex ? " on" : "");
      dots.appendChild(dot);
    });
  }

  // Play button behavior:
  // - If main video is hidden and we are on a demo. it loads demo mp4 then plays.
  // - If main video is already set. toggles play/pause.
  $("playBtn").addEventListener("click", async ()=>{
    const vid = $("mainVideo");

    // If no video loaded yet. load selected demo video
    const d = DEMOS[selectedDemoIndex];
    if(vid.style.display === "none" && d && d.video){
      showVideo(d.video, d.poster);
    }

    // Toggle play
    try{
      if(vid.paused) await vid.play();
      else vid.pause();
    }catch(e){
      // If autoplay is blocked. user can press play inside controls
    }
  });

  function buildPrompt(){
    const base = $("basePrompt").textContent || "";
    const subject = ($("subject").value || "").trim();
    const location = ($("location").value || "").trim();
    const twist = ($("twist").value || "").trim();

    const parts = [];
    if(subject) parts.push(`Main subject: ${subject}`);
    if(location) parts.push(`Location: ${location}`);
    if(twist) parts.push(`Creative twist: ${twist}`);

    return `${base}\n${parts.join("\n")}`.trim();
  }

  function setTimerText(secondsLeft){
    if(currentLang === "ar"){
      $("timerText").textContent =
        secondsLeft > 0 ? `ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶ (${toArabicDigits(secondsLeft)} ÿ´)` : i18n.ar.waiting;
    } else {
      $("timerText").textContent =
        secondsLeft > 0 ? `Generating‚Ä¶ (~${secondsLeft}s)` : i18n.en.waiting;
    }
  }

  function setReadyText(){
    $("timerText").textContent = (currentLang==="ar") ? i18n.ar.ready : i18n.en.ready;
  }

  function showLimitReached(){
    $("resultBox").style.display = "block";
    $("bar").style.width = "0%";
    $("timerText").textContent = (currentLang==="ar") ? i18n.ar.limitReached : i18n.en.limitReached;
    $("resultNote").textContent = "";
  }

  function isTrialLimitErrorMessage(msg){
    const m = String(msg||"").toUpperCase();
    return m.includes("TRIAL_LIMIT_REACHED") || m.includes("HTTP 429") || m.includes("(HTTP 429)") || m.trim()==="429";
  }

  async function generate(){
    if(generating) return;

    if(trials <= 0){
      showLimitReached();
      return;
    }

    generating = true;
    $("resultBox").style.display = "block";
    $("bar").style.width = "0%";
    $("resultNote").textContent = "";

    const maxSeconds = 60;
    const start = Date.now();
    let rafId;

    const tick = ()=>{
      const elapsed = (Date.now()-start)/1000;
      const p = Math.min(95, (elapsed/maxSeconds)*95);
      $("bar").style.width = p + "%";
      const remain = Math.max(0, Math.ceil(maxSeconds - elapsed));
      setTimerText(remain);
      rafId = requestAnimationFrame(tick);
    };
    tick();

    try{
      const prompt = buildPrompt();

      let i2v = null;
      if(INPUT_MODE === "images"){
        assertStartFile();

        $("resultNote").textContent = (currentLang === "ar")
          ? "ÿ¨ÿßÿ±Ÿç ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑÿµŸàÿ±‚Ä¶"
          : "Preparing images‚Ä¶";

        const startB64 = await fileToBase64(I2V_START_FILE);
        const endB64 = I2V_END_FILE ? await fileToBase64(I2V_END_FILE) : null;

        i2v = {
          start: {
            name: I2V_START_FILE.name || "start.jpg",
            mime: I2V_START_FILE.type || "image/jpeg",
            b64: startB64
          }
        };

        if(endB64){
          i2v.end = {
            name: I2V_END_FILE.name || "end.jpg",
            mime: I2V_END_FILE.type || "image/jpeg",
            b64: endB64
          };
        }
      }

      const gen = await postJSON({
        action:"generate",
        modelId: MODEL_ID,
        prompt,
        deviceId: getDeviceId(),
        inputMode: INPUT_MODE,
        i2v
      });

      consumeOneTrial();

      const operationName = gen.operationName || gen.name;
      if(gen.done && gen.downloadUrl){
        onGenerated(gen.downloadUrl);
        return;
      }
      if(!operationName) throw new Error("No operationName returned from generate");

      const pollEveryMs = 3000;
      const maxPolls = 25;
      let doneUrl = "";

      for(let i=0;i<maxPolls;i++){
        await new Promise(res=>setTimeout(res, pollEveryMs));

        const chk = await postJSON({
          action:"check",
          modelId: MODEL_ID,
          operationName,
          deviceId: getDeviceId()
        });

        if(chk.done && chk.downloadUrl){ doneUrl = chk.downloadUrl; break; }
      }

      if(!doneUrl) throw new Error("Still processing. Try again in a few seconds.");

      onGenerated(doneUrl);

    }catch(err){
      const msg = (err?.message || "Unknown error");

      if(isTrialLimitErrorMessage(msg)){
        hardLockTrialsToZero();
        showLimitReached();
      }else{
        $("timerText").textContent = "Error: " + msg;
        $("bar").style.width = "0%";
        $("resultNote").textContent =
          (INPUT_MODE==="images")
            ? "If image mode still behaves like text. the backend may still ignore i2v. But now your browser is sending b64 correctly."
            : "";
      }
    }finally{
      generating = false;
      if(rafId) cancelAnimationFrame(rafId);
    }
  }

  function onGenerated(downloadUrl){
    $("bar").style.width = "100%";
    setReadyText();
    saveLastUrl(downloadUrl);

    // SHOW the generated video in the main player (this was missing before)
    showVideo(downloadUrl, DEMOS[selectedDemoIndex]?.poster || "");

    $("resultNote").textContent = (currentLang==="ar")
      ? "‚úÖ ÿßÿ™ŸàŸÑÿØ ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ¬´ÿ™ÿ≠ŸÖŸäŸÑ¬ª ÿ£Ÿà ¬´ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑¬ª."
      : "‚úÖ New video generated. Use Download or Copy link.";
  }

  $("generateBtn").addEventListener("click", generate);

  function getCurrentVideoUrl(){ return loadLastUrl(); }

  $("downloadBtn").addEventListener("click", ()=>{
    const url = getCurrentVideoUrl();
    if(!url) return;
    window.open(url, "_blank", "noopener");
  });

  $("copyBtn").addEventListener("click", async ()=>{
    const url = getCurrentVideoUrl();
    if(!url) return;
    try{
      await navigator.clipboard.writeText(url);
      alert((currentLang==="ar") ? i18n.ar.copied : i18n.en.copied);
    }catch(e){
      prompt((currentLang==="ar") ? "ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÖŸÜ ŸáŸÜÿß:" : "Copy link from here:", url);
    }
  });

  const imagesBox = $("imagesBox");
  $("modeText").addEventListener("click", ()=>{
    INPUT_MODE = "text";
    $("modeText").classList.add("on");
    $("modeImages").classList.remove("on");
    imagesBox.style.display = "none";
  });
  $("modeImages").addEventListener("click", ()=>{
    INPUT_MODE = "images";
    $("modeImages").classList.add("on");
    $("modeText").classList.remove("on");
    imagesBox.style.display = "block";
  });

  function applyLang(lang){
    currentLang = lang;
    const t = i18n[lang];

    $("heroTitle").innerHTML = t.heroTitle;
    const triesNum = (lang === "ar") ? toArabicDigits(String(trials)) : String(trials);
    $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;

    $("baseLabel").textContent = t.baseLabel;
    $("lockedTag").textContent = t.locked;
    $("trialsLabel").textContent = t.trialsLabel;

    $("selectedLabel").textContent = t.selectedDemo;
    $("playTxt").textContent = t.play;

    $("modeLabel").textContent = t.modeLabel;
    $("modeTextTxt").textContent = t.modeText;
    $("modeImgTxt").textContent = t.modeImg;

    $("lblSubject").textContent = t.lblSubject;
    $("lblLocation").textContent = t.lblLocation;
    $("lblTwist").textContent = t.lblTwist;

    $("lblImages").textContent = t.lblImages;
    $("hintImages").textContent = t.hintImages;
    $("startPrevLbl").textContent = t.startPrev;
    $("endPrevLbl").textContent = t.endPrev;

    $("subject").placeholder = t.phSubject;
    $("location").placeholder = t.phLocation;
    $("twist").placeholder = t.phTwist;

    $("genTxt").textContent = t.gen;
    $("dlTxt").textContent = t.dl;
    $("copyTxt").textContent = t.copy;
    $("saveWarn").textContent = t.saveWarn;

    document.body.dir = (lang === "ar") ? "rtl" : "ltr";
    document.documentElement.lang = (lang === "ar") ? "ar" : "en";
    $("langToggle").textContent = (lang === "ar") ? "EN" : "AR";

    $("trialsLeft").textContent = (lang==="ar") ? toArabicDigits(String(trials)) : String(trials);

    // Re-render demo tags in the correct language
    renderDemoStrip();
  }

  $("langToggle").addEventListener("click", () => {
    applyLang(currentLang === "en" ? "ar" : "en");
  });

  function boot(){
    setTrialsLeft(trials);
    applyLang("en");
    initI2VInputs();

    // If you have demos, show them. If not, hide strip safely.
    renderDemoStrip();
    if(Array.isArray(DEMOS) && DEMOS.length > 0){
      setMainToDemo(0);
    }else{
      // No demos. show a neutral poster (empty)
      showPosterOnly("");
    }

    // Restore last generated video on refresh (so it "displays again" like before)
    const last = loadLastUrl();
    if(last){
      showVideo(last, DEMOS[selectedDemoIndex]?.poster || "");
    }
  }

  boot();
</script>
</body>
</html>
