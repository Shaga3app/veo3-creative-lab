<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shaga3app ¬∑ AI Creative Playground</title>

  <style>
    :root{
      --bg:#0b0f18;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.10);
      --accent:#5b5cff;
      --ok:#22c55e;

      /* brand overrides injected by JS */
      --brandAccent: var(--accent);
      --brandOk: var(--ok);
      --brandPillBorder: rgba(91,92,255,.45);
      --brandPillBg: rgba(91,92,255,.18);
      --brandHeroGlowA: rgba(91,92,255,.25);
      --brandHeroGlowB: rgba(34,197,94,.12);

      --radiusCard:18px;
      --radiusField:14px;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 900px at 30% -10%, var(--brandHeroGlowA), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, var(--brandHeroGlowB), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width:860px;margin:0 auto;padding:18px 16px 40px;}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radiusCard);
      padding:14px;
      backdrop-filter:blur(10px);
      box-shadow: var(--shadow);
    }

    /* Top bar (make it darker like locked box, not white) */
    .topBar{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{
      width:34px;height:34px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .logo img{width:22px;height:22px;object-fit:contain;display:block}
    .logo svg{width:22px;height:22px}

    .pill{
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--brandPillBorder);
      background:var(--brandPillBg);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }

    .langBtn{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); color: var(--text);
      background: rgba(255,255,255,.06);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .hero{margin:18px 0}
    .hero h1{font-size:52px;line-height:1.05;margin:6px 0;font-weight:900}
    .hero p{color:var(--muted);font-size:18px;max-width:520px}

    .sectionLabel{
      margin:20px 0 10px;
      font-size:12px;
      letter-spacing:.14em;
      color:var(--muted);
    }

    .lockedBox{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }
    .lockedTop{display:flex;justify-content:space-between;align-items:center}
    .lockedTag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .lockedPrompt{
      margin-top:10px;
      border:2px dashed rgba(255,255,255,.16);
      border-radius:14px;
      padding:16px;
      font-family:ui-monospace,monospace;
      white-space:pre-wrap;
      /* make text a bit dimmed like you asked */
      color: rgba(229,231,235,.82);
    }

    .modeBar{
      display:flex;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      background:rgba(0,0,0,.18);
    }
    .modeBtn{
      flex:1;
      padding:10px;
      border-radius:12px;
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:700;
    }
    .modeBtn.on{
      background:rgba(91,92,255,.22);
      border-color:rgba(91,92,255,.45);
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}

    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:var(--radiusField);
      padding:12px;
    }
    .field label{font-size:13px;margin-bottom:6px;display:block}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
    }
    .field .miniHint{display:none;} /* you already wanted hidden */

    .btn{
      padding:12px 16px;
      border-radius:14px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(180deg,var(--brandOk), #1ea84d);
      color:#07120a;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      text-decoration:none;
    }

    /* ===== Preview Card (iPhone-like) ===== */
    .previewCard{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      padding:12px;
    }
    .previewTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .previewTop .title{
      font-weight:900;
      display:flex;align-items:center;gap:8px;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }

    .mainPreview{
      position:relative;
      width:100%;
      aspect-ratio: 9 / 16;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }

    /* Poster DIV (NOT img) ‚Äì works on iPhone webview */
    .posterDiv{
      width:100%;
      height:100%;
      display:flex;
      align-items:flex-end;
      padding:18px;
      color:#fff;
      font-weight:900;
      background:
        radial-gradient(700px 500px at 30% 10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(700px 500px at 80% 30%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.25), rgba(0,0,0,.82));
    }
    .posterTitle{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .posterTitle .name{
      font-size:18px;
      letter-spacing:.02em;
      opacity:.95;
    }
    .posterTitle .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.35);
      backdrop-filter:blur(8px);
      opacity:.95;
    }

    video#mainVideo{
      width:100%;
      height:100%;
      display:none;
      object-fit:cover;
      background:#000;
    }

    .playOverlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      pointer-events:auto;
      background:linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.45));
    }
    .playBtn{
      width:74px;height:74px;border-radius:50%;
      display:grid;place-items:center;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      font-size:20px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* Carousel thumbs */
    .carousel{
      margin-top:10px;
      display:flex;gap:10px;
      overflow:auto;
      padding-bottom:6px;
      scrollbar-width: thin;
    }
    .thumb{
      width:92px;
      height:92px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .thumb.active{
      outline:2px solid var(--brandOk);
      outline-offset:2px;
    }
    .thumbInner{
      position:absolute; inset:0;
      padding:10px;
      display:flex;align-items:flex-end;
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(120px 90px at 80% 30%, rgba(255,255,255,.08), transparent 65%),
        linear-gradient(135deg, rgba(0,0,0,.20), rgba(0,0,0,.82));
    }
    .thumbRow{
      width:100%;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      color:#fff;
      font-weight:900;
    }
    .thumbRow .lbl{font-size:11px;opacity:.95}
    .thumbRow .pbtn{
      width:24px;height:24px;border-radius:50%;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.20);
      display:grid;place-items:center;font-size:12px;
    }
    .thumbBadge{
      position:absolute;
      top:8px; right:8px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      color:#fff;
    }

    /* pagination dots */
    .dots{
      display:flex;justify-content:center;gap:6px;
      margin-top:8px;
    }
    .dot{
      width:6px;height:6px;border-radius:50%;
      background:rgba(255,255,255,.18);
    }
    .dot.on{ background: var(--brandOk); }

    /* Result / progress */
    .result{
      display:none;
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.18);
    }
    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;width:0%;
      background:linear-gradient(90deg,var(--brandAccent), var(--brandOk));
    }
    .miniHint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
      opacity:.95;
    }

    /* actions row */
    .actionsRow{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;
      justify-content:flex-end;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="topBar">
      <div class="brand">
        <div class="logo">
          <img id="brandImg" alt="Brand logo" style="display:none;">
          <svg id="fallbackSvg" viewBox="0 0 24 24">
            <path d="M12 3c2.5 2.8 4.8 4.2 7.5 4.9-1.3 5.6-4.3 9.6-7.5 13.2C8.8 17.5 5.8 13.5 4.5 7.9 7.2 7.2 9.5 5.8 12 3Z" fill="#5b5cff"/>
            <path d="M9 9c-1.5 2.4-2.2 4.6-2.4 7.2 2.4-1.1 4.2-3 5.1-5.2-.7-.7-1.7-1.4-2.7-2Z" fill="#22c55e"/>
          </svg>
        </div>
        <span id="brandText">Shaga3app ¬∑ AI Creative Playground</span>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="langBtn" id="langToggle" type="button">AR</button>
        <div class="pill" id="betaPill">Beta ¬∑ Shaga3app powered</div>
      </div>
    </div>

    <div class="hero">
      <h1 id="heroTitle">Play with our<br>guided video<br>prompt</h1>
      <p id="heroDesc">You get up to <b id="triesInline">3</b> tries. The core concept is fixed by us; you just add your creative twist ‚ú®</p>
    </div>

    <div class="sectionLabel" id="baseLabel">BASE CONCEPT (LOCKED)</div>
    <div class="lockedBox">
      <div class="lockedTop">
        <div class="lockedTag" id="lockedTag">üîí Locked</div>
        <div class="lockedTag"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">3</b></div>
      </div>

      <div class="lockedPrompt" id="basePrompt"
        data-en="BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
Include an ultra-realistic Coca-Cola can and an Egyptian flag in the scene, naturally integrated so they match the environment and do not feel placed or fake.
The scene follows this base concept, and we will inject the user details below."
        data-ar="ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)

ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© Ÿàÿ∫ŸÜŸäÿ©.
ŸÑÿßÿ≤ŸÖ Ÿäÿ∏Ÿáÿ± ÿπŸÑÿ®ÿ© ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ŸàÿßŸÇÿπŸäÿ© ÿ¨ÿØŸãÿß ŸàÿπŸÑŸÖ ŸÖÿµÿ± ÿ¨ŸàŸëŸá ÿßŸÑŸÖÿ¥ŸáÿØ ‚Äî ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä ŸàŸÖÿ™ŸÜÿßÿ≥ŸÇ ŸÖÿπ ÿßŸÑŸÖŸÉÿßŸÜÿå ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß Ÿäÿ®ÿßŸÜŸàÿß ŸÖÿ™ÿ≠ÿ∑ŸëŸäŸÜ ŸÉÿØŸá ÿ£Ÿà ŸÅŸäŸÉ.
ÿßŸÑŸÖÿ¥ŸáÿØ ŸÖÿßÿ¥Ÿä ÿπŸÑŸâ ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿØŸäÿå Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.">
BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
Include an ultra-realistic Coca-Cola can and an Egyptian flag in the scene, naturally integrated so they match the environment and do not feel placed or fake.
The scene follows this base concept, and we will inject the user details below.
      </div>
    </div>

    <div class="sectionLabel" id="modeLabel">CHOOSE INPUT MODE</div>
    <div class="modeBar">
      <button class="modeBtn on" id="modeText" type="button">üìù <span id="modeTextTxt">Text prompt</span></button>
      <button class="modeBtn" id="modeImages" type="button">üñºÔ∏è <span id="modeImgTxt">Start + End images</span></button>
    </div>

    <div class="field span2" id="imagesBox" style="display:none; margin-top:10px;">
      <label id="lblImages">Start + End images</label>
      <input type="file" id="startImg" accept="image/*">
      <input type="file" id="endImg" accept="image/*" style="margin-top:8px;">
      <div class="miniHint" id="hintImages">Upload a start frame and an end frame to guide the motion.</div>
    </div>

    <div class="grid">
      <div class="field">
        <label id="lblSubject">Main subject / character</label>
        <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
      </div>
      <div class="field">
        <label id="lblLocation">Location / environment</label>
        <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
      </div>

      <div class="field span2" id="extraBox">
        <label id="lblTwist">Extra creative twist</label>
        <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
      </div>
    </div>

    <!-- Preview + carousel (same idea as before, but posters always show) -->
    <div class="previewCard">
      <div class="previewTop">
        <div class="title">üé¨ <span id="previewTitle">Selected demo</span></div>
        <div class="chip" id="metaChip">9:16 ¬∑ 5‚Äì8s</div>
      </div>

      <div class="mainPreview" id="mainPreview">
        <div id="mainPoster" class="posterDiv">
          <div class="posterTitle">
            <div class="name" id="posterName">Shaga3app ¬∑ Demo</div>
            <div class="tag" id="posterTag">9:16 ¬∑ 5‚Äì8s</div>
          </div>
        </div>

        <video id="mainVideo" controls playsinline muted preload="metadata"></video>

        <div class="playOverlay" id="playOverlay">
          <div class="playBtn" id="playBtn">‚ñ∂</div>
        </div>
      </div>

      <div class="carousel" id="carousel"></div>
      <div class="dots" id="dots"></div>

      <!-- Buttons inside same card like you requested -->
      <div class="actionsRow">
        <button class="btn secondary" id="copyBtn" type="button">üîó <span id="copyTxt">Copy link</span></button>
        <button class="btn secondary" id="downloadBtn" type="button">‚¨á <span id="dlTxt">Download</span></button>
        <button class="btn" id="generateBtn" type="button">‚ö° <span id="genBtnTxt">Generate video</span></button>
      </div>

      <div class="miniHint" id="saveWarn" style="margin-top:10px">
        This page does not save your generated video. Please download it or copy the link before leaving.
      </div>
      <div class="miniHint" id="copyNote" style="display:none;margin-top:8px"></div>
    </div>

    <!-- Progress box (kept, but generation will replace main preview immediately when ready) -->
    <div class="result" id="resultBox">
      <div class="miniHint" id="timerText" style="display:block;margin-top:0;margin-bottom:10px;">~10s</div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

  </div>
</div>

<script>
const $ = id => document.getElementById(id);

/* ===========================
   ‚úÖ Your Lambda Function URL
=========================== */
const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
const MODEL_ID = "veo-3.1-generate-001";

/* ===========================
   Brand routing (3 brands)
   Use:
   /index.html?brand=shaga3
   /index.html?brand=cocacola
   /index.html?brand=tui
=========================== */
const BRAND_DEFAULT = "shaga3";
const brandKey = (new URLSearchParams(location.search).get("brand") || BRAND_DEFAULT).toLowerCase();

const BRANDS = {
  shaga3: {
    name_en: "Shaga3app ¬∑ AI Creative Playground",
    name_ar: "ÿ¥ÿ¨Ÿëÿπ 3 ÿ¢ÿ® ¬∑ ŸÖŸÑÿπÿ® ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
    beta_en: "Beta ¬∑ Shaga3app powered",
    beta_ar: "ÿ®Ÿäÿ™ÿß ¬∑ ÿ®ÿØÿπŸÖ Shaga3app",
    accent: "#5b5cff",
    ok: "#22c55e",
    glowA: "rgba(91,92,255,.25)",
    glowB: "rgba(34,197,94,.12)",
    pillBorder: "rgba(91,92,255,.45)",
    pillBg: "rgba(91,92,255,.18)",
    logo: "logoshaga3app.png?v=9",
    base_en: null, // use default in HTML
    base_ar: null
  },
  cocacola: {
    name_en: "Coca-Cola ¬∑ AI Video Lab",
    name_ar: "ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ¬∑ ŸÖÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
    beta_en: "Demo ¬∑ Coca-Cola",
    beta_ar: "ÿØŸäŸÖŸà ¬∑ ŸÉŸàŸÉÿßŸÉŸàŸÑÿß",
    accent: "#e11d48",
    ok: "#22c55e",
    glowA: "rgba(225,29,72,.22)",
    glowB: "rgba(255,255,255,.10)",
    pillBorder: "rgba(225,29,72,.55)",
    pillBg: "rgba(225,29,72,.18)",
    logo: "logoshaga3app.png?v=9", // ŸÑŸà ÿπŸÜÿØŸÉ ŸÑŸàÿ¨Ÿà ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ÿ≠ÿ∑Ÿá ŸáŸÜÿß
    base_en:
`BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
The scene must include an ultra-realistic Coca-Cola can naturally integrated (not placed/fake).
Keep it premium, cinematic, and believable. We will inject user details below.`,
    base_ar:
`ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)

ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© Ÿàÿ∫ŸÜŸäÿ©.
ŸÑÿßÿ≤ŸÖ Ÿäÿ∏Ÿáÿ± ÿπŸÑÿ®ÿ© ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ŸàÿßŸÇÿπŸäÿ© ÿ¨ÿØŸãÿß ŸàŸÖŸÜÿØŸÖÿ¨ÿ© ÿ∑ÿ®ŸäÿπŸä ŸÅŸä ÿßŸÑŸÖŸÉÿßŸÜ (ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß ÿ™ÿ®ÿßŸÜ ŸÖÿ™ÿ≠ÿ∑Ÿëÿ©/ŸÅŸäŸÉ).
ÿÆŸÑŸä ÿßŸÑÿ•ÿ≠ÿ≥ÿßÿ≥ ÿ®ÿ±ŸäŸÖŸäŸàŸÖ Ÿàÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ŸàŸàÿßŸÇÿπŸä. Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.`
  },
  tui: {
    name_en: "TUI ¬∑ AI Video Lab",
    name_ar: "TUI ¬∑ ŸÖÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
    beta_en: "Demo ¬∑ TUI",
    beta_ar: "ÿØŸäŸÖŸà ¬∑ TUI",
    accent: "#38bdf8",
    ok: "#22c55e",
    glowA: "rgba(56,189,248,.20)",
    glowB: "rgba(34,197,94,.10)",
    pillBorder: "rgba(56,189,248,.55)",
    pillBg: "rgba(56,189,248,.18)",
    logo: "logoshaga3app.png?v=9", // ŸÑŸà ÿπŸÜÿØŸÉ ŸÑŸàÿ¨Ÿà TUI ÿ≠ÿ∑Ÿá ŸáŸÜÿß
    base_en:
`BASE (LOCKED)

Create a vertical 9:16 cinematic travel-style video, 5‚Äì8 seconds long, with smooth camera moves and realistic lighting.
The scene should feel like a premium TUI destination moment (relaxed, sunny, aspirational) without showing any copyrighted brand signage.
We will inject user details below.`,
    base_ar:
`ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)

ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ©.
ÿÆŸÑŸä ÿßŸÑŸÖÿ¥ŸáÿØ ÿ•ÿ≠ÿ≥ÿßÿ≥Ÿá ÿ≥ŸÅÿ±/ÿ±ŸäŸÑÿßŸÉÿ≥ ÿ®ÿ±ŸäŸÖŸäŸàŸÖ ŸÉÿ£ŸÜŸá ŸÑÿ≠ÿ∏ÿ© ŸÖŸÜ Ÿàÿ¨Ÿáÿ© TUI (ÿ¥ŸÖÿ≥/ŸáÿØŸàÿ°/ŸÅÿßÿÆÿ±) ŸÖŸÜ ÿ∫Ÿäÿ± ŸÑÿßŸÅÿ™ÿßÿ™ ÿ£Ÿà ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ŸÇŸàŸÇŸáÿß ŸÖÿ≠ŸÅŸàÿ∏ÿ©.
Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.`
  }
};

const BRAND = BRANDS[brandKey] || BRANDS[BRAND_DEFAULT];

/* inject brand colors */
document.documentElement.style.setProperty("--brandAccent", BRAND.accent);
document.documentElement.style.setProperty("--brandOk", BRAND.ok);
document.documentElement.style.setProperty("--brandHeroGlowA", BRAND.glowA);
document.documentElement.style.setProperty("--brandHeroGlowB", BRAND.glowB);
document.documentElement.style.setProperty("--brandPillBorder", BRAND.pillBorder);
document.documentElement.style.setProperty("--brandPillBg", BRAND.pillBg);

/* logo */
const brandImg = $("brandImg");
const fallbackSvg = $("fallbackSvg");
brandImg.src = BRAND.logo;
brandImg.onload = () => { brandImg.style.display="block"; if(fallbackSvg) fallbackSvg.style.display="none"; };
brandImg.onerror = () => { if(fallbackSvg) fallbackSvg.style.display="block"; };

/* ===========================
   i18n (keep Arabic like before)
=========================== */
const i18n = {
  en: {
    heroTitle: "Play with our<br>guided video<br>prompt",
    heroDescStart: "You get up to ",
    heroDescEnd: " tries. The core concept is fixed by us; you just add your creative twist ‚ú®",
    baseLabel: "BASE CONCEPT (LOCKED)",
    locked: "üîí Locked",
    trialsLabel: "Trials left:",
    modeLabel: "CHOOSE INPUT MODE",
    modeText: "Text prompt",
    modeImg: "Start + End images",
    lblSubject: "Main subject / character",
    lblLocation: "Location / environment",
    lblTwist: "Extra creative twist",
    lblImages: "Start + End images",
    phSubject: "Who is the main character? (age, style, wardrobe, vibe)",
    phLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
    phTwist: "Optional: camera move, mood, style, or one special detail.",
    gen: "Generate video",
    dl: "Download",
    copy: "Copy link",
    saveWarn: "This page does not save your generated video. Please download it or copy the link before leaving.",
    copied: "Link copied ‚úÖ",
    waiting: "Waiting for video‚Ä¶",
    done: "Done"
  },
  ar: {
    heroTitle: "ÿ¨ÿ±Ÿëÿ® ŸÖÿπÿßŸÜÿß<br>ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÅŸäÿØŸäŸà<br>ŸÖŸèŸàÿ¨ŸëŸéŸá",
    heroDescStart: "ŸÑÿØŸäŸÉ ",
    heroDescEnd: " ŸÖÿ≠ÿßŸàŸÑÿßÿ™. ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ´ÿßÿ®ÿ™ÿ©ÿõ ÿ£ŸÜÿ™ ŸÅŸÇÿ∑ ÿ£ÿ∂ŸêŸÅ ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸäÿ© ‚ú®",
    baseLabel: "ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä (ŸÖŸÇŸÅŸàŸÑ)",
    locked: "üîí ŸÖŸÇŸÅŸàŸÑ",
    trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
    modeLabel: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
    modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
    modeImg: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
    lblSubject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
    lblLocation: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
    lblTwist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ©",
    lblImages: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
    phSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
    phLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
    phTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
    gen: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
    dl: "ÿ™ÿ≠ŸÖŸäŸÑ",
    copy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
    saveWarn: "ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿß ÿ™ÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑŸÅŸäÿØŸäŸà ÿßŸÑŸÜÿßÿ™ÿ¨. ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ŸÖŸëŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿ£Ÿà ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨.",
    copied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ",
    waiting: "ÿ®ŸÜÿ≥ÿ™ŸÜŸâ ÿßŸÑŸÅŸäÿØŸäŸà‚Ä¶",
    done: "ÿ™ŸÖ"
  }
};

function toArabicDigits(str){
  const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
  return String(str).replace(/[0-9]/g, d => map[d]);
}

let currentLang = "en";
let trials = 3;
let generating = false;

const LAST_URL_KEY = "shaga3app_last_video_url_" + brandKey;

function saveLastUrl(url){ try{ localStorage.setItem(LAST_URL_KEY, url); }catch(e){} }
function loadLastUrl(){ try{ return localStorage.getItem(LAST_URL_KEY) || ""; }catch(e){ return ""; } }

/* Apply brand text + base prompt per language */
function applyLang(lang){
  currentLang = lang;
  const t = i18n[lang];

  $("brandText").textContent = (lang==="ar") ? BRAND.name_ar : BRAND.name_en;
  $("betaPill").textContent  = (lang==="ar") ? BRAND.beta_ar : BRAND.beta_en;

  $("heroTitle").innerHTML = t.heroTitle;
  const triesNum = (lang==="ar") ? toArabicDigits("3") : "3";
  $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;

  $("baseLabel").textContent = t.baseLabel;
  $("lockedTag").textContent = t.locked;
  $("trialsLabel").textContent = t.trialsLabel;

  $("modeLabel").textContent = t.modeLabel;
  $("modeTextTxt").textContent = t.modeText;
  $("modeImgTxt").textContent = t.modeImg;

  $("lblSubject").textContent = t.lblSubject;
  $("lblLocation").textContent = t.lblLocation;
  $("lblTwist").textContent = t.lblTwist;
  $("lblImages").textContent = t.lblImages;

  $("subject").placeholder = t.phSubject;
  $("location").placeholder = t.phLocation;
  $("twist").placeholder = t.phTwist;

  $("genBtnTxt").textContent = t.gen;
  $("dlTxt").textContent = t.dl;
  $("copyTxt").textContent = t.copy;

  $("saveWarn").textContent = t.saveWarn;

  // base prompt language + brand override
  const bp = $("basePrompt");
  const defaultEn = bp.getAttribute("data-en") || bp.textContent;
  const defaultAr = bp.getAttribute("data-ar") || bp.textContent;

  const enText = BRAND.base_en || defaultEn;
  const arText = BRAND.base_ar || defaultAr;

  bp.textContent = (lang==="ar") ? arText : enText;

  document.body.dir = (lang==="ar") ? "rtl" : "ltr";
  document.documentElement.lang = (lang==="ar") ? "ar" : "en";
  $("langToggle").textContent = (lang==="ar") ? "EN" : "AR";

  // re-render carousel labels (Demo/New)
  renderCarousel();
}

$("langToggle").addEventListener("click", () => applyLang(currentLang==="en" ? "ar" : "en"));

/* Mode switching */
const imagesBox = $("imagesBox");
$("modeText").addEventListener("click", () => {
  $("modeText").classList.add("on");
  $("modeImages").classList.remove("on");
  imagesBox.style.display = "none";
});
$("modeImages").addEventListener("click", () => {
  $("modeImages").classList.add("on");
  $("modeText").classList.remove("on");
  imagesBox.style.display = "block";
});

/* ===========================
   Carousel (posters ALWAYS show, no external site)
=========================== */
const mainVideo = $("mainVideo");
const mainPoster = $("mainPoster");
const playOverlay = $("playOverlay");
const metaChip = $("metaChip");
const posterName = $("posterName");
const posterTag = $("posterTag");

const DEMO_VIDEOS = [
  "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",
  "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/bee.mp4",
  "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/river.mp4"
];

// 8 thumbs (repeats videos if only 3 links)
let carouselItems = Array.from({length: 8}).map((_, idx) => ({
  id: "demo-" + idx,
  label: "Demo",
  tag: "9:16 ¬∑ 5‚Äì8s",
  videoUrl: DEMO_VIDEOS[idx % DEMO_VIDEOS.length]
}));

// if we generated a last video, keep it as item 0 "New"
function hydrateGeneratedIntoCarousel(){
  const last = loadLastUrl();
  if(last){
    // prevent duplicates
    carouselItems = carouselItems.filter(x => x.id !== "gen-last");
    carouselItems.unshift({
      id: "gen-last",
      label: "New",
      tag: "9:16 ¬∑ 5‚Äì8s",
      videoUrl: last
    });
  }
}

let selectedId = carouselItems[0].id;

function posterHTML(name, tag){
  return `
    <div class="posterTitle">
      <div class="name">${name}</div>
      <div class="tag">${tag}</div>
    </div>
  `;
}

function showPosterForSelection(item){
  const brandLabel = (brandKey==="cocacola") ? "Coca-Cola" : (brandKey==="tui" ? "TUI" : "Shaga3app");
  const labelTxt = (currentLang==="ar")
    ? (item.label==="New" ? "ÿ¨ÿØŸäÿØ" : "ÿØŸäŸÖŸà")
    : item.label;

  posterName.textContent = `${brandLabel} ¬∑ ${labelTxt}`;
  posterTag.textContent = item.tag || "9:16 ¬∑ 5‚Äì8s";

  // keep poster visible
  mainPoster.style.display = "flex";
  mainVideo.style.display = "none";

  playOverlay.style.display = "grid";
  metaChip.textContent = item.tag || "9:16 ¬∑ 5‚Äì8s";
}

function playSelectedVideo(item){
  // show video, hide poster
  mainPoster.style.display = "none";
  mainVideo.style.display = "block";
  playOverlay.style.display = "none";
  metaChip.textContent = item.tag || "9:16 ¬∑ 5‚Äì8s";

  // Force reload (fix iPhone ‚Äúonly 1 plays‚Äù)
  try{
    mainVideo.pause();
    mainVideo.currentTime = 0;
  }catch(e){}

  mainVideo.muted = true; // iOS-safe
  mainVideo.src = item.videoUrl;
  mainVideo.load();

  const tryPlay = () => {
    mainVideo.play().catch(()=>{});
    mainVideo.removeEventListener("loadeddata", tryPlay);
  };
  mainVideo.addEventListener("loadeddata", tryPlay);
}

$("playBtn").addEventListener("click", () => {
  const it = carouselItems.find(x => x.id === selectedId) || carouselItems[0];
  playSelectedVideo(it);
});

function renderDots(activeIndex){
  const dots = $("dots");
  dots.innerHTML = "";
  const total = Math.min(8, carouselItems.length);
  for(let i=0;i<total;i++){
    const d = document.createElement("div");
    d.className = "dot" + (i===activeIndex ? " on" : "");
    dots.appendChild(d);
  }
}

function renderCarousel(){
  const c = $("carousel");
  c.innerHTML = "";

  const labelDemo = (currentLang==="ar") ? "ÿØŸäŸÖŸà" : "Demo";
  const labelNew  = (currentLang==="ar") ? "ÿ¨ÿØŸäÿØ" : "New";

  carouselItems.forEach((it, idx) => {
    const el = document.createElement("div");
    el.className = "thumb" + (it.id === selectedId ? " active" : "");
    el.setAttribute("role", "button");
    el.setAttribute("tabindex", "0");

    const badge = (it.label==="New") ? labelNew : labelDemo;

    el.innerHTML = `
      <div class="thumbInner">
        <div class="thumbRow">
          <span class="lbl">${badge}</span>
          <span class="pbtn">‚ñ∂</span>
        </div>
      </div>
      <div class="thumbBadge">${badge}</div>
    `;

    el.addEventListener("click", () => {
      selectedId = it.id;
      renderCarousel();
      showPosterForSelection(it); // poster first (fast), user presses play
      renderDots(idx);
    });

    c.appendChild(el);
  });

  const activeIndex = Math.max(0, carouselItems.findIndex(x => x.id === selectedId));
  renderDots(activeIndex);
}

/* ===========================
   Build prompt
=========================== */
function buildPrompt(){
  const base = $("basePrompt").textContent || "";
  const subject = ($("subject").value || "").trim();
  const location = ($("location").value || "").trim();
  const twist = ($("twist").value || "").trim();

  const parts = [];
  if(subject) parts.push(`Main subject: ${subject}`);
  if(location) parts.push(`Location: ${location}`);
  if(twist) parts.push(`Creative twist: ${twist}`);

  return `${base}\n\n---\n${parts.join("\n")}`.trim();
}

async function postJSON(payload){
  const url = API_URL + "?t=" + Date.now();
  const r = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });

  const text = await r.text();
  let data;
  try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }

  if(!r.ok){
    const msg = data?.error || data?.message || data?.raw || ("HTTP " + r.status);
    throw new Error(msg);
  }
  return data;
}

/* Progress UI */
function showProgressUI(){
  $("resultBox").style.display = "block";
  $("bar").style.width = "0%";
  $("copyNote").style.display = "none";
}
function setTimerText(secondsLeft){
  if(currentLang === "ar"){
    $("timerText").textContent = secondsLeft > 0 ? toArabicDigits(`${secondsLeft} ÿ´`) : i18n.ar.waiting;
  } else {
    $("timerText").textContent = secondsLeft > 0 ? `~${secondsLeft}s` : i18n.en.waiting;
  }
}
function setDoneText(){
  $("timerText").textContent = (currentLang === "ar") ? i18n.ar.done : i18n.en.done;
}

/* ===========================
   ‚úÖ Generate (AND replace main preview immediately when ready)
=========================== */
async function realGenerate(){
  if(generating || trials <= 0) return;
  generating = true;

  trials--;
  $("trialsLeft").textContent = trials;

  showProgressUI();

  const maxSeconds = 60;
  const start = Date.now();
  let rafId;

  const tick = () => {
    const elapsed = (Date.now() - start) / 1000;
    const p = Math.min(95, (elapsed / maxSeconds) * 95);
    $("bar").style.width = p + "%";

    const remain = Math.max(0, Math.ceil(maxSeconds - elapsed));
    setTimerText(remain);

    rafId = requestAnimationFrame(tick);
  };
  tick();

  try{
    const prompt = buildPrompt();

    const gen = await postJSON({
      action: "generate",
      modelId: MODEL_ID,
      prompt
    });

    const operationName = gen.operationName || gen.name;

    // fast path
    if(gen.done && gen.downloadUrl){
      $("bar").style.width = "100%";
      setDoneText();

      // ‚úÖ replace main preview immediately
      saveLastUrl(gen.downloadUrl);
      hydrateGeneratedIntoCarousel();
      selectedId = "gen-last";
      renderCarousel();
      showPosterForSelection(carouselItems[0]); // show poster fast
      playSelectedVideo(carouselItems[0]);      // then play

      generating = false;
      cancelAnimationFrame(rafId);
      return;
    }

    if(!operationName){
      throw new Error("No operationName returned from generate");
    }

    // poll
    const pollEveryMs = 3000;
    const maxPolls = 25;
    let doneUrl = "";

    for(let i=0;i<maxPolls;i++){
      await new Promise(res => setTimeout(res, pollEveryMs));
      const chk = await postJSON({
        action: "check",
        modelId: MODEL_ID,
        operationName
      });

      const url = chk?.downloadUrl || chk?.response?.downloadUrl || "";
      if(chk.done && url){
        doneUrl = url;
        break;
      }
    }

    if(!doneUrl){
      throw new Error("Still processing. Try again in a few seconds.");
    }

    $("bar").style.width = "100%";
    setDoneText();

    // ‚úÖ replace main preview immediately
    saveLastUrl(doneUrl);
    hydrateGeneratedIntoCarousel();
    selectedId = "gen-last";
    renderCarousel();
    showPosterForSelection(carouselItems[0]); // show poster fast
    playSelectedVideo(carouselItems[0]);      // then play

  }catch(err){
    $("timerText").textContent = "Error: " + (err?.message || "Unknown error");
    $("bar").style.width = "0%";
  }finally{
    generating = false;
    if(rafId) cancelAnimationFrame(rafId);
  }
}

// ‚úÖ ensure button works
$("generateBtn").addEventListener("click", realGenerate);

/* ===========================
   Copy / Download
=========================== */
function getCurrentVideoUrl(){
  // mainVideo may be playing or not
  if(mainVideo && mainVideo.src) return mainVideo.src;
  return loadLastUrl();
}
function downloadFile(url){
  if(!url) return;
  const a = document.createElement("a");
  a.href = url;
  a.download = "ai-video.mp4";
  a.target = "_blank";
  a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

$("downloadBtn").addEventListener("click", () => {
  const url = getCurrentVideoUrl();
  if(!url) return;
  saveLastUrl(url);
  downloadFile(url);
});

$("copyBtn").addEventListener("click", async () => {
  const url = getCurrentVideoUrl();
  if(!url) return;
  saveLastUrl(url);

  try{
    await navigator.clipboard.writeText(url);
    $("copyNote").style.display = "block";
    $("copyNote").textContent = (currentLang === "ar") ? i18n.ar.copied : i18n.en.copied;
  }catch(e){
    const msg = (currentLang === "ar") ? "ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÖŸÜ ŸáŸÜÿß:" : "Copy the link from here:";
    const manual = prompt(msg, url);
    if(manual !== null){
      $("copyNote").style.display = "block";
      $("copyNote").textContent = (currentLang === "ar") ? i18n.ar.copied : i18n.en.copied;
    }
  }
});

/* ===========================
   Init
=========================== */
(function init(){
  hydrateGeneratedIntoCarousel();              // bring last generated (if exists)
  selectedId = carouselItems[0].id;            // select first
  renderCarousel();                            // draw thumbs + dots
  showPosterForSelection(carouselItems[0]);    // show poster (fast)

  applyLang("en"); // keep like before
})();
</script>
</body>
</html>
