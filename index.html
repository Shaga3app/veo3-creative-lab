<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shaga3app ¬∑ AI Video Lab</title>

  <style>
    :root{
      --bg:#0b0f18;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.10);
      --accent:#5b5cff;
      --ok:#22c55e;

      --cardBg: linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      --glass: rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 900px at 30% -10%, rgba(91,92,255,.25), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(34,197,94,.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    /* Container */
    .wrap{max-width:860px;margin:0 auto;padding:16px 14px 120px;}
    .card{
      background:var(--cardBg);
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      backdrop-filter:blur(10px);
    }

    /* ===== App-like header (matches your reference) ===== */
    .topBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.24);
      backdrop-filter: blur(12px);
    }
    .leftHead{
      display:flex;align-items:center;gap:10px;
      min-width:0;
      flex:1;
    }
    .backBtn{
      width:36px;height:36px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      display:grid;place-items:center;
      -webkit-tap-highlight-color: transparent;
      flex:0 0 auto;
    }
    .headerTitle{
      font-weight:950;
      font-size:13px;
      opacity:.98;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:1;
      text-align:center;
    }
    .rightHead{
      display:flex;align-items:center;gap:8px;
      flex:0 0 auto;
    }

    /* Logo in header (optional small) */
    .brandLogo{
      width:26px;height:26px;border-radius:9px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brandLogo img{width:100%;height:100%;object-fit:contain;display:block}

    /* Language segmented pill like the mock */
    .segToggle{
      display:inline-flex;
      align-items:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
    }
    .segBtn{
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:950;
      font-size:12px;
      padding:7px 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .segBtn.on{
      background:rgba(255,255,255,.10);
      color:var(--text);
    }

    /* Beta pill (fix overflow) */
    .pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(91,92,255,.45);
      background:rgba(91,92,255,.18);
      font-size:12px;
      font-weight:950;
      max-width:210px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    @media(max-width:420px){
      .pill{display:none;} /* on tiny phones hide it to avoid frame issues */
      .headerTitle{text-align:left;} /* gives more room */
    }

    /* Hero */
    .hero{margin:16px 0 10px}
    .hero h1{font-size:46px;line-height:1.05;margin:6px 0;font-weight:950}
    .hero p{color:var(--muted);font-size:16px;max-width:560px;margin:10px 0 0}

    /* Labels + boxes */
    .sectionLabel{
      margin:18px 0 10px;
      font-size:12px;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .lockedBox{
      background:var(--glass);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }
    .lockedTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .lockedTag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:900;
    }
    .lockedPrompt{
      margin-top:10px;
      border:2px dashed rgba(255,255,255,.16);
      border-radius:14px;
      padding:14px;
      font-family:ui-monospace,monospace;
      white-space:pre-wrap;
      font-size:12px;
      opacity:.95;
    }

    /* Mode bar */
    .modeBar{
      display:flex;gap:10px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:8px;
      background:rgba(0,0,0,.18);
    }
    .modeBtn{
      flex:1;
      padding:10px;
      border-radius:14px;
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:950;
      -webkit-tap-highlight-color: transparent;
    }
    .modeBtn.on{
      background:rgba(91,92,255,.22);
      border-color:rgba(91,92,255,.45);
      color:var(--text);
    }

    /* Inputs */
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}
    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .field label{font-size:13px;margin-bottom:6px;display:block;font-weight:900}
    .field input{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .field input:focus{
      border-color:rgba(91,92,255,.55);
      box-shadow:0 0 0 3px rgba(91,92,255,.12);
    }

    /* Result box */
    .result{
      display:none;
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:rgba(0,0,0,.18);
    }
    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;width:0%;
      background:linear-gradient(90deg,#5b5cff,#22c55e);
    }

    /* ===== Carousel (poster thumbnails, no MP4 loading) ===== */
    .carouselWrap{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      overflow:hidden;
    }
    .carouselHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 8px;
    }
    .carouselTitle{
      font-weight:950;
      font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .carouselHint{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .carousel{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:10px 12px 12px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .carousel::-webkit-scrollbar{height:8px}
    .carousel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.10);border-radius:99px}

    .item{
      flex:0 0 82%;
      scroll-snap-align:center;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    @media(min-width:720px){
      .item{flex-basis:55%}
    }
    .thumb{
      width:100%;
      aspect-ratio: 9 / 16;
      background:
        radial-gradient(400px 220px at 50% 20%, rgba(91,92,255,.22), transparent 60%),
        radial-gradient(300px 180px at 30% 70%, rgba(34,197,94,.12), transparent 60%),
        rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }
    .thumb .poster{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05) contrast(1.02);
    }
    .badges{
      position:absolute;
      top:10px; right:10px;
      display:flex;
      gap:8px;
      z-index:3;
    }
    .badge{
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .playBadge{
      position:absolute;
      left:12px;
      bottom:12px;
      z-index:3;
      width:38px;height:38px;
      border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      font-weight:950;
    }
    .selectedRing{
      position:absolute; inset:0;
      border:2px solid rgba(34,197,94,.75);
      border-radius:16px;
      pointer-events:none;
      opacity:0;
      z-index:4;
    }
    .item.selected .selectedRing{opacity:1}

    .itemFooter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      background:rgba(0,0,0,.18);
      border-top:1px solid rgba(255,255,255,.08);
    }
    .itemMeta{
      font-size:12px;
      color:var(--muted);
      font-weight:850;
      display:flex;gap:10px;flex-wrap:wrap;
      min-width:0;
    }
    .actions{
      display:flex;gap:10px;
      font-weight:950;
      flex:0 0 auto;
    }
    .iconBtn{
      border:none;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      -webkit-tap-highlight-color: transparent;
    }

    /* Selected player (single video element) */
    video#video{
      width:100%;
      margin-top:10px;
      border-radius:16px;
      border:1px solid var(--line);
      display:none;
      background:#000;
    }

    /* Sticky bottom action bar */
    .stickyBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      background:rgba(6,10,18,.65);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:center;
      z-index:50;
    }
    .stickyInner{
      width:min(860px, 100%);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .stickyNote{
      color:var(--muted);
      font-size:12px;
      font-weight:850;
      display:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:55%;
    }
    @media(min-width:720px){
      .stickyNote{display:block}
    }

    .btn{
      padding:12px 16px;
      border-radius:16px;
      border:none;
      font-weight:950;
      cursor:pointer;
      background:linear-gradient(180deg,#22c55e,#1ea84d);
      color:#07120a;
      box-shadow:0 10px 30px rgba(34,197,94,.15);
      -webkit-tap-highlight-color: transparent;
      flex:0 0 auto;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      text-decoration:none;
      box-shadow:none;
    }

    .miniHint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
      opacity:.95;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <!-- ===== Header ===== -->
    <div class="topBar">
      <div class="leftHead">
        <button class="backBtn" id="appBack" type="button" title="Back">‚Üê</button>

        <!-- optional small logo (uses your existing file) -->
        <span class="brandLogo" aria-hidden="true">
          <img id="brandImg" alt="Shaga3app" style="display:none;">
        </span>

        <div class="headerTitle" id="headerTitle">Shaga3app ‚Äì AI Video Lab</div>
      </div>

      <div class="rightHead">
        <div class="segToggle" role="tablist" aria-label="Language">
          <button class="segBtn on" id="segAR" type="button">AR</button>
          <button class="segBtn" id="segEN" type="button">EN</button>
        </div>
        <div class="pill" id="betaPill">Beta ¬∑ Shaga3app powered</div>
      </div>
    </div>

    <!-- ===== Hero ===== -->
    <div class="hero">
      <h1 id="heroTitle">Play with our<br>guided video<br>prompt</h1>
      <p id="heroDesc">You get up to <b id="triesInline">3</b> tries. The core concept is fixed by us; you just add your creative twist ‚ú®</p>
    </div>

    <!-- ===== Base prompt ===== -->
    <div class="sectionLabel" id="baseLabel">BASE CONCEPT (LOCKED)</div>
    <div class="lockedBox">
      <div class="lockedTop">
        <div class="lockedTag" id="lockedTag">üîí Locked</div>
        <div class="lockedTag"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">3</b></div>
      </div>

      <div
        class="lockedPrompt"
        id="basePrompt"
        data-en="YOUR_BASE_PROMPT_GOES_HERE

BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
Include an ultra-realistic Coca-Cola can and an Egyptian flag in the scene, naturally integrated so they match the environment and do not feel placed or fake.
The scene follows this base concept, and we will inject the user details below."
        data-ar="ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)

ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© Ÿàÿ∫ŸÜŸäÿ©.
ŸÑÿßÿ≤ŸÖ Ÿäÿ∏Ÿáÿ± ÿπŸÑÿ®ÿ© ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ŸàÿßŸÇÿπŸäÿ© ÿ¨ÿØŸãÿß ŸàÿπŸÑŸÖ ŸÖÿµÿ± ÿ¨ŸàŸëŸá ÿßŸÑŸÖÿ¥ŸáÿØ ‚Äî ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä ŸàŸÖÿ™ŸÜÿßÿ≥ŸÇ ŸÖÿπ ÿßŸÑŸÖŸÉÿßŸÜÿå ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß Ÿäÿ®ÿßŸÜŸàÿß ŸÖÿ™ÿ≠ÿ∑ŸëŸäŸÜ ŸÉÿØŸá ÿ£Ÿà ŸÅŸäŸÉ.
ÿßŸÑŸÖÿ¥ŸáÿØ ŸÖÿßÿ¥Ÿä ÿπŸÑŸâ ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿØŸäÿå Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™."
      >YOUR_BASE_PROMPT_GOES_HERE


BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
Include an ultra-realistic Coca-Cola can and an Egyptian flag in the scene, naturally integrated so they match the environment and do not feel placed or fake.
The scene follows this base concept, and we will inject the user details below.</div>
    </div>

    <!-- ===== Mode ===== -->
    <div class="sectionLabel" id="modeLabel">CHOOSE INPUT MODE</div>
    <div class="modeBar">
      <button class="modeBtn on" id="modeText">üìù <span id="modeTextTxt">Text prompt</span></button>
      <button class="modeBtn" id="modeImages">üñºÔ∏è <span id="modeImgTxt">Start + End images</span></button>
    </div>

    <div class="field span2" id="imagesBox" style="display:none; margin-top:10px;">
      <label id="lblImages">Start + End images</label>
      <input type="file" id="startImg" accept="image/*">
      <input type="file" id="endImg" accept="image/*" style="margin-top:8px;">
      <div class="miniHint" id="hintImages">Upload a start frame and an end frame to guide the motion.</div>
    </div>

    <!-- ===== Inputs ===== -->
    <div class="grid">
      <div class="field">
        <label id="lblSubject">Main subject / character</label>
        <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
        <div class="miniHint" id="hintSubject" style="display:none;">Who is the main character? (age, style, wardrobe, vibe)</div>
      </div>

      <div class="field">
        <label id="lblLocation">Location / environment</label>
        <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
        <div class="miniHint" id="hintLocation" style="display:none;">Where is it happening? (city, time of day, lighting, atmosphere)</div>
      </div>

      <div class="field span2" id="extraBox">
        <label id="lblTwist">Extra creative twist</label>
        <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
        <div class="miniHint" id="hintTwist" style="display:none;">Optional: camera move, mood, style, or one special detail.</div>
      </div>
    </div>

    <!-- ===== Carousel + Selected Player ===== -->
    <div class="carouselWrap" id="carouselWrap">
      <div class="carouselHead">
        <div class="carouselTitle">üéûÔ∏è <span id="carouselTitleTxt">Generated videos</span></div>
        <div class="carouselHint" id="carouselHintTxt">Swipe to preview ‚Ä¢ Tap to select</div>
      </div>

      <div class="carousel" id="carousel"></div>

      <div style="padding:0 12px 12px;">
        <video id="video" controls playsinline></video>
      </div>
    </div>

    <!-- ===== Progress / Actions (kept) ===== -->
    <div class="result" id="resultBox">
      <div class="miniHint" id="timerText" style="display:block;margin-top:0;margin-bottom:10px;">~10s</div>
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn secondary" id="downloadBtn" type="button">‚¨á <span id="dlTxt">Download video</span></button>
        <button class="btn secondary" id="copyBtn" type="button">üîó <span id="copyTxt">Copy link</span></button>
        <button class="btn secondary" id="backBtn" type="button">‚Ü© <span id="backTxt">Back</span></button>
      </div>

      <div class="miniHint" id="saveWarn" style="display:block;margin-top:10px">
        This page does not save your generated video. Please download it or copy the link before leaving.
      </div>

      <div class="miniHint" id="copyNote" style="display:none;margin-top:8px"></div>
    </div>

  </div>
</div>

<!-- Sticky bottom CTA -->
<div class="stickyBar">
  <div class="stickyInner">
    <div class="stickyNote" id="stickyNoteTxt">Tip: generate early to lock best options ‚ú®</div>
    <button class="btn" id="generateBtn">‚ñ∂ <span id="genBtnTxt">Generate video</span></button>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

/* ===========================
   ‚úÖ Your Lambda Function URL
=========================== */
const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
const MODEL_ID = "veo-3.1-generate-001";

let trials = 3;
let generating = false;

// ‚úÖ keep last URL so it can be restored
const LAST_URL_KEY = "shaga3app_last_video_url";

/* ===========================
   Carousel state (demo + real)
=========================== */
const carouselState = {
  items: [],
  selectedId: null
};

/* ===========================
   ‚úÖ DEMO ITEMS (poster thumbnails + video URLs)
   Replace posterUrl + videoUrl with your own assets later.
=========================== */
const DEMO_VIDEOS = [
  {
    id: "demo-1",
    label: "Demo A",
    seconds: "5‚Äì8s",
    ratio: "9:16",
    posterUrl: "https://picsum.photos/600/1067?random=11",
    videoUrl: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
  },
  {
    id: "demo-2",
    label: "Demo B",
    seconds: "5‚Äì8s",
    ratio: "9:16",
    posterUrl: "https://picsum.photos/600/1067?random=22",
    videoUrl: "https://media.w3.org/2010/05/sintel/trailer.mp4"
  }
];

/* ===========================
   Arabic Toggle + RTL + Arabic Digits
=========================== */
const i18n = {
  en: {
    headerTitle: "Shaga3app ‚Äì AI Video Lab",
    beta: "Beta ¬∑ Shaga3app powered",
    heroTitle: "Play with our<br>guided video<br>prompt",
    heroDescStart: "You get up to ",
    heroDescEnd: " tries. The core concept is fixed by us; you just add your creative twist ‚ú®",
    baseLabel: "BASE CONCEPT (LOCKED)",
    locked: "üîí Locked",
    trialsLabel: "Trials left:",
    modeLabel: "CHOOSE INPUT MODE",
    modeText: "Text prompt",
    modeImg: "Start + End images",
    lblSubject: "Main subject / character",
    lblLocation: "Location / environment",
    lblTwist: "Extra creative twist",
    lblImages: "Start + End images",
    hintSubject: "Who is the main character? (age, style, wardrobe, vibe)",
    hintLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
    hintTwist: "Optional: camera move, mood, style, or one special detail.",
    hintImages: "Upload a start frame and an end frame to guide the motion.",
    phSubject: "Who is the main character? (age, style, wardrobe, vibe)",
    phLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
    phTwist: "Optional: camera move, mood, style, or one special detail.",
    gen: "Generate video",
    dl: "Download video",
    copy: "Copy link",
    back: "Back",
    done: "Done",
    waiting: "Waiting for video‚Ä¶",
    saveWarn: "This page does not save your generated video. Please download it or copy the link before leaving.",
    copied: "Link copied ‚úÖ",
    carouselTitle: "Generated videos",
    carouselHint: "Swipe to preview ‚Ä¢ Tap to select",
    stickyNote: "Tip: generate early to lock best options ‚ú®"
  },
  ar: {
    headerTitle: "ÿ¥ÿ¨Ÿëÿπ 3 ÿ¢ÿ® ‚Äì ŸÖÿπŸÖŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
    beta: "ÿ®Ÿäÿ™ÿß ¬∑ ÿ®ÿØÿπŸÖ Shaga3app",
    heroTitle: "ÿ¨ÿ±Ÿëÿ® ŸÖÿπÿßŸÜÿß<br>ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÅŸäÿØŸäŸà<br>ŸÖŸèŸàÿ¨ŸëŸéŸá",
    heroDescStart: "ŸÑÿØŸäŸÉ ",
    heroDescEnd: " ŸÖÿ≠ÿßŸàŸÑÿßÿ™. ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ´ÿßÿ®ÿ™ÿ©ÿõ ÿ£ŸÜÿ™ ŸÅŸÇÿ∑ ÿ£ÿ∂ŸêŸÅ ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸäÿ© ‚ú®",
    baseLabel: "ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä (ŸÖŸÇŸÅŸàŸÑ)",
    locked: "üîí ŸÖŸÇŸÅŸàŸÑ",
    trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
    modeLabel: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
    modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
    modeImg: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
    lblSubject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
    lblLocation: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
    lblTwist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ©",
    lblImages: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
    hintSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
    hintLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
    hintTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
    hintImages: "ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ŸÑÿ™Ÿàÿ¨ŸäŸá ÿßŸÑÿ≠ÿ±ŸÉÿ©.",
    phSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
    phLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
    phTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
    gen: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
    dl: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà",
    copy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
    back: "ÿ±ÿ¨Ÿàÿπ",
    done: "ÿ™ŸÖ",
    waiting: "ÿ®ŸÜÿ≥ÿ™ŸÜŸâ ÿßŸÑŸÅŸäÿØŸäŸà‚Ä¶",
    saveWarn: "ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿß ÿ™ÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑŸÅŸäÿØŸäŸà ÿßŸÑŸÜÿßÿ™ÿ¨. ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ŸÖŸëŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿ£Ÿà ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨.",
    copied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ",
    carouselTitle: "ÿßŸÑŸÅŸäÿØŸäŸàŸáÿßÿ™ ÿßŸÑŸÜÿßÿ™ÿ¨ÿ©",
    carouselHint: "ÿßÿ≥ÿ≠ÿ® ŸÑŸÑÿ™ŸÜŸÇŸÑ ‚Ä¢ ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±",
    stickyNote: "ŸÜÿµŸäÿ≠ÿ©: ŸàŸÑŸëÿØ ÿ®ÿØÿ±Ÿä ÿπŸÑÿ¥ÿßŸÜ ÿ£ÿ≠ÿ≥ŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ‚ú®"
  }
};

function toArabicDigits(str){
  const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
  return String(str).replace(/[0-9]/g, d => map[d]);
}

let currentLang = "en";

function setLangButtons(lang){
  // AR/EN segmented control
  $("segAR").classList.toggle("on", lang === "ar");
  $("segEN").classList.toggle("on", lang === "en");
}

function applyLang(lang){
  currentLang = lang;
  const t = i18n[lang];

  $("headerTitle").textContent = t.headerTitle;
  $("betaPill").textContent = t.beta;
  $("heroTitle").innerHTML = t.heroTitle;

  const triesNum = (lang === "ar") ? toArabicDigits("3") : "3";
  $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;

  $("baseLabel").textContent = t.baseLabel;
  $("lockedTag").textContent = t.locked;
  $("trialsLabel").textContent = t.trialsLabel;

  $("modeLabel").textContent = t.modeLabel;
  $("modeTextTxt").textContent = t.modeText;
  $("modeImgTxt").textContent = t.modeImg;

  $("lblSubject").textContent = t.lblSubject;
  $("lblLocation").textContent = t.lblLocation;
  $("lblTwist").textContent = t.lblTwist;

  $("hintSubject").textContent = t.hintSubject;
  $("hintLocation").textContent = t.hintLocation;
  $("hintTwist").textContent = t.hintTwist;

  $("lblImages").textContent = t.lblImages;
  $("hintImages").textContent = t.hintImages;

  $("subject").placeholder = t.phSubject;
  $("location").placeholder = t.phLocation;
  $("twist").placeholder = t.phTwist;

  $("genBtnTxt").textContent = t.gen;
  $("dlTxt").textContent = t.dl;
  $("copyTxt").textContent = t.copy;
  $("backTxt").textContent = t.back;

  $("saveWarn").textContent = t.saveWarn;

  $("carouselTitleTxt").textContent = t.carouselTitle;
  $("carouselHintTxt").textContent = t.carouselHint;
  $("stickyNoteTxt").textContent = t.stickyNote;

  // Switch locked base prompt language
  const bp = $("basePrompt");
  if (bp) {
    const enText = bp.getAttribute("data-en") || bp.textContent;
    const arText = bp.getAttribute("data-ar") || bp.textContent;
    bp.textContent = (lang === "ar") ? arText : enText;
  }

  document.body.dir = (lang === "ar") ? "rtl" : "ltr";
  document.documentElement.lang = (lang === "ar") ? "ar" : "en";

  setLangButtons(lang);

  $("timerText").textContent = (lang === "ar") ? toArabicDigits("Ÿ°Ÿ† ÿ´") : "~10s";
}

/* segmented language control */
$("segAR").addEventListener("click", () => applyLang("ar"));
$("segEN").addEventListener("click", () => applyLang("en"));

/* ===========================
   Mode switching
=========================== */
const imagesBox = $("imagesBox");
$("modeText").addEventListener("click", () => {
  $("modeText").classList.add("on");
  $("modeImages").classList.remove("on");
  if(imagesBox) imagesBox.style.display = "none";
});
$("modeImages").addEventListener("click", () => {
  $("modeImages").classList.add("on");
  $("modeText").classList.remove("on");
  if(imagesBox) imagesBox.style.display = "block";
});

/* ===========================
   Helpers
=========================== */
function buildPrompt(){
  const base = $("basePrompt").textContent || "";
  const subject = ($("subject").value || "").trim();
  const location = ($("location").value || "").trim();
  const twist = ($("twist").value || "").trim();

  const parts = [];
  if(subject) parts.push(`Main subject: ${subject}`);
  if(location) parts.push(`Location: ${location}`);
  if(twist) parts.push(`Creative twist: ${twist}`);

  return `${base}\n\n---\n${parts.join("\n")}`.trim();
}

async function postJSON(payload){
  const url = API_URL + "?t=" + Date.now();
  const r = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });

  const text = await r.text();
  let data;
  try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }

  if(!r.ok){
    const msg = data?.error || data?.message || data?.raw || ("HTTP " + r.status);
    throw new Error(msg);
  }
  return data;
}

function showProgressUI(){
  $("resultBox").style.display = "block";
  $("bar").style.width = "0%";
  $("copyNote").style.display = "none";
}

function setTimerText(secondsLeft){
  if(currentLang === "ar"){
    $("timerText").textContent = secondsLeft > 0
      ? toArabicDigits(`${secondsLeft} ÿ´`)
      : i18n.ar.waiting;
  } else {
    $("timerText").textContent = secondsLeft > 0
      ? `~${secondsLeft}s`
      : i18n.en.waiting;
  }
}
function setDoneText(){
  $("timerText").textContent = (currentLang === "ar") ? i18n.ar.done : i18n.en.done;
}

/* ===========================
   Save/restore last URL
=========================== */
function saveLastUrl(url){
  try { localStorage.setItem(LAST_URL_KEY, url); } catch(e) {}
}
function loadLastUrl(){
  try { return localStorage.getItem(LAST_URL_KEY) || ""; } catch(e) { return ""; }
}

/* ===========================
   Carousel rendering (poster thumbnails)
=========================== */
function upsertCarouselItem(item){
  const idx = carouselState.items.findIndex(x => x.id === item.id);
  if(idx >= 0) carouselState.items[idx] = item;
  else carouselState.items.unshift(item); // newest first
}

function renderCarousel(){
  const el = $("carousel");
  if(!el) return;
  el.innerHTML = "";

  carouselState.items.forEach(item => {
    const div = document.createElement("div");
    div.className = "item" + (item.id === carouselState.selectedId ? " selected" : "");
    div.dataset.id = item.id;

    div.innerHTML = `
      <div class="thumb">
        <div class="badges">
          <div class="badge">‚è± ${item.seconds || "5‚Äì8s"}</div>
          <div class="badge">${item.ratio || "9:16"}</div>
        </div>

        <img class="poster" alt="video poster" loading="lazy" />

        <div class="playBadge">‚ñ∂</div>
        <div class="selectedRing"></div>
      </div>

      <div class="itemFooter">
        <div class="itemMeta">
          <span>${item.label || "Video"}</span>
          <span>${item.kind === "real" ? "‚úÖ Real" : "üß™ Demo"}</span>
        </div>
        <div class="actions">
          <button class="iconBtn" data-act="save">‚ù§Ô∏è</button>
          <button class="iconBtn" data-act="download">‚¨áÔ∏è</button>
          <button class="iconBtn" data-act="regen">üîÅ</button>
          <button class="iconBtn" data-act="use">‚≠ê</button>
        </div>
      </div>
    `;

    // poster only (no MP4 preload)
    const img = div.querySelector("img.poster");
    img.src = item.posterUrl || "";

    // select on tap
    div.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(btn) return;
      selectCarouselItem(item.id);
    });

    // actions
    div.querySelectorAll("button.iconBtn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const act = btn.dataset.act;

        if(act === "download") downloadFile(item.videoUrl);
        if(act === "save") {
          $("copyNote").style.display = "block";
          $("copyNote").textContent = (currentLang === "ar")
            ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ‚úÖ"
            : "Saved selection ‚úÖ";
        }
        if(act === "regen") {
          realGenerate();
        }
        if(act === "use") {
          $("copyNote").style.display = "block";
          $("copyNote").textContent = (currentLang === "ar")
            ? "ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÅŸäÿØŸäŸà ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ‚≠ê"
            : "Video selected for use ‚≠ê";
        }
      });
    });

    el.appendChild(div);
  });
}

function selectCarouselItem(id){
  carouselState.selectedId = id;
  renderCarousel();

  const item = carouselState.items.find(x => x.id === id);
  if(item && item.videoUrl){
    $("video").style.display = "block";
    $("video").src = item.videoUrl;
    $("video").load();
    saveLastUrl(item.videoUrl);
  }
}

function initDemoCarousel(){
  DEMO_VIDEOS.forEach(v => upsertCarouselItem({...v, kind:"demo"}));
  if(!carouselState.selectedId && carouselState.items.length){
    carouselState.selectedId = carouselState.items[0].id;
  }
  renderCarousel();
  selectCarouselItem(carouselState.selectedId);
}

/* ===========================
   Generate (kept; now adds to carousel with a poster)
=========================== */
async function realGenerate(){
  if(generating || trials <= 0) return;
  generating = true;

  trials--;
  $("trialsLeft").textContent = trials;

  showProgressUI();

  const maxSeconds = 60;
  const start = Date.now();
  let rafId;

  const tick = () => {
    const elapsed = (Date.now() - start) / 1000;
    const p = Math.min(95, (elapsed / maxSeconds) * 95);
    $("bar").style.width = p + "%";

    const remain = Math.max(0, Math.ceil(maxSeconds - elapsed));
    setTimerText(remain);

    rafId = requestAnimationFrame(tick);
  };
  tick();

  try{
    const prompt = buildPrompt();

    const gen = await postJSON({
      action: "generate",
      modelId: MODEL_ID,
      prompt
    });

    const operationName = gen.operationName || gen.name;

    if(gen.done && gen.downloadUrl){
      $("bar").style.width = "100%";
      setDoneText();

      const id = "real-" + Date.now();
      // Poster: for now just a nice placeholder.
      // Later: replace with a real thumbnail URL if you generate thumbnails server-side.
      const poster = `https://picsum.photos/600/1067?random=${Math.floor(Math.random()*1000)}`;

      upsertCarouselItem({
        id,
        label: (currentLang === "ar") ? "ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ" : "Generated",
        seconds: "5‚Äì8s",
        ratio: "9:16",
        posterUrl: poster,
        videoUrl: gen.downloadUrl,
        kind: "real"
      });
      selectCarouselItem(id);

      saveLastUrl(gen.downloadUrl);
      generating = false;
      cancelAnimationFrame(rafId);
      return;
    }

    if(!operationName){
      throw new Error("No operationName returned from generate");
    }

    const pollEveryMs = 3000;
    const maxPolls = 25;
    let doneData = null;

    for(let i=0;i<maxPolls;i++){
      await new Promise(res => setTimeout(res, pollEveryMs));

      const chk = await postJSON({
        action: "check",
        modelId: MODEL_ID,
        operationName
      });

      if(chk.done && chk.downloadUrl){
        doneData = chk;
        break;
      }
      if(chk.done && chk.response && chk.response.downloadUrl){
        doneData = { downloadUrl: chk.response.downloadUrl, done:true };
        break;
      }
    }

    if(!doneData){
      throw new Error("Still processing. Try again in a few seconds.");
    }

    $("bar").style.width = "100%";
    setDoneText();

    const id = "real-" + Date.now();
    const poster = `https://picsum.photos/600/1067?random=${Math.floor(Math.random()*1000)}`;

    upsertCarouselItem({
      id,
      label: (currentLang === "ar") ? "ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ" : "Generated",
      seconds: "5‚Äì8s",
      ratio: "9:16",
      posterUrl: poster,
      videoUrl: doneData.downloadUrl,
      kind: "real"
    });
    selectCarouselItem(id);

    saveLastUrl(doneData.downloadUrl);

  }catch(err){
    $("timerText").textContent = "Error: " + (err?.message || "Unknown error");
    $("bar").style.width = "0%";
  }finally{
    generating = false;
    if(rafId) cancelAnimationFrame(rafId);
  }
}

$("generateBtn").onclick = realGenerate;

/* ===========================
   Download / Copy / Back
=========================== */
function getCurrentVideoUrl(){
  const sel = carouselState.items.find(x => x.id === carouselState.selectedId);
  if(sel && sel.videoUrl) return sel.videoUrl;
  return ($("video") && $("video").src) ? $("video").src : loadLastUrl();
}

function downloadFile(url){
  if(!url) return;
  const a = document.createElement("a");
  a.href = url;
  a.download = "shaga3app-video.mp4";
  a.target = "_blank";
  a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

$("downloadBtn").addEventListener("click", () => {
  const url = getCurrentVideoUrl();
  if(!url) return;
  saveLastUrl(url);
  downloadFile(url);
});

$("copyBtn").addEventListener("click", async () => {
  const url = getCurrentVideoUrl();
  if(!url) return;

  saveLastUrl(url);

  try{
    await navigator.clipboard.writeText(url);
    $("copyNote").style.display = "block";
    $("copyNote").textContent = (currentLang === "ar") ? i18n.ar.copied : i18n.en.copied;
  }catch(e){
    const msg = (currentLang === "ar") ? "ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÖŸÜ ŸáŸÜÿß:" : "Copy the link from here:";
    const manual = prompt(msg, url);
    if(manual !== null){
      $("copyNote").style.display = "block";
      $("copyNote").textContent = (currentLang === "ar") ? i18n.ar.copied : i18n.en.copied;
    }
  }
});

$("backBtn").addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
});
$("appBack").addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
});

/* ===========================
   Logo loader (PNG)
=========================== */
const brandImg = $("brandImg");
if(brandImg){
  brandImg.src = "logoshaga3app.png?v=3";
  brandImg.onload = () => { brandImg.style.display = "block"; };
  brandImg.onerror = () => { /* ignore */ };
}

/* ===========================
   Init
=========================== */
initDemoCarousel();
applyLang("en");
</script>
</body>
</html>
