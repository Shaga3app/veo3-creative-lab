<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shaga3app ¬∑ AI Creative Playground</title>

  <style>
    /* ===== Added: logo + language toggle ===== */
    .brandLogo{
      width:26px;height:26px;border-radius:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .brandLogo img{width:100%;height:100%;object-fit:contain;display:block}

    .langBtn{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); color: var(--text);
      background: rgba(255,255,255,.06);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* make field hints look like your current hint style */
    .field .miniHint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
      opacity:.95;
    }

    /* ‚úÖ ADDED: hide below-field descriptions (we use placeholders inside inputs now) */
    .field .miniHint{ display:none; }

    :root{
      --bg:#0b0f18;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.10);
      --accent:#5b5cff;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 900px at 30% -10%, rgba(91,92,255,.25), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(34,197,94,.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:860px;margin:0 auto;padding:18px 16px 40px;}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      backdrop-filter:blur(10px);
    }

    /* Top Bar */
    .topBar{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{
      width:34px;height:34px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .logo svg{width:22px;height:22px}
    .pill{
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(91,92,255,.45);
      background:rgba(91,92,255,.18);
      font-size:12px;
      font-weight:800;
    }

    /* Hero */
    .hero{margin:18px 0}
    .hero h1{font-size:52px;line-height:1.05;margin:6px 0;font-weight:900}
    .hero p{color:var(--muted);font-size:18px;max-width:520px}

    .sectionLabel{
      margin:20px 0 10px;
      font-size:12px;
      letter-spacing:.14em;
      color:var(--muted);
    }

    /* Locked Base */
    .lockedBox{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }
    .lockedTop{display:flex;justify-content:space-between;align-items:center}
    .lockedTag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .lockedPrompt{
      margin-top:10px;
      border:2px dashed rgba(255,255,255,.16);
      border-radius:14px;
      padding:16px;
      font-family:ui-monospace,monospace;
      white-space:pre-wrap;
    }

    /* Mode */
    .modeBar{
      display:flex;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      background:rgba(0,0,0,.18);
    }
    .modeBtn{
      flex:1;
      padding:10px;
      border-radius:12px;
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:700;
    }
    .modeBtn.on{
      background:rgba(91,92,255,.22);
      border-color:rgba(91,92,255,.45);
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}

    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .field label{font-size:13px;margin-bottom:6px;display:block}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
    }

    .btn{
      padding:12px 16px;
      border-radius:14px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(180deg,#22c55e,#1ea84d);
      color:#07120a;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      text-decoration:none;
    }

    .result{
      display:none;
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.18);
    }
    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;width:0%;
      background:linear-gradient(90deg,#5b5cff,#22c55e);
    }
    video{
      width:100%;
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--line);
      display:none;
    }
  </style>
</head>

<body>
<div class="wrap">
<div class="card">

  <!-- Top -->
  <div class="topBar">
    <div class="brand">
      <div class="logo">
        <!-- ‚úÖ Logo image (PNG) + SVG fallback -->
        <img id="brandImg" alt="Shaga3app" style="display:none;width:22px;height:22px;object-fit:contain;">
        <svg viewBox="0 0 24 24">
          <path d="M12 3c2.5 2.8 4.8 4.2 7.5 4.9-1.3 5.6-4.3 9.6-7.5 13.2C8.8 17.5 5.8 13.5 4.5 7.9 7.2 7.2 9.5 5.8 12 3Z" fill="#5b5cff"/>
          <path d="M9 9c-1.5 2.4-2.2 4.6-2.4 7.2 2.4-1.1 4.2-3 5.1-5.2-.7-.7-1.7-1.4-2.7-2Z" fill="#22c55e"/>
        </svg>
      </div>
      <span id="brandText">Shaga3app ¬∑ AI Creative Playground</span>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <button class="langBtn" id="langToggle" type="button">AR</button>
      <div class="pill" id="betaPill">Beta ¬∑ Shaga3app powered</div>
    </div>
  </div>

  <!-- Hero -->
  <div class="hero">
    <h1 id="heroTitle">Play with our<br>guided video<br>prompt</h1>
    <p id="heroDesc">You get up to <b id="triesInline">3</b> tries. The core concept is fixed by us; you just add your creative twist ‚ú®</p>
  </div>

  <!-- Locked Base -->
  <div class="sectionLabel" id="baseLabel">BASE CONCEPT (LOCKED)</div>
  <div class="lockedBox">
    <div class="lockedTop">
      <div class="lockedTag" id="lockedTag">üîí Locked</div>
      <div class="lockedTag"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">3</b></div>
    </div>
    <div class="lockedPrompt" id="basePrompt">
YOUR_BASE_PROMPT_GOES_HERE

Example:
Create a vertical 9:16 cinematic video, 5 to 8 seconds long, with smooth camera moves and rich realistic lighting. The scene follows this concept, and we will inject the user details below.
    </div>
  </div>

  <!-- Mode -->
  <div class="sectionLabel" id="modeLabel">CHOOSE INPUT MODE</div>
  <div class="modeBar">
    <button class="modeBtn on" id="modeText">üìù <span id="modeTextTxt">Text prompt</span></button>
    <button class="modeBtn" id="modeImages">üñºÔ∏è <span id="modeImgTxt">Start + End images</span></button>
  </div>

  <!-- imagesBox -->
  <div class="field span2" id="imagesBox" style="display:none; margin-top:10px;">
    <label id="lblImages">Start + End images</label>
    <input type="file" id="startImg" accept="image/*">
    <input type="file" id="endImg" accept="image/*" style="margin-top:8px;">
    <div class="miniHint" id="hintImages">Upload a start frame and an end frame to guide the motion.</div>
  </div>

  <!-- Inputs -->
  <div class="grid">
    <div class="field">
      <label id="lblSubject">Main subject / character</label>
      <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
      <div class="miniHint" id="hintSubject">Who is the main character? (age, style, wardrobe, vibe)</div>
    </div>
    <div class="field">
      <label id="lblLocation">Location / environment</label>
      <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
      <div class="miniHint" id="hintLocation">Where is it happening? (city, time of day, lighting, atmosphere)</div>
    </div>

    <div class="field span2" id="extraBox">
      <label id="lblTwist">Extra creative twist</label>
      <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
      <div class="miniHint" id="hintTwist">Optional: camera move, mood, style, or one special detail.</div>
    </div>
  </div>

  <div style="margin-top:14px">
    <button class="btn" id="generateBtn">‚ñ∂ <span id="genBtnTxt">Generate video</span></button>
  </div>

  <!-- Result -->
  <div class="result" id="resultBox">
    <div class="miniHint" id="timerText" style="margin-top:0;margin-bottom:10px;">~10s</div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <video id="video" controls playsinline></video>
    <a class="btn secondary" id="downloadBtn" style="margin-top:10px" download>‚¨á <span id="dlTxt">Download video</span></a>
  </div>

</div>
</div>

<script>
const $ = id => document.getElementById(id);

/* ===========================
   ‚úÖ NEW: Your Lambda Function URL
=========================== */
const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
const MODEL_ID = "veo-3.1-generate-001"; // keep as default

let trials = 3;
let generating = false;

/* ===========================
   Arabic Toggle + RTL + Arabic Digits
=========================== */
const i18n = {
  en: {
    brandText: "Shaga3app ¬∑ AI Creative Playground",
    beta: "Beta ¬∑ Shaga3app powered",
    heroTitle: "Play with our<br>guided video<br>prompt",
    heroDescStart: "You get up to ",
    heroDescEnd: " tries. The core concept is fixed by us; you just add your creative twist ‚ú®",
    baseLabel: "BASE CONCEPT (LOCKED)",
    locked: "üîí Locked",
    trialsLabel: "Trials left:",
    modeLabel: "CHOOSE INPUT MODE",
    modeText: "Text prompt",
    modeImg: "Start + End images",
    lblSubject: "Main subject / character",
    lblLocation: "Location / environment",
    lblTwist: "Extra creative twist",
    lblImages: "Start + End images",
    hintSubject: "Who is the main character? (age, style, wardrobe, vibe)",
    hintLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
    hintTwist: "Optional: camera move, mood, style, or one special detail.",
    hintImages: "Upload a start frame and an end frame to guide the motion.",
    phSubject: "Who is the main character? (age, style, wardrobe, vibe)",
    phLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
    phTwist: "Optional: camera move, mood, style, or one special detail.",
    gen: "Generate video",
    dl: "Download video",
    done: "Done",
    generating: "Generating‚Ä¶",
    waiting: "Waiting for video‚Ä¶"
  },
  ar: {
    brandText: "ÿ¥ÿ¨Ÿëÿπ 3 ÿ¢ÿ® ¬∑ ŸÖŸÑÿπÿ® ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
    beta: "ÿ®Ÿäÿ™ÿß ¬∑ ÿ®ÿØÿπŸÖ Shaga3app",
    heroTitle: "ÿ¨ÿ±Ÿëÿ® ŸÖÿπÿßŸÜÿß<br>ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÅŸäÿØŸäŸà<br>ŸÖŸèŸàÿ¨ŸëŸéŸá",
    heroDescStart: "ŸÑÿØŸäŸÉ ",
    heroDescEnd: " ŸÖÿ≠ÿßŸàŸÑÿßÿ™. ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ´ÿßÿ®ÿ™ÿ©ÿõ ÿ£ŸÜÿ™ ŸÅŸÇÿ∑ ÿ£ÿ∂ŸêŸÅ ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸäÿ© ‚ú®",
    baseLabel: "ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä (ŸÖŸÇŸÅŸàŸÑ)",
    locked: "üîí ŸÖŸÇŸÅŸàŸÑ",
    trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
    modeLabel: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
    modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
    modeImg: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
    lblSubject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
    lblLocation: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
    lblTwist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ©",
    lblImages: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
    hintSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
    hintLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
    hintTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
    hintImages: "ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ŸÑÿ™Ÿàÿ¨ŸäŸá ÿßŸÑÿ≠ÿ±ŸÉÿ©.",
    phSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
    phLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
    phTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
    gen: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
    dl: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà",
    done: "ÿ™ŸÖ",
    generating: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶",
    waiting: "ÿ®ŸÜÿ≥ÿ™ŸÜŸâ ÿßŸÑŸÅŸäÿØŸäŸà‚Ä¶"
  }
};

function toArabicDigits(str){
  const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
  return String(str).replace(/[0-9]/g, d => map[d]);
}

let currentLang = "en";

function applyLang(lang){
  currentLang = lang;
  const t = i18n[lang];

  $("brandText").textContent = t.brandText;
  $("betaPill").textContent = t.beta;

  $("heroTitle").innerHTML = t.heroTitle;

  const triesNum = (lang === "ar") ? toArabicDigits("3") : "3";
  $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;

  $("baseLabel").textContent = t.baseLabel;
  $("lockedTag").textContent = t.locked;
  $("trialsLabel").textContent = t.trialsLabel;

  $("modeLabel").textContent = t.modeLabel;
  $("modeTextTxt").textContent = t.modeText;
  $("modeImgTxt").textContent = t.modeImg;

  $("lblSubject").textContent = t.lblSubject;
  $("lblLocation").textContent = t.lblLocation;
  $("lblTwist").textContent = t.lblTwist;

  $("hintSubject").textContent = t.hintSubject;
  $("hintLocation").textContent = t.hintLocation;
  $("hintTwist").textContent = t.hintTwist;

  $("lblImages").textContent = t.lblImages;
  $("hintImages").textContent = t.hintImages;

  $("subject").placeholder = t.phSubject;
  $("location").placeholder = t.phLocation;
  $("twist").placeholder = t.phTwist;

  $("genBtnTxt").textContent = t.gen;
  $("dlTxt").textContent = t.dl;

  document.body.dir = (lang === "ar") ? "rtl" : "ltr";
  document.documentElement.lang = (lang === "ar") ? "ar" : "en";
  $("langToggle").textContent = (lang === "ar") ? "EN" : "AR";

  $("timerText").textContent = (lang === "ar") ? toArabicDigits("Ÿ°Ÿ† ÿ´") : "~10s";
}

$("langToggle").addEventListener("click", () => {
  applyLang(currentLang === "en" ? "ar" : "en");
});

/* ===========================
   Mode switching
=========================== */
const imagesBox = document.getElementById("imagesBox");

document.getElementById("modeText").addEventListener("click", () => {
  document.getElementById("modeText").classList.add("on");
  document.getElementById("modeImages").classList.remove("on");
  if(imagesBox) imagesBox.style.display = "none";
});

document.getElementById("modeImages").addEventListener("click", () => {
  document.getElementById("modeImages").classList.add("on");
  document.getElementById("modeText").classList.remove("on");
  if(imagesBox) imagesBox.style.display = "block";
});

/* ===========================
   ‚úÖ NEW: Real Generate (calls your Lambda)
=========================== */

function buildPrompt(){
  const base = $("basePrompt").textContent || "";
  const subject = ($("subject").value || "").trim();
  const location = ($("location").value || "").trim();
  const twist = ($("twist").value || "").trim();

  const parts = [];
  if(subject) parts.push(`Main subject: ${subject}`);
  if(location) parts.push(`Location: ${location}`);
  if(twist) parts.push(`Creative twist: ${twist}`);

  // Your base is ‚Äúlocked‚Äù so we keep it + inject user parts
  return `${base}\n\n---\n${parts.join("\n")}`.trim();
}

async function postJSON(payload){
  // cache-bust always
  const url = API_URL + "?t=" + Date.now();
  const r = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });

  const text = await r.text();
  let data;
  try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
  if(!r.ok){
    const msg = data?.error || data?.message || data?.raw || ("HTTP " + r.status);
    throw new Error(msg);
  }
  return data;
}

function showProgressUI(){
  $("resultBox").style.display = "block";
  $("video").style.display = "none";
  $("bar").style.width = "0%";
}

function setTimerText(secondsLeft){
  if(currentLang === "ar"){
    $("timerText").textContent = secondsLeft > 0
      ? toArabicDigits(`${secondsLeft} ÿ´`)
      : i18n.ar.waiting;
  } else {
    $("timerText").textContent = secondsLeft > 0
      ? `~${secondsLeft}s`
      : i18n.en.waiting;
  }
}

function setDoneText(){
  $("timerText").textContent = (currentLang === "ar") ? i18n.ar.done : i18n.en.done;
}

async function realGenerate(){
  if(generating || trials <= 0) return;
  generating = true;

  trials--;
  $("trialsLeft").textContent = trials;

  showProgressUI();

  // Progress animation (we‚Äôll run it for up to 60s, then keep ‚Äúwaiting‚Ä¶‚Äù)
  const maxSeconds = 60;
  const start = Date.now();
  let rafId;

  const tick = () => {
    const elapsed = (Date.now() - start) / 1000;
    const p = Math.min(95, (elapsed / maxSeconds) * 95); // up to 95% while waiting
    $("bar").style.width = p + "%";

    const remain = Math.max(0, Math.ceil(maxSeconds - elapsed));
    setTimerText(remain);

    rafId = requestAnimationFrame(tick);
  };
  tick();

  try{
    const prompt = buildPrompt();

    // 1) Start generation
    const gen = await postJSON({
      action: "generate",
      modelId: MODEL_ID,
      prompt
    });

    // Possible responses:
    // - { name: "projects/.../operations/..." }
    // - OR already done with downloadUrl
    const operationName = gen.operationName || gen.name;

    // 2) If Lambda already returned done/downloadUrl, use it
    if(gen.done && gen.downloadUrl){
      $("bar").style.width = "100%";
      setDoneText();

      $("video").src = gen.downloadUrl;
      $("video").style.display = "block";
      $("video").load();

      $("downloadBtn").href = gen.downloadUrl;
      generating = false;
      cancelAnimationFrame(rafId);
      return;
    }

    if(!operationName){
      throw new Error("No operationName returned from generate");
    }

    // 3) Poll check until done (every 3 seconds, up to 60 seconds)
    const pollEveryMs = 3000;
    const maxPolls = 25; // ~75s total
    let doneData = null;

    for(let i=0;i<maxPolls;i++){
      await new Promise(res => setTimeout(res, pollEveryMs));

      const chk = await postJSON({
        action: "check",
        modelId: MODEL_ID,
        operationName
      });

      if(chk.done && chk.downloadUrl){
        doneData = chk;
        break;
      }
      // Some implementations wrap under "response"
      if(chk.done && chk.response && chk.response.downloadUrl){
        doneData = { downloadUrl: chk.response.downloadUrl, done:true };
        break;
      }
      // If it returns the original Vertex response with bytesBase64Encoded, your Lambda should convert it to S3.
      // In your latest Lambda, it DOES convert to S3 and returns downloadUrl, so we wait for that.
    }

    if(!doneData){
      throw new Error("Still processing. Try again in a few seconds.");
    }

    $("bar").style.width = "100%";
    setDoneText();

    $("video").src = doneData.downloadUrl;
    $("video").style.display = "block";
    $("video").load();

    $("downloadBtn").href = doneData.downloadUrl;

  }catch(err){
    // Show error in timer text area (simple + clear)
    $("timerText").textContent = "Error: " + (err?.message || "Unknown error");
    $("bar").style.width = "0%";
  }finally{
    generating = false;
    if(rafId) cancelAnimationFrame(rafId);
  }
}

$("generateBtn").onclick = realGenerate;

/* ===========================
   ‚úÖ Shaga3app logo loader (PNG) + SVG fallback
=========================== */
const brandImg = document.getElementById("brandImg");
const brandSvg = document.querySelector(".logo svg");
if(brandImg){
  brandImg.src = "logoshaga3app.png?v=3"; // cache-bust
  brandImg.onload = () => {
    brandImg.style.display = "block";
    if(brandSvg) brandSvg.style.display = "none";
  };
  brandImg.onerror = () => {
    if(brandSvg) brandSvg.style.display = "block";
  };
}

applyLang("en");
</script>
</body>
</html>
