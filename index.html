<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shaga3app ¬∑ AI Creative Playground</title>

  <style>
    :root{
      --bg:#0b0f18;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.12);
      --accent:#5b5cff;
      --accent2:#22c55e;
      --btnText:#07120a;

      --radius:18px;
      --radius2:16px;
      --shadow:0 18px 40px rgba(0,0,0,.35);

      --heroGradA: rgba(91,92,255,.25);
      --heroGradB: rgba(34,197,94,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 900px at 25% -10%, var(--heroGradA), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, var(--heroGradB), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width:900px;margin:0 auto;padding:16px 14px 36px;}
    .card{
      background:linear-gradient(180deg, var(--panel), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topBar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--panel2);
    }
    .brandLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .brandLogo{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
    }
    .brandLogo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:42vw;
      opacity:.95;
    }

    .topRight{display:flex;align-items:center;gap:10px;flex:0 0 auto;}
    .pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid color-mix(in srgb, var(--accent) 55%, transparent);
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .langBtn{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); color: var(--text);
      background: rgba(255,255,255,.06);
      font-weight:900; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .hero{margin:18px 0 10px}
    .hero h1{font-size:52px;line-height:1.05;margin:6px 0 8px;font-weight:950;letter-spacing:-.02em}
    .hero p{color:var(--muted);font-size:16px;max-width:560px;line-height:1.4;margin:0}

    .sectionLabel{
      margin:18px 0 8px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:color-mix(in srgb, var(--muted) 85%, transparent);
    }

    .lockedBox{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .lockedTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .lockedTag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:800;
    }
    .lockedPrompt{
      margin-top:10px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      line-height:1.45;
      color: rgba(229,231,235,.82);
      white-space:pre-wrap;
      max-height: 160px;
      overflow:auto;
    }

    .previewCard{
      margin-top:12px;
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .previewHeader{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:10px;
      color:color-mix(in srgb, var(--muted) 90%, transparent);
      font-size:12px;font-weight:800;
    }
    .badge{
      padding:5px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:900;
      color: rgba(229,231,235,.9);
      white-space:nowrap;
    }

    .mainStage{
      position:relative;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      min-height: 320px;
      aspect-ratio: 9 / 16;
    }
    .mainStage img,
    .mainStage video{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }
    .mainStage video{
      display:none;
      background:#000;
    }

    .playOverlay{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
      opacity:1;
      transition: opacity .12s ease;
    }
    .playOverlay.hidden{opacity:0}
    .playBtn{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:12px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      backdrop-filter: blur(8px);
    }

    .errorBox{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color: rgba(229,231,235,.92);
      font-size:12px;
      line-height:1.35;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .errorBox strong{display:block;margin-bottom:6px}

    .thumbRowWrap{
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:10px;
    }
    .thumbRow{
      display:flex;gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .thumbRow::-webkit-scrollbar{height:8px}
    .thumbRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

    .thumb{
      flex:0 0 auto;
      width:110px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      cursor:pointer;
      scroll-snap-align:start;
      position:relative;
      transition: transform .12s ease, border-color .12s ease;
    }
    .thumb:hover{transform: translateY(-1px)}
    .thumb.on{border-color: color-mix(in srgb, var(--accent2) 70%, white 0%); box-shadow:0 0 0 2px rgba(34,197,94,.12) inset;}
    .thumb img{width:100%;height:70px;object-fit:cover;display:block}
    .thumbMeta{
      padding:7px 8px 8px;
      display:flex;justify-content:space-between;align-items:center;
      gap:6px;
      font-size:11px;
      color: rgba(229,231,235,.9);
    }
    .thumbTag{
      font-size:10px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .thumbPlay{
      position:absolute;left:8px;top:8px;
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
    }
    .thumbDots{
      display:flex;justify-content:center;gap:6px;
      padding-top:8px;
    }
    .dot{width:6px;height:6px;border-radius:999px;background:rgba(255,255,255,.18)}
    .dot.on{background: color-mix(in srgb, var(--accent2) 80%, transparent);}

    .modeBar{
      margin-top:14px;
      display:flex;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      background: var(--panel2);
    }
    .modeBtn{
      flex:1;
      padding:10px;
      border-radius:12px;
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
    }
    .modeBtn.on{
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}

    .field{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .field label{font-size:13px;margin-bottom:6px;display:block;font-weight:800;color:rgba(229,231,235,.92)}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .field input::placeholder{color:rgba(148,163,184,.65)}
    .miniHint{margin-top:10px;font-size:12px;color: var(--muted);line-height:1.35;opacity:.95}

    .result{
      display:none;
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: var(--panel2);
    }
    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:none;
      font-weight:950;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      width:100%;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
    }
    .btn.primary{
      background:linear-gradient(180deg, var(--accent2), color-mix(in srgb, var(--accent2) 70%, #000 30%));
      color:var(--btnText);
      border:1px solid rgba(0,0,0,.10);
    }

    .actionsUnderInputs{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .actionsUnderInputs .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media(min-width:720px){
      .actionsUnderInputs .row2{max-width:520px}
      .actionsUnderInputs .primaryWrap{max-width:520px}
    }

    body[dir="rtl"] .hero h1{letter-spacing:0}
    body[dir="rtl"] .brandTitle{max-width:50vw}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="topBar">
        <div class="brandLeft">
          <div class="brandLogo"><img id="brandLogo" alt="logo"></div>
          <div class="brandTitle" id="brandTitle">Shaga3app ¬∑ AI Video Lab</div>
        </div>

        <div class="topRight">
          <button class="langBtn" id="langToggle" type="button">AR</button>
          <div class="pill" id="betaPill">Beta ¬∑ Shaga3app powered</div>
        </div>
      </div>

      <div class="hero">
        <h1 id="heroTitle">Play with our<br>guided video<br>prompt</h1>
        <p id="heroDesc">You get up to <b id="triesInline">2</b> tries. The core concept is fixed by us; you just add your creative twist ‚ú®</p>
      </div>

      <div class="sectionLabel" id="baseLabel">BASE CONCEPT (LOCKED)</div>
      <div class="lockedBox">
        <div class="lockedTop">
          <div class="lockedTag" id="lockedTag">üîí Locked</div>
          <div class="lockedTag"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">2</b></div>
        </div>
        <div class="lockedPrompt" id="basePrompt"></div>
      </div>

      <div class="previewCard">
        <div class="previewHeader">
          <div id="selectedLabel">Selected demo</div>
          <div class="badge" id="formatBadge">9:16 ‚Ä¢ 5‚Äì8s</div>
        </div>

        <div class="mainStage" id="mainStage">
          <img id="mainPoster" alt="Selected poster" />
          <video id="mainVideo" controls playsinline preload="none"></video>

          <div class="playOverlay" id="playOverlay">
            <button class="playBtn" id="playBtn" type="button">‚ñ∂ <span id="playTxt">Play</span></button>
          </div>
        </div>

        <div class="errorBox" id="errorBox">
          <strong id="errorTitle">Error details</strong>
          <div id="errorText"></div>
        </div>

        <div class="thumbRowWrap">
          <div class="thumbRow" id="thumbRow"></div>
          <div class="thumbDots" id="thumbDots"></div>
        </div>

        <div class="miniHint" id="saveWarn" style="margin-top:10px;">
          This page does not save your generated video. Please download it or copy the link before leaving.
        </div>
      </div>

      <div class="sectionLabel" id="modeLabel">CHOOSE INPUT MODE</div>
      <div class="modeBar">
        <button class="modeBtn on" id="modeText" type="button">üìù <span id="modeTextTxt">Text prompt</span></button>
        <button class="modeBtn" id="modeImages" type="button">üñºÔ∏è <span id="modeImgTxt">Start + End images</span></button>
      </div>

      <div class="field span2" id="imagesBox" style="display:none; margin-top:10px;">
        <label id="lblImages">Start + End images</label>
        <input type="file" id="startImg" accept="image/*">
        <input type="file" id="endImg" accept="image/*" style="margin-top:8px;">
        <div class="miniHint" id="hintImages">Upload a START image. END image is optional (needs bucket on the backend).</div>
      </div>

      <div class="grid">
        <div class="field">
          <label id="lblSubject">Main subject / character</label>
          <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
        </div>
        <div class="field">
          <label id="lblLocation">Location / environment</label>
          <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
        </div>

        <div class="field span2">
          <label id="lblTwist">Extra creative twist</label>
          <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
        </div>
      </div>

      <div class="actionsUnderInputs">
        <div class="primaryWrap">
          <button class="btn primary" id="generateBtn" type="button">‚ö° <span id="genTxt">Generate video</span></button>
        </div>
        <div class="row2">
          <button class="btn secondary" id="copyBtn" type="button">üîó <span id="copyTxt">Copy link</span></button>
          <button class="btn secondary" id="downloadBtn" type="button">‚¨á <span id="dlTxt">Download</span></button>
        </div>
      </div>

      <div class="result" id="resultBox">
        <div class="miniHint" id="timerText" style="display:block;margin-top:0;margin-bottom:10px;"></div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="miniHint" id="resultNote" style="margin-top:10px;"></div>
      </div>

    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);

  const DEVICE_ID_KEY = "shaga3_device_id";
  function getDeviceId(){
    try{
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if(!id){
        id = "dev_" + (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random().toString(16).slice(2)));
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    }catch(e){
      return "dev_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }
  }

  const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
  const MODEL_ID = "veo-3.1-generate-001";
  const API_KEY = "v3_9f8c2d1a_6b7c8d9e_0a1b2c3d4e5f9n5v";

  const LAST_URL_KEY = "shaga3app_last_video_url";
  const LAST_BRAND_KEY = "shaga3app_last_brand";

  const PENDING_OP_KEY = "shaga3app_pending_op_v1";
  const PENDING_OP_TTL_MS = 30 * 60 * 1000;

  const PENDING_META_KEY = "shaga3app_pending_meta_v1";
  function savePendingMeta(meta){
    try{ localStorage.setItem(PENDING_META_KEY, JSON.stringify(meta)); }catch(e){}
  }
  function loadPendingMeta(){
    try{ return JSON.parse(localStorage.getItem(PENDING_META_KEY) || "null"); }catch(e){ return null; }
  }
  function clearPendingMeta(){
    try{ localStorage.removeItem(PENDING_META_KEY); }catch(e){}
  }

  function savePendingOp(op){
    try{ localStorage.setItem(PENDING_OP_KEY, JSON.stringify(op)); }catch(e){}
  }
  function loadPendingOp(){
    try{
      const raw = localStorage.getItem(PENDING_OP_KEY);
      if(!raw) return null;
      const op = JSON.parse(raw);
      if(!op || !op.operationName || !op.createdAt) return null;
      if(Date.now() - op.createdAt > PENDING_OP_TTL_MS) return null;
      return op;
    }catch(e){
      return null;
    }
  }
  function clearPendingOp(){
    try{ localStorage.removeItem(PENDING_OP_KEY); }catch(e){}
  }

  const i18n = {
    en: {
      heroTitle: "Play with our<br>guided video<br>prompt",
      heroDescStart: "You get up to ",
      heroDescEnd: " tries. The core concept is fixed by us; you just add your creative twist ‚ú®",
      baseLabel: "BASE CONCEPT (LOCKED)",
      locked: "üîí Locked",
      trialsLabel: "Trials left:",
      selectedDemo: "Selected demo",
      play: "Play",
      pause: "Pause",
      modeLabel: "CHOOSE INPUT MODE",
      modeText: "Text prompt",
      modeImg: "Start + End images",
      lblSubject: "Main subject / character",
      lblLocation: "Location / environment",
      lblTwist: "Extra creative twist",
      lblImages: "Start + End images",
      hintImages: "Upload a START image. END image is optional (needs bucket on the backend).",
      phSubject: "Who is the main character? (age, style, wardrobe, vibe)",
      phLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
      phTwist: "Optional: camera move, mood, style, or one special detail.",
      gen: "Generate video",
      dl: "Download",
      copy: "Copy link",
      saveWarn: "This page does not save your generated video. Please download it or copy the link before leaving.",
      waiting: "Generating‚Ä¶",
      stillWorking: "Still generating‚Ä¶ we are checking for the result.",
      longer: "This is taking longer than usual. Please try again in a minute.",
      ready: "Ready ‚úÖ",
      copied: "Link copied ‚úÖ",
      newTag: "New",
      demoTag: "Demo",
      limitReached: "‚ùå You reached the max trials for today. Try again tomorrow.",
      needStart: "Please upload a START image.",
      tryAgainSoft: "Could not complete this time. Please try again."
    },
    ar: {
      heroTitle: "ÿ¨ÿ±Ÿëÿ® ŸÖÿπÿßŸÜÿß<br>ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÅŸäÿØŸäŸà<br>ŸÖŸèŸàÿ¨ŸëŸéŸá",
      heroDescStart: "ŸÑÿØŸäŸÉ ",
      heroDescEnd: " ŸÖÿ≠ÿßŸàŸÑÿßÿ™. ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ´ÿßÿ®ÿ™ÿ©. ÿ£ŸÜÿ™ ŸÅŸÇÿ∑ ÿ£ÿ∂ŸêŸÅ ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸäÿ© ‚ú®",
      baseLabel: "ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä (ŸÖŸÇŸÅŸàŸÑ)",
      locked: "üîí ŸÖŸÇŸÅŸàŸÑ",
      trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
      selectedDemo: "ÿßŸÑÿØŸäŸÖŸà ÿßŸÑŸÖÿÆÿ™ÿßÿ±",
      play: "ÿ™ÿ¥ÿ∫ŸäŸÑ",
      pause: "ÿ•ŸäŸÇÿßŸÅ",
      modeLabel: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
      modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
      modeImg: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
      lblSubject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
      lblLocation: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
      lblTwist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ©",
      lblImages: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
      hintImages: "ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©. ÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ©. ŸÖÿ≠ÿ™ÿßÿ¨ÿ© Bucket ŸÅŸä ÿßŸÑÿ®ÿßŸÉ ÿ•ŸÜÿØ.",
      phSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ. ÿ≥ÿ™ÿßŸäŸÑ. ŸÖŸÑÿßÿ®ÿ≥. ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
      phLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©. ŸàŸÇÿ™. ÿ•ÿ∂ÿßÿ°ÿ©. ÿ£ÿ¨Ÿàÿßÿ°)",
      phTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä. ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß. ŸÖŸàÿØ. ÿ≥ÿ™ÿßŸäŸÑ. ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
      gen: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
      dl: "ÿ™ÿ≠ŸÖŸäŸÑ",
      copy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
      saveWarn: "ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿß ÿ™ÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑŸÅŸäÿØŸäŸà ÿßŸÑŸÜÿßÿ™ÿ¨. ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ŸÖŸëŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿ£Ÿà ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨.",
      waiting: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶",
      stillWorking: "ŸÑÿ≥Ÿá ÿ¥ÿ∫ÿßŸÑŸäŸÜ‚Ä¶ Ÿàÿ®ŸÜÿ™ÿßÿ®ÿπ ŸÑÿ≠ÿØ ŸÖÿß ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿ™ÿ¨Ÿáÿ≤.",
      longer: "ÿßŸÑÿ™ŸàŸÑŸäÿØ ÿ®ŸäÿßÿÆÿØ ŸàŸÇÿ™ ÿ£ÿ∑ŸàŸÑ ŸÖŸÜ ÿßŸÑŸÖÿπÿ™ÿßÿØ. ÿ¨ÿ±Ÿëÿ® ÿ™ÿßŸÜŸä ÿ®ÿπÿØ ÿØŸÇŸäŸÇÿ©.",
      ready: "ÿ¨ÿßŸáÿ≤ ‚úÖ",
      copied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ",
      newTag: "ÿ¨ÿØŸäÿØ",
      demoTag: "ÿØŸäŸÖŸà",
      limitReached: "‚ùå ŸàÿµŸÑÿ™ ŸÑŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÜŸáÿßÿ±ÿØÿ©. ÿ¨ÿ±Ÿëÿ® ÿ®ŸÉÿ±ÿ©.",
      needStart: "ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©.",
      tryAgainSoft: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿØŸä ŸÖÿß ŸÉŸÖŸÑÿ™ÿ¥. ÿ¨ÿ±Ÿëÿ® ÿ™ÿßŸÜŸä."
    }
  };

  function toArabicDigits(str){
    const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
    return String(str).replace(/[0-9]/g, d => map[d]);
  }

  let currentLang = "en";

  function getBrandFromUrl(){
    const u = new URL(location.href);
    const b = (u.searchParams.get("brand") || "").trim().toLowerCase();
    if(b) return b;
    try{
      const last = localStorage.getItem(LAST_BRAND_KEY);
      if(last) return last;
    }catch(e){}
    return "shaga3";
  }

  const FALLBACK_BRANDS = {
    shaga3: {
      id:"shaga3",
      title_en:"Shaga3app ¬∑ AI Creative Playground",
      title_ar:"ÿ¥ÿ¨Ÿëÿπ 3 ÿ¢ÿ® ¬∑ ŸÖŸÑÿπÿ® ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
      beta_en:"Beta ¬∑ Shaga3app powered",
      beta_ar:"ÿ®Ÿäÿ™ÿß ¬∑ ÿ®ÿØÿπŸÖ Shaga3app",
      logo:"assets/brand-logos/shaga3app.png",
      theme:{
        bg:"#0b0f18",
        accent:"#5b5cff",
        accent2:"#22c55e",
        heroGradA:"rgba(91,92,255,.25)",
        heroGradB:"rgba(34,197,94,.12)"
      },
      basePrompt_en:
`BASE (LOCKED)

Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich realistic lighting.
The scene follows this core concept, and we will inject the user details below.`,
      basePrompt_ar:
`ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)

ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ÿ•ŸÑŸâ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ŸÖÿπ ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© ÿ∫ŸÜŸäÿ©.
ÿßŸÑŸÖÿ¥ŸáÿØ ÿ®Ÿäÿ™ÿ®ÿπ ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©ÿå Ÿàÿ≥ŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑÿ£ÿ≥ŸÅŸÑ.`,
      demos: [
        { id:"demo-0", kind:"demo", poster:"https://picsum.photos/seed/purple-a/400/700", video:"https://samplelib.com/lib/preview/mp4/sample-5s.mp4", tag:"demo" },
        { id:"demo-1", kind:"demo", poster:"https://picsum.photos/seed/purple-b/400/700", video:"https://samplelib.com/lib/preview/mp4/sample-10s.mp4", tag:"demo" },
        { id:"demo-2", kind:"demo", poster:"https://picsum.photos/seed/purple-c/400/700", video:"https://samplelib.com/lib/preview/mp4/sample-5s.mp4", tag:"demo" },
        { id:"demo-3", kind:"demo", poster:"https://picsum.photos/seed/purple-d/400/700", video:"https://samplelib.com/lib/preview/mp4/sample-10s.mp4", tag:"demo" },
        { id:"demo-4", kind:"demo", poster:"https://picsum.photos/seed/purple-e/400/700", video:"https://samplelib.com/lib/preview/mp4/sample-5s.mp4", tag:"demo" }
      ]
    }
  };

  function normalizeBrand(raw, brandId){
    const fb = FALLBACK_BRANDS[brandId] || FALLBACK_BRANDS.shaga3;
    const theme = raw.theme || raw.colors || {};
    return {
      id: raw.id || brandId,
      title_en: raw.title_en || raw.title || fb.title_en,
      title_ar: raw.title_ar || fb.title_ar,
      beta_en: raw.beta_en || fb.beta_en,
      beta_ar: raw.beta_ar || fb.beta_ar,
      logo: raw.logo || fb.logo,
      theme: {
        bg: theme.bg || fb.theme.bg,
        accent: theme.accent || fb.theme.accent,
        accent2: theme.accent2 || fb.theme.accent2,
        heroGradA: theme.heroGradA || fb.theme.heroGradA,
        heroGradB: theme.heroGradB || fb.theme.heroGradB
      },
      basePrompt_en: raw.basePrompt_en || fb.basePrompt_en,
      basePrompt_ar: raw.basePrompt_ar || fb.basePrompt_ar,
      demos: Array.isArray(raw.demos) ? raw.demos : fb.demos
    };
  }

  async function loadBrandConfig(brandId){
    try{ localStorage.setItem(LAST_BRAND_KEY, brandId); }catch(e){}
    try{
      const r = await fetch(`brands/${brandId}.json?t=${Date.now()}`, {cache:"no-store"});
      if(r.ok){
        const parsed = await r.json();
        return normalizeBrand(parsed, brandId);
      }
    }catch(e){}
    return FALLBACK_BRANDS[brandId] || FALLBACK_BRANDS.shaga3;
  }

  function applyTheme(theme){
    const root = document.documentElement.style;
    root.setProperty("--bg", theme.bg);
    root.setProperty("--accent", theme.accent);
    root.setProperty("--accent2", theme.accent2);
    root.setProperty("--heroGradA", theme.heroGradA);
    root.setProperty("--heroGradB", theme.heroGradB);
    root.setProperty("--btnText", "#07120a");
  }

  function setBrandUI(cfg){
    $("brandTitle").textContent = (currentLang === "ar") ? cfg.title_ar : cfg.title_en;
    $("betaPill").textContent = (currentLang === "ar") ? cfg.beta_ar : cfg.beta_en;
    document.title = (currentLang === "ar") ? cfg.title_ar : cfg.title_en;

    const img = $("brandLogo");
    img.src = cfg.logo || "assets/brand-logos/shaga3app.png";
    img.onerror = () => { img.src = "assets/brand-logos/shaga3app.png"; };
  }

  let brandCfg = null;
  let items = [];
  let selectedIndex = 0;

  function renderBasePrompt(){
    if(!brandCfg) return;
    $("basePrompt").textContent = (currentLang === "ar") ? brandCfg.basePrompt_ar : brandCfg.basePrompt_en;
  }

  function buildDots(){
    const dots = $("thumbDots");
    dots.innerHTML = "";
    const pages = Math.min(10, Math.max(1, Math.ceil(items.length / 2)));
    for(let i=0;i<pages;i++){
      const dot = document.createElement("div");
      dot.className = "dot";
      dots.appendChild(dot);
    }
  }
  function updateDots(){
    const dots = [...$("thumbDots").children];
    if(!dots.length) return;
    const page = Math.min(dots.length-1, Math.floor(selectedIndex / 2));
    dots.forEach((d,i)=>d.classList.toggle("on", i===page));
  }

  const mainVideo = $("mainVideo");
  const mainPoster = $("mainPoster");
  const playOverlay = $("playOverlay");
  const playBtn = $("playBtn");

  function setOverlayVisible(visible){
    playOverlay.classList.toggle("hidden", !visible);
    playOverlay.style.pointerEvents = visible ? "auto" : "none";
  }
  function syncOverlay(){
    const hasVideo = mainVideo.style.display !== "none" && !!mainVideo.src;
    if(!hasVideo){ setOverlayVisible(true); return; }
    if(mainVideo.ended || mainVideo.paused) setOverlayVisible(true);
    else setOverlayVisible(false);
  }
  mainVideo.addEventListener("play", syncOverlay);
  mainVideo.addEventListener("pause", syncOverlay);
  mainVideo.addEventListener("ended", syncOverlay);

  function showPoster(it){
    mainPoster.src = it.poster || "";
    mainPoster.style.display = "block";

    mainVideo.pause();
    mainVideo.removeAttribute("src");
    mainVideo.load();
    mainVideo.style.display = "none";

    setOverlayVisible(true);
  }

  function playInline(it, opts = {}){
    const { hidePosterWhilePlaying = true, startMuted = false, skipSeconds = 0 } = opts;

    mainVideo.muted = !!startMuted;
    mainVideo.src = it.video;
    mainVideo.style.display = "block";
    mainPoster.style.display = hidePosterWhilePlaying ? "none" : "block";

    if(skipSeconds && skipSeconds > 0){
      const doSkip = ()=>{
        try{
          const d = Number(mainVideo.duration || 0);
          const target = Math.min(skipSeconds, Math.max(0, d - 0.05) || skipSeconds);
          if(!Number.isNaN(target) && target > 0) mainVideo.currentTime = target;
        }catch(e){}
      };
      mainVideo.addEventListener("loadedmetadata", doSkip, { once:true });
      mainVideo.addEventListener("canplay", doSkip, { once:true });
    }

    mainVideo.load();
    mainVideo.play().catch(()=>{});
    syncOverlay();
  }

  function openVideoViewer(url){
    if(!url) return;
    window.open(url, "_blank", "noopener");
  }

  function setSelected(index){
    selectedIndex = Math.max(0, Math.min(items.length-1, index));
    [...$("thumbRow").children].forEach((el,i)=>el.classList.toggle("on", i===selectedIndex));
    updateDots();
    showPoster(items[selectedIndex]);
  }

  function renderThumbs(){
    const row = $("thumbRow");
    row.innerHTML = "";
    $("thumbDots").innerHTML = "";

    items.forEach((it, idx)=>{
      const d = document.createElement("div");
      d.className = "thumb" + (idx===selectedIndex ? " on" : "");
      d.innerHTML = `
        <div class="thumbPlay">‚ñ∂</div>
        <img alt="poster" src="${it.poster || ""}">
        <div class="thumbMeta">
          <span class="thumbTag">${(currentLang==="ar") ? (it.kind==="new" ? i18n.ar.newTag : i18n.ar.demoTag) : (it.kind==="new" ? i18n.en.newTag : i18n.en.demoTag)}</span>
          <span style="opacity:.75">${idx+1}</span>
        </div>
      `;
      d.addEventListener("click", ()=>{
        setSelected(idx);
        const it2 = items[idx];
        if(it2?.video){
          const skip = (it2.kind === "new" && it2.i2v) ? 0.2 : 0;
          playInline(it2, { hidePosterWhilePlaying:true, startMuted:false, skipSeconds: skip });
        }
      });
      row.appendChild(d);
    });

    buildDots();
    updateDots();
  }

  function toCleanText(v){
    if(v == null) return "";
    if(typeof v === "string") return v;
    try{ return JSON.stringify(v, null, 2); }catch(e){ return String(v); }
  }

  function extractBackendMessage(data, fallbackText, httpStatus){
    const msg =
      data?.errorDetail ||
      data?.error?.message ||
      data?.error?.details ||
      data?.error?.error ||
      data?.error ||
      data?.message ||
      data?.raw ||
      fallbackText ||
      (httpStatus ? ("HTTP " + httpStatus) : "Unknown error");
    return toCleanText(msg).trim();
  }

  function showErrorDetail(msg){
    const box = $("errorBox");
    const title = $("errorTitle");
    const text = $("errorText");
    title.textContent = (currentLang === "ar") ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£" : "Error details";
    const m = toCleanText(msg).trim();
    if(!m){ box.style.display = "none"; text.textContent = ""; return; }
    text.textContent = m;
    box.style.display = "block";
  }
  function clearErrorDetail(){
    $("errorBox").style.display = "none";
    $("errorText").textContent = "";
  }

  $("modeText").addEventListener("click", ()=>{
    $("modeText").classList.add("on");
    $("modeImages").classList.remove("on");
    $("imagesBox").style.display = "none";
  });
  $("modeImages").addEventListener("click", ()=>{
    $("modeImages").classList.add("on");
    $("modeText").classList.remove("on");
    $("imagesBox").style.display = "block";
  });
  function isImagesModeOn(){
    return $("modeImages").classList.contains("on");
  }

  async function fileToB64(file){
    const dataUrl = await new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
    return String(dataUrl).split(",")[1] || "";
  }

  function requireStartImageOrThrow(){
    const startFile = $("startImg")?.files?.[0];
    if(!startFile) throw new Error((currentLang==="ar") ? i18n.ar.needStart : i18n.en.needStart);
    return startFile;
  }

  function buildPrompt(){
    const base = $("basePrompt").textContent || "";
    const subject = ($("subject").value || "").trim();
    const location = ($("location").value || "").trim();
    const twist = ($("twist").value || "").trim();

    const parts = [];
    if(subject) parts.push(`Main subject: ${subject}`);
    if(location) parts.push(`Location: ${location}`);
    if(twist) parts.push(`Creative twist: ${twist}`);

    return `${base}\n\n---\n${parts.join("\n")}`.trim();
  }

  async function postJSON(payload){
    const url = API_URL + "?t=" + Date.now();
    const r = await fetch(url,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-API-KEY": API_KEY
      },
      body: JSON.stringify(payload),
    });

    const text = await r.text();
    let data;
    try{ data = JSON.parse(text); }catch(e){ data = { raw:text }; }

    if(!r.ok || (data && (data.error || data.ok === false))){
      const err = new Error(extractBackendMessage(data, text, r.status) || ("HTTP " + r.status));
      err.statusCode = r.status;
      err.backend = data;
      err.httpStatus = r.status;
      throw err;
    }

    return data;
  }

  const TRIALS_MAX = 2;
  const TRIALS_STATE_KEY = "shaga3_trials_state_v1";
  const TRIALS_WINDOW_MS = 24 * 60 * 60 * 1000;

  function loadTrialsState(){
    try{
      const raw = localStorage.getItem(TRIALS_STATE_KEY);
      if(!raw) return { windowStart: Date.now(), used: 0 };
      const s = JSON.parse(raw);
      if(!s || typeof s.windowStart !== "number" || typeof s.used !== "number") return { windowStart: Date.now(), used: 0 };
      if(Date.now() - s.windowStart >= TRIALS_WINDOW_MS) return { windowStart: Date.now(), used: 0 };
      s.used = Math.max(0, Math.min(TRIALS_MAX, Math.floor(s.used)));
      return s;
    }catch(e){
      return { windowStart: Date.now(), used: 0 };
    }
  }
  function saveTrialsState(state){
    try{ localStorage.setItem(TRIALS_STATE_KEY, JSON.stringify(state)); }catch(e){}
  }
  function getTrialsLeftFromState(state){
    return Math.max(0, TRIALS_MAX - (state.used || 0));
  }

  let trialsState = loadTrialsState();
  let trials = getTrialsLeftFromState(trialsState);
  let generating = false;

  function setTrialsLeft(n){
    trials = Math.max(0, Math.min(TRIALS_MAX, Number(n||0)));
    $("trialsLeft").textContent = (currentLang==="ar") ? toArabicDigits(String(trials)) : String(trials);
    const triesNum = (currentLang==="ar") ? toArabicDigits(String(trials)) : String(trials);
    const t = i18n[currentLang];
    $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;
  }
  function consumeOneTrial(){
    const s = loadTrialsState();
    s.used = Math.min(TRIALS_MAX, (s.used||0) + 1);
    saveTrialsState(s);
    setTrialsLeft(getTrialsLeftFromState(s));
  }
  function hardLockTrialsToZero(){
    const s = loadTrialsState();
    s.used = TRIALS_MAX;
    saveTrialsState(s);
    setTrialsLeft(0);
  }
  function getTrialStatusFromLocal(){
    trialsState = loadTrialsState();
    trials = getTrialsLeftFromState(trialsState);
    setTrialsLeft(trials);
  }

  function saveLastUrl(url){
    try{ localStorage.setItem(LAST_URL_KEY, url); }catch(e){}
  }
  function loadLastUrl(){
    try{ return localStorage.getItem(LAST_URL_KEY) || ""; }catch(e){ return ""; }
  }

  function setTimerText(secondsLeft){
    if(currentLang === "ar"){
      $("timerText").textContent = secondsLeft > 0 ? `ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶ (${toArabicDigits(secondsLeft)} ÿ´)` : i18n.ar.waiting;
    } else {
      $("timerText").textContent = secondsLeft > 0 ? `Generating‚Ä¶ (~${secondsLeft}s)` : i18n.en.waiting;
    }
  }
  function setReadyText(){ $("timerText").textContent = (currentLang==="ar") ? i18n.ar.ready : i18n.en.ready; }

  function isTrialLimitErrorMessage(msg){
    const m = String(msg||"").toUpperCase();
    return m.includes("TRIAL_LIMIT_REACHED") || m.includes("LIMIT_REACHED") || m.includes("HTTP 429") || m.includes("429");
  }
  function showLimitReached(){
    $("resultBox").style.display = "block";
    $("bar").style.width = "0%";
    $("timerText").textContent = (currentLang==="ar") ? i18n.ar.limitReached : i18n.en.limitReached;
    $("resultNote").textContent = "";
  }

  const PENDING_META_KEY = "shaga3app_pending_meta_v1";
  function savePendingMeta(meta){
    try{ localStorage.setItem(PENDING_META_KEY, JSON.stringify(meta)); }catch(e){}
  }
  function loadPendingMeta(){
    try{ return JSON.parse(localStorage.getItem(PENDING_META_KEY) || "null"); }catch(e){ return null; }
  }
  function clearPendingMeta(){
    try{ localStorage.removeItem(PENDING_META_KEY); }catch(e){}
  }

  function startOrResumeProgress(maxSeconds, createdAtMs){
    $("resultBox").style.display = "block";

    const startMs = Number(createdAtMs || Date.now());
    const maxMs = Math.max(1, Number(maxSeconds || 240) * 1000);

    if(window.__resumeRaf) cancelAnimationFrame(window.__resumeRaf);

    const tick = ()=>{
      const elapsedMs = Date.now() - startMs;
      const p = Math.min(95, Math.max(0, (elapsedMs / maxMs) * 95));
      $("bar").style.width = p + "%";

      const remain = Math.max(0, Math.ceil((maxMs - elapsedMs) / 1000));
      setTimerText(remain);

      window.__resumeRaf = requestAnimationFrame(tick);
    };

    tick();
  }

  function onGenerated(url){
    if(window.__resumeRaf) cancelAnimationFrame(window.__resumeRaf);
    $("bar").style.width = "100%";
    setReadyText();
    $("resultNote").textContent = "";

    const item = {
      id: "new-" + Date.now(),
      kind: "new",
      poster: items[selectedIndex]?.poster || mainPoster.src || "https://picsum.photos/seed/new/400/700",
      video: url,
      tag: "new",
      i2v: isImagesModeOn() ? 1 : 0
    };

    items.unshift(item);
    selectedIndex = 0;
    renderThumbs();
    setSelected(0);

    playInline(item, { hidePosterWhilePlaying:true, startMuted:false, skipSeconds: item.i2v ? 0.2 : 0 });

    saveLastUrl(url);
  }

  async function pollForResult(operationName){
    const meta = loadPendingMeta();
    const isImages = !!meta?.isImages;
    const maxChecks = isImages ? 110 : 70;

    let waitMs = 3000;
    const maxWaitMs = 10000;

    for(let i=0;i<maxChecks;i++){
      await new Promise(res=>setTimeout(res, waitMs));

      const chk = await postJSON({
        action:"check",
        modelId: MODEL_ID,
        operationName,
        deviceId: getDeviceId()
      });

      const doneUrl = chk?.downloadUrl || chk?.response?.downloadUrl;
      if(chk?.done && doneUrl) return doneUrl;

      waitMs = Math.min(maxWaitMs, Math.round(waitMs * 1.15));
    }

    return "";
  }

  async function generate(){
    if(generating) return;

    clearErrorDetail();
    getTrialStatusFromLocal();

    if(trials <= 0){ showLimitReached(); return; }

    generating = true;

    $("resultBox").style.display = "block";
    $("bar").style.width = "0%";
    $("resultNote").textContent = "";

    const maxSeconds = isImagesModeOn() ? 420 : 240;
    const startedAt = Date.now();

    startOrResumeProgress(maxSeconds, startedAt);

    try{
      const prompt = buildPrompt();

      const payload = {
        action: "generate",
        modelId: MODEL_ID,
        prompt,
        deviceId: getDeviceId()
      };

      let isImages = 0;
      if(isImagesModeOn()){
        isImages = 1;
        const startFile = requireStartImageOrThrow();
        const endFile = $("endImg")?.files?.[0] || null;

        const startB64 = await fileToB64(startFile);
        payload.inputMode = "images";
        payload.i2v = { start: { mime: startFile.type || "image/jpeg", b64: startB64 } };

        if(endFile){
          const endB64 = await fileToB64(endFile);
          payload.i2v.end = { mime: endFile.type || "image/jpeg", b64: endB64 };
        }
      }

      const gen = await postJSON(payload);
      consumeOneTrial();

      const operationName = gen.operationName || gen.name;

      if(gen.done && gen.downloadUrl){
        clearPendingOp();
        clearPendingMeta();
        onGenerated(gen.downloadUrl);
        return;
      }

      if(!operationName) throw new Error((currentLang==="ar") ? "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©." : "No operation id returned.");

      savePendingOp({ operationName, createdAt: startedAt, modelId: MODEL_ID, deviceId: getDeviceId() });
      savePendingMeta({ operationName, createdAt: startedAt, isImages });

      const doneUrl = await pollForResult(operationName);
      if(!doneUrl){
        $("timerText").textContent = (currentLang==="ar") ? i18n.ar.longer : i18n.en.longer;
        $("bar").style.width = "95%";
        return;
      }

      clearPendingOp();
      clearPendingMeta();
      onGenerated(doneUrl);

    }catch(err){
      const detail = extractBackendMessage(err?.backend, err?.message, err?.httpStatus);

      if(isTrialLimitErrorMessage(detail)){
        hardLockTrialsToZero();
        showLimitReached();
      }else{
        $("timerText").textContent = (currentLang==="ar") ? i18n.ar.tryAgainSoft : i18n.en.tryAgainSoft;
        $("bar").style.width = "0%";
        showErrorDetail(detail);
      }
    }finally{
      generating = false;
    }
  }

  // buttons
  $("generateBtn").addEventListener("click", generate);

  $("copyBtn").addEventListener("click", async ()=>{
    const url = loadLastUrl();
    if(!url) return;
    try{
      await navigator.clipboard.writeText(url);
      $("resultNote").textContent = (currentLang==="ar") ? i18n.ar.copied : i18n.en.copied;
    }catch(e){
      $("resultNote").textContent = url;
    }
  });

  $("downloadBtn").addEventListener("click", ()=>{
    const url = loadLastUrl();
    if(!url) return;
    window.open(url, "_blank", "noopener");
  });

  // lang
  function applyLang(){
    const t = i18n[currentLang];
    document.body.dir = (currentLang==="ar") ? "rtl" : "ltr";

    $("langToggle").textContent = (currentLang==="ar") ? "EN" : "AR";

    $("heroTitle").innerHTML = t.heroTitle;
    $("baseLabel").textContent = t.baseLabel;
    $("lockedTag").textContent = t.locked;
    $("trialsLabel").textContent = t.trialsLabel;
    $("selectedLabel").textContent = t.selectedDemo;
    $("playTxt").textContent = t.play;
    $("modeLabel").textContent = t.modeLabel;
    $("modeTextTxt").textContent = t.modeText;
    $("modeImgTxt").textContent = t.modeImg;

    $("lblSubject").textContent = t.lblSubject;
    $("lblLocation").textContent = t.lblLocation;
    $("lblTwist").textContent = t.lblTwist;
    $("lblImages").textContent = t.lblImages;
    $("hintImages").textContent = t.hintImages;

    $("subject").placeholder = t.phSubject;
    $("location").placeholder = t.phLocation;
    $("twist").placeholder = t.phTwist;

    $("genTxt").textContent = t.gen;
    $("dlTxt").textContent = t.dl;
    $("copyTxt").textContent = t.copy;

    $("saveWarn").textContent = t.saveWarn;

    setBrandUI(brandCfg || FALLBACK_BRANDS.shaga3);
    renderBasePrompt();

    getTrialStatusFromLocal();
    renderThumbs();
    setSelected(selectedIndex);
  }

  $("langToggle").addEventListener("click", ()=>{
    currentLang = (currentLang === "en") ? "ar" : "en";
    applyLang();
  });

  // init
  async function init(){
    const brandId = getBrandFromUrl();
    brandCfg = await loadBrandConfig(brandId);
    applyTheme(brandCfg.theme);
    setBrandUI(brandCfg);

    items = [...(brandCfg.demos || [])];
    selectedIndex = 0;
    renderBasePrompt();
    renderThumbs();
    setSelected(0);

    getTrialStatusFromLocal();

    // resume pending with % progress
    const pending = loadPendingOp();
    const meta = loadPendingMeta();

    if(pending?.operationName && pending?.createdAt){
      $("resultBox").style.display = "block";
      const maxSeconds = (meta?.isImages ? 420 : 240);
      startOrResumeProgress(maxSeconds, pending.createdAt);

      generating = true;
      try{
        const doneUrl = await pollForResult(pending.operationName);
        if(doneUrl){
          clearPendingOp();
          clearPendingMeta();
          onGenerated(doneUrl);
        }else{
          $("timerText").textContent = (currentLang==="ar") ? i18n.ar.stillWorking : i18n.en.stillWorking;
        }
      }catch(e){
        // keep pending so refresh can continue
        $("timerText").textContent = (currentLang==="ar") ? i18n.ar.stillWorking : i18n.en.stillWorking;
      }finally{
        generating = false;
      }
    }else{
      const lastUrl = loadLastUrl();
      if(lastUrl){
        $("resultBox").style.display = "block";
        $("bar").style.width = "100%";
        setReadyText();
      }
    }

    applyLang();
  }

  init();
</script>
</body>
</html>
