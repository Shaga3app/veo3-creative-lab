<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Creative Lab</title>
  <style>
    :root{
      --bg:#0b0f18;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.08);
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 900px at 30% -10%, rgba(91,92,255,.25), transparent 55%),
                  radial-gradient(900px 700px at 80% 10%, rgba(34,197,94,.12), transparent 50%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    .wrap{max-width:820px;margin:0 auto;padding:18px 16px 36px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:10px;margin-bottom:12px;flex-wrap:wrap;
    }
    .title{
      font-weight:700;letter-spacing:.2px;
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;
      border:1px solid var(--line);color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .topRight{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      justify-content:flex-end;margin-left:auto;
    }
    .langBtn{
      font-size:12px;padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);color:var(--text);
      background: rgba(255,255,255,.06);
      font-weight:800;cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }

    .sectionLabel{
      margin:14px 0 8px;
      font-size:12px;color:var(--muted);
      letter-spacing:.14em;text-transform:uppercase;
    }

    .modeBar{
      display:flex;gap:10px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      overflow:hidden;
      flex-wrap:wrap;
    }
    .modeBtn{
      flex:1 1 180px;
      display:flex;align-items:center;justify-content:center;gap:8px;
      padding:10px;border-radius:12px;
      border:1px solid transparent;
      color:var(--muted);
      background:transparent;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      min-width:150px;
    }
    .modeBtn .ico{font-size:16px;opacity:.9}
    .modeBtn.on{
      background: rgba(91,92,255,.22);
      border-color: rgba(91,92,255,.45);
      color: var(--text);
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:720px){
      .grid{grid-template-columns:1fr 1fr;}
      .span2{grid-column:1/-1;}
    }

    .field{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      min-width:0;
      position:relative;
    }
    .field label{
      display:block;
      font-size:13px;
      color:var(--text);
      margin-bottom:8px;
      opacity:.9;
    }
    .field input, .field textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;
      padding:12px;
      outline:none;
      font-size:15px;
      min-width:0;
    }
    .field textarea{min-height:92px;resize:vertical}
    .hint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35;}

    /* LOCKED base prompt styling */
    .lockedTag{
      position:absolute;
      top:10px;
      right:10px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      pointer-events:none;
    }
    body[dir="rtl"] .lockedTag{right:auto;left:10px;}

    textarea[readonly]{
      opacity:.92;
      filter:saturate(.95);
      cursor:not-allowed;
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:0;}
    .btn{
      border:none;border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      color:#07120a;
      background: linear-gradient(180deg, rgba(34,197,94,1), rgba(34,197,94,.85));
      display:inline-flex;align-items:center;gap:10px;
      -webkit-tap-highlight-color:transparent;
      max-width:100%;
    }
    .btn.secondary{
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-weight:700;
      text-decoration:none;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .small{font-size:12px;color:var(--muted);word-break:break-word;}

    .result{
      margin-top:12px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:none;
    }
    .resultTop{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .progress{
      height:10px;border-radius:999px;overflow:hidden;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .bar{
      height:100%;width:0%;
      background: linear-gradient(90deg, rgba(91,92,255,.9), rgba(34,197,94,.9));
      transition: width .25s ease;
    }
    video{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:#000;
      display:none;
    }

    .saved{margin-top:14px;border-top:1px dashed var(--line);padding-top:14px;}
    .attempts{display:flex;flex-direction:column;gap:10px;}
    .attempt{
      background: rgba(0,0,0,.14);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .attempt .meta{min-width:0;flex:1 1 220px;}
    .attempt .meta .t{
      font-size:13px;font-weight:800;margin-bottom:4px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .attempt .meta .s{
      font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .attempt .actions{display:flex;gap:8px;align-items:center;flex:0 0 auto;}
    .iconBtn{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      -webkit-tap-highlight-color:transparent;
    }

    .hidden{display:none !important;}

    /* Arabic mode */
    body[dir="rtl"] .sectionLabel{letter-spacing:.08em}
    body[dir="rtl"] .topRight{margin-left:0;margin-right:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">
          <span id="appTitle">Creative Lab</span>
          <span class="badge" id="betaBadge">Demo/Beta</span>
        </div>

        <div class="topRight">
          <button class="langBtn" id="langToggle" type="button">AR</button>
          <div class="badge" id="trialsBadge"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">2</b></div>
        </div>
      </div>

      <div class="sectionLabel" id="lblBaseSection">Your base prompt</div>
      <div class="field">
        <div class="lockedTag"><span>üîí</span><span id="lockedTxt">Locked</span></div>
        <label id="lblBase">Base prompt</label>
        <!-- LOCKED -->
        <textarea id="basePrompt" readonly></textarea>
        <div class="hint" id="hintBase">Tip: Keep this stable. We‚Äôll inject the user details below.</div>
      </div>

      <div class="sectionLabel" id="lblModeSection">Choose input mode</div>
      <div class="modeBar" role="tablist" aria-label="Input mode">
        <button class="modeBtn on" id="modeText" type="button" aria-selected="true">
          <span class="ico">üìù</span> <span id="modeTextLbl">Text prompt</span>
        </button>
        <button class="modeBtn" id="modeImages" type="button" aria-selected="false">
          <span class="ico">üñºÔ∏è</span> <span id="modeImagesLbl">Start + End images</span>
        </button>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="field">
          <label id="lblSubject">Main subject / character</label>
          <input id="subject" />
        </div>

        <div class="field">
          <label id="lblLocation">Location / environment</label>
          <input id="location" />
        </div>

        <div class="field span2" id="extraBox">
          <label id="lblTwist">Extra creative twist (optional)</label>
          <input id="twist" />
        </div>

        <div class="field span2 hidden" id="imagesBox">
          <label id="lblImages">Start + End images</label>
          <div class="row">
            <input id="startImg" type="file" accept="image/*" />
            <input id="endImg" type="file" accept="image/*" />
          </div>
          <div class="hint" id="hintImages">These stay on your device for demo. Later you can send them to your backend API.</div>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;" id="hintEditable">
        These fields are the only editable parts. The base concept above stays fixed.
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="generateBtn" type="button">‚ñ∂ <span id="btnGenerate">Generate video</span></button>
        <button class="btn secondary" id="saveBtn" type="button"><span id="btnSave">Save this attempt</span></button>
        <span class="small" id="status"></span>
      </div>

      <!-- Result + Download area -->
      <div class="result" id="resultBox">
        <div class="resultTop">
          <div class="pill" id="resultPill">Generating‚Ä¶</div>
          <div class="small" id="timerText">~10s</div>
        </div>

        <div class="progress" aria-label="progress">
          <div class="bar" id="bar"></div>
        </div>

        <div style="margin-top:10px;">
          <video id="video" controls playsinline></video>
        </div>

        <div class="row" style="margin-top:10px;">
          <a class="btn secondary hidden" id="downloadBtn" href="#" download="result.mp4">‚¨á <span id="btnDownload">Download video</span></a>
          <button class="btn secondary hidden" id="copyPromptBtn" type="button"><span id="btnCopy">Copy final prompt</span></button>
        </div>

        <div class="hint hidden" id="demoWarn"></div>
      </div>

      <!-- Saved Attempts area -->
      <div class="saved">
        <div class="sectionLabel" id="lblSaved">Saved attempts</div>
        <div class="small" id="savedInfo">These are stored only in your browser (local to this device).</div>
        <div class="attempts" id="attempts"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const state = {
    mode: "text",
    trialsLeft: 2,     // ‚úÖ limit to 2 total
    generating: false,
    lang: "en",
    lastVideoURL: null
  };

  const STORAGE_KEY = "creative_lab_attempts_v1";
  const LANG_KEY = "creative_lab_lang_v1";

  // ‚úÖ Locked base prompt content (change this ONLY from code)
  const LOCKED_BASE_PROMPT_EN =
`Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich realistic lighting. The scene follows this concept, and we will inject the user details below.`;
  const LOCKED_BASE_PROMPT_AR =
`ÿ£ŸÜÿ¥ÿ¶ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä 9:16 ŸÖÿØÿ™Ÿá 5‚Äì8 ÿ´ŸàÿßŸÜŸç ÿ®ÿ≠ÿ±ŸÉÿßÿ™ ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© ÿ∫ŸÜŸäÿ©. Ÿáÿ∞ÿß ŸáŸà ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿå Ÿàÿ≥ŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑÿ£ÿ≥ŸÅŸÑ.`;

  const i18n = {
    en: {
      appTitle: "Creative Lab",
      betaBadge: "Demo/Beta",
      trialsLabel: "Trials left:",
      locked: "Locked",
      baseSection: "Your base prompt",
      baseLabel: "Base prompt",
      baseHint: "Tip: Keep this stable. We‚Äôll inject the user details below.",
      modeSection: "Choose input mode",
      modeText: "Text prompt",
      modeImages: "Start + End images",
      subject: "Main subject / character",
      location: "Location / environment",
      twist: "Extra creative twist (optional)",
      images: "Start + End images",
      imagesHint: "These stay on your device for demo. Later you can send them to your backend API.",
      editableHint: "These fields are the only editable parts. The base concept above stays fixed.",
      btnGenerate: "Generate video",
      btnSave: "Save this attempt",
      btnDownload: "Download video",
      btnCopy: "Copy final prompt",
      savedTitle: "Saved attempts",
      savedInfo: "These are stored only in your browser (local to this device).",
      emptySaved: "No saved attempts yet.",
      statusSaved: "Saved.",
      statusGenerating: "Generating‚Ä¶",
      statusDone: "Ready.",
      statusNoTrials: "No trials left.",
      statusCopied: "Final prompt copied.",
      statusCopyFail: "Copy failed (permissions).",
      pillGenerating: "Generating‚Ä¶",
      pillReady: "Ready",
      phSubject: "e.g. A young Egyptian filmmaker after a workout",
      phLocation: "e.g. Rooftop gym in Cairo at sunset",
      phTwist: "e.g. Smooth dolly-in shot, slow motion at the end...",
      demoWarn: "Your browser couldn‚Äôt generate a demo MP4. You can still connect your real backend video URL later."
    },
    ar: {
      appTitle: "ÿßŸÑŸÖÿπŸÖŸÑ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸä",
      betaBadge: "ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä / ÿ®Ÿäÿ™ÿß",
      trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
      locked: "ŸÖŸÇŸÅŸàŸÑ",
      baseSection: "ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä",
      baseLabel: "ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä",
      baseHint: "ŸÜÿµŸäÿ≠ÿ©: ÿÆŸÑŸäŸá ÿ´ÿßÿ®ÿ™. ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.",
      modeSection: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
      modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
      modeImages: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
      subject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
      location: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
      twist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
      images: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
      imagesHint: "ŸÑŸÑŸÄDemo ŸÅŸÇÿ∑: ÿßŸÑÿµŸàÿ± ÿ™ÿ∏ŸÑ ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ. ŸÑÿßÿ≠ŸÇŸãÿß ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ÿ≥ÿßŸÑŸáÿß ŸÑŸÑŸÄAPI.",
      editableHint: "Ÿáÿ∞Ÿá ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÅŸÇÿ∑ ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ. ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ÿ´ÿßÿ®ÿ™.",
      btnGenerate: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
      btnSave: "ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©",
      btnDownload: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà",
      btnCopy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿä",
      savedTitle: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©",
      savedInfo: "ÿ™Ÿèÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäŸãÿß ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸÇÿ∑ (ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠).",
      emptySaved: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ®ÿπÿØ.",
      statusSaved: "ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏.",
      statusGenerating: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶",
      statusDone: "ÿ¨ÿßŸáÿ≤.",
      statusNoTrials: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÖÿ™ÿ®ŸÇŸäÿ©.",
      statusCopied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿä.",
      statusCopyFail: "ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ (ÿµŸÑÿßÿ≠Ÿäÿßÿ™).",
      pillGenerating: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶",
      pillReady: "ÿ¨ÿßŸáÿ≤",
      phSubject: "ŸÖÿ´ÿßŸÑ: ŸÖÿÆÿ±ÿ¨ ŸÖÿµÿ±Ÿä ÿ¥ÿßÿ® ÿ®ÿπÿØ ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ",
      phLocation: "ŸÖÿ´ÿßŸÑ: ÿ¨ŸäŸÖ ÿπŸÑŸâ ÿ±ŸàŸÅ ŸÅŸä ÿßŸÑŸÇÿßŸáÿ±ÿ© ŸàŸÇÿ™ ÿßŸÑÿ∫ÿ±Ÿàÿ®",
      phTwist: "ŸÖÿ´ÿßŸÑ: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© + ÿ≥ŸÑŸà ŸÖŸàÿ¥ŸÜ ŸÅŸä ÿßŸÑŸÜŸáÿßŸäÿ©...",
      demoWarn: "ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑŸÖ ŸäŸÇÿØÿ± ŸäŸàŸÑŸëÿØ ŸÅŸäÿØŸäŸà MP4 ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä. ÿ™ŸÇÿØÿ± ÿ™ÿ±ÿ®ÿ∑ ŸÅŸäÿØŸäŸà ÿßŸÑÿ®ÿßŸÉ-ÿ•ŸÜÿØ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÑÿßÿ≠ŸÇŸãÿß."
    }
  };

  function toArabicDigits(s){
    const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
    return String(s).replace(/[0-9]/g, d => map[d]);
  }

  function formatSeconds(n){
    if(state.lang === "ar") return toArabicDigits(`${n} ÿ´`);
    return `~${n}s`;
  }

  function loadAttempts(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch(e){ return []; }
  }
  function saveAttempts(list){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function setMode(mode){
    state.mode = mode;
    const isText = mode === "text";
    $("modeText").classList.toggle("on", isText);
    $("modeImages").classList.toggle("on", !isText);
    $("modeText").setAttribute("aria-selected", String(isText));
    $("modeImages").setAttribute("aria-selected", String(!isText));
    $("imagesBox").classList.toggle("hidden", isText);
    $("extraBox").classList.toggle("hidden", !isText);
  }

  function applyLang(lang){
    state.lang = lang;
    localStorage.setItem(LANG_KEY, lang);

    const t = i18n[lang];
    $("appTitle").textContent = t.appTitle;
    $("betaBadge").textContent = t.betaBadge;
    $("trialsLabel").textContent = t.trialsLabel;
    $("lockedTxt").textContent = t.locked;

    $("lblBaseSection").textContent = t.baseSection;
    $("lblBase").textContent = t.baseLabel;
    $("hintBase").textContent = t.baseHint;

    $("lblModeSection").textContent = t.modeSection;
    $("modeTextLbl").textContent = t.modeText;
    $("modeImagesLbl").textContent = t.modeImages;

    $("lblSubject").textContent = t.subject;
    $("lblLocation").textContent = t.location;
    $("lblTwist").textContent = t.twist;
    $("lblImages").textContent = t.images;
    $("hintImages").textContent = t.imagesHint;
    $("hintEditable").textContent = t.editableHint;

    $("btnGenerate").textContent = t.btnGenerate;
    $("btnSave").textContent = t.btnSave;
    $("btnDownload").textContent = t.btnDownload;
    $("btnCopy").textContent = t.btnCopy;

    $("lblSaved").textContent = t.savedTitle;
    $("savedInfo").textContent = t.savedInfo;

    $("subject").placeholder = t.phSubject;
    $("location").placeholder = t.phLocation;
    $("twist").placeholder = t.phTwist;

    // ‚úÖ locked base prompt changes by language (but still locked)
    $("basePrompt").value = (lang === "ar") ? LOCKED_BASE_PROMPT_AR : LOCKED_BASE_PROMPT_EN;

    document.body.dir = (lang === "ar") ? "rtl" : "ltr";
    document.documentElement.lang = (lang === "ar") ? "ar" : "en";
    $("langToggle").textContent = (lang === "ar") ? "EN" : "AR";

    // refresh timer display
    $("timerText").textContent = formatSeconds(10);
  }

  function setTrials(n){
    state.trialsLeft = Math.max(0, n);
    $("trialsLeft").textContent = String(state.trialsLeft);
  }

  function showResultBox(show){
    $("resultBox").style.display = show ? "block" : "none";
  }

  function resetResultUI(){
    $("bar").style.width = "0%";
    $("resultPill").textContent = i18n[state.lang].pillGenerating;
    $("timerText").textContent = formatSeconds(10);
    $("video").style.display = "none";
    $("video").removeAttribute("src");
    $("downloadBtn").classList.add("hidden");
    $("copyPromptBtn").classList.add("hidden");
    $("demoWarn").classList.add("hidden");
    $("demoWarn").textContent = "";
  }

  function buildFinalPrompt(){
    const base = ($("basePrompt").value || "").trim();
    const subject = ($("subject").value || "").trim();
    const location = ($("location").value || "").trim();
    const twist = ($("twist").value || "").trim();

    const modeNote = state.mode === "images"
      ? "Input mode: Start+End images (use provided reference images)."
      : "Input mode: Text prompt only.";

    let final = base;
    if(final && !final.endsWith(".")) final += ".";
    final += `\n\n${modeNote}\nMain subject: ${subject || "N/A"}\nLocation: ${location || "N/A"}`;
    if(state.mode === "text" && twist) final += `\nExtra twist: ${twist}`;
    return final.trim();
  }

  // ‚úÖ Create REAL demo video (tries MP4 first, then WebM fallback)
  async function createDemoVideoBlob(finalPrompt){
    const canvas = document.createElement("canvas");
    canvas.width = 720;
    canvas.height = 1280;
    const ctx = canvas.getContext("2d");

    const stream = canvas.captureStream(30);

    // Try best mime types (iOS may support MP4, if not fallback)
    const candidates = [
      "video/mp4;codecs=avc1.42E01E,mp4a.40.2",
      "video/mp4",
      "video/webm;codecs=vp8",
      "video/webm"
    ];
    const mimeType = candidates.find(t => (window.MediaRecorder && MediaRecorder.isTypeSupported(t)));

    if(!mimeType) throw new Error("No supported MediaRecorder mimeType.");

    const rec = new MediaRecorder(stream, { mimeType });
    const chunks = [];

    rec.ondataavailable = (e) => { if(e.data && e.data.size) chunks.push(e.data); };

    const durationMs = 1200; // short demo clip
    const start = performance.now();

    // draw frames
    function drawFrame(now){
      const t = (now - start) / durationMs;
      const p = Math.min(1, Math.max(0, t));

      // background
      ctx.fillStyle = "#0b0f18";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // subtle glow
      const g = ctx.createRadialGradient(180, 200, 0, 180, 200, 900);
      g.addColorStop(0, "rgba(91,92,255,0.25)");
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // title
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "700 54px system-ui, -apple-system, Segoe UI, Arial";
      ctx.fillText(state.lang === "ar" ? "ÿßŸÑŸÖÿπŸÖŸÑ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸä" : "Creative Lab", 48, 120);

      // bar
      const barW = Math.round((canvas.width - 96) * p);
      ctx.fillStyle = "rgba(255,255,255,0.12)";
      ctx.fillRect(48, 180, canvas.width - 96, 18);
      ctx.fillStyle = "#22c55e";
      ctx.fillRect(48, 180, barW, 18);

      // prompt snippet
      const snippet = finalPrompt.slice(0, 220).replace(/\s+/g," ").trim();
      ctx.fillStyle = "rgba(229,231,235,0.9)";
      ctx.font = "400 28px system-ui, -apple-system, Segoe UI, Arial";
      wrapText(ctx, snippet || "‚Äî", 48, 260, canvas.width - 96, 36, 8);

      // footer
      ctx.fillStyle = "rgba(148,163,184,0.9)";
      ctx.font = "500 24px system-ui, -apple-system, Segoe UI, Arial";
      const foot = state.lang === "ar" ? "ŸÅŸäÿØŸäŸà ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä" : "Demo Video";
      ctx.fillText(foot, 48, canvas.height - 70);

      if(p < 1) requestAnimationFrame(drawFrame);
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines){
      const words = text.split(" ");
      let line = "";
      let lines = 0;
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + " ";
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && n > 0){
          ctx.fillText(line, x, y);
          line = words[n] + " ";
          y += lineHeight;
          lines++;
          if(lines >= maxLines) break;
        } else {
          line = testLine;
        }
      }
      if(lines < maxLines) ctx.fillText(line, x, y);
    }

    // start recording
    rec.start(200);
    requestAnimationFrame(drawFrame);

    await new Promise((resolve) => {
      setTimeout(() => {
        rec.stop();
        resolve();
      }, durationMs + 250);
    });

    await new Promise((resolve) => {
      rec.onstop = resolve;
    });

    const blob = new Blob(chunks, { type: mimeType });
    return { blob, mimeType };
  }

  async function fakeGenerate(){
    state.generating = true;
    $("status").textContent = i18n[state.lang].statusGenerating;
    showResultBox(true);
    resetResultUI();

    const totalMs = 10000; // ‚úÖ 10 seconds loader
    const start = Date.now();

    const tick = () => {
      const elapsed = Date.now() - start;
      const pct = Math.min(100, Math.round((elapsed / totalMs) * 100));
      $("bar").style.width = pct + "%";
      const remain = Math.max(0, Math.round((totalMs - elapsed) / 1000));
      $("timerText").textContent = remain ? formatSeconds(remain) : (state.lang === "ar" ? "ÿ™ŸÖ" : "Done");
      if(elapsed < totalMs) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);

    await new Promise(r => setTimeout(r, totalMs));

    const finalPrompt = buildFinalPrompt();

    $("resultPill").textContent = i18n[state.lang].pillReady;
    $("status").textContent = i18n[state.lang].statusDone;

    $("copyPromptBtn").classList.remove("hidden");

    // ‚úÖ Create playable + downloadable demo video
    try{
      const { blob, mimeType } = await createDemoVideoBlob(finalPrompt);

      if(state.lastVideoURL) URL.revokeObjectURL(state.lastVideoURL);
      const url = URL.createObjectURL(blob);
      state.lastVideoURL = url;

      const v = $("video");
      v.src = url;
      v.style.display = "block";
      v.load();

      // file extension
      const ext = mimeType.includes("mp4") ? "mp4" : "webm";

      const dl = $("downloadBtn");
      dl.href = url;
      dl.setAttribute("download", `result_demo.${ext}`);
      dl.classList.remove("hidden");
    }catch(e){
      // If demo video can‚Äôt be generated on this device
      $("demoWarn").textContent = i18n[state.lang].demoWarn;
      $("demoWarn").classList.remove("hidden");
      // Still show video area hidden; download stays hidden (better than downloading text)
    }

    state.generating = false;
  }

  function renderAttempts(){
    const list = loadAttempts();
    const box = $("attempts");
    box.innerHTML = "";

    if(!list.length){
      const empty = document.createElement("div");
      empty.className = "small";
      empty.style.opacity = ".9";
      empty.textContent = i18n[state.lang].emptySaved;
      box.appendChild(empty);
      return;
    }

    list.slice(0, 10).forEach((a, idx) => {
      const row = document.createElement("div");
      row.className = "attempt";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<div class="t">${a.title}</div><div class="s">${a.subtitle}</div>`;

      const actions = document.createElement("div");
      actions.className = "actions";

      const loadBtn = document.createElement("button");
      loadBtn.className = "iconBtn";
      loadBtn.textContent = (state.lang === "ar") ? "ÿ™ÿ≠ŸÖŸäŸÑ" : "Load";
      loadBtn.onclick = () => {
        $("subject").value = a.subject || "";
        $("location").value = a.location || "";
        $("twist").value = a.twist || "";
        setMode(a.mode || "text");
        window.scrollTo({top:0, behavior:"smooth"});
      };

      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn";
      delBtn.textContent = (state.lang === "ar") ? "ÿ≠ÿ∞ŸÅ" : "Delete";
      delBtn.onclick = () => {
        const cur = loadAttempts();
        cur.splice(idx, 1);
        saveAttempts(cur);
        renderAttempts();
      };

      actions.appendChild(loadBtn);
      actions.appendChild(delBtn);
      row.appendChild(meta);
      row.appendChild(actions);
      box.appendChild(row);
    });
  }

  // events
  $("modeText").addEventListener("click", () => setMode("text"));
  $("modeImages").addEventListener("click", () => setMode("images"));

  $("langToggle").addEventListener("click", () => {
    applyLang(state.lang === "en" ? "ar" : "en");
    renderAttempts();
  });

  $("generateBtn").addEventListener("click", async () => {
    if(state.generating) return;
    if(state.trialsLeft <= 0){
      $("status").textContent = i18n[state.lang].statusNoTrials;
      return;
    }
    setTrials(state.trialsLeft - 1);
    await fakeGenerate();
  });

  $("saveBtn").addEventListener("click", () => {
    const subject = ($("subject").value || "").trim();
    const location = ($("location").value || "").trim();
    const twist = ($("twist").value || "").trim();

    const title = subject ? subject : (location ? location : (state.lang === "ar" ? "ŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©" : "Saved attempt"));
    const subtitle = `${(state.mode || "text").toUpperCase()} ‚Ä¢ ${location || (state.lang === "ar" ? "ÿ®ÿØŸàŸÜ ŸÖŸÉÿßŸÜ" : "No location")} ‚Ä¢ ${new Date().toLocaleString()}`;

    const attempt = { mode: state.mode, subject, location, twist, title, subtitle };
    const list = loadAttempts();
    list.unshift(attempt);
    saveAttempts(list.slice(0, 20));
    renderAttempts();
    $("status").textContent = i18n[state.lang].statusSaved;
  });

  $("copyPromptBtn").addEventListener("click", async () => {
    const text = buildFinalPrompt();
    try{
      await navigator.clipboard.writeText(text);
      $("status").textContent = i18n[state.lang].statusCopied;
    }catch(e){
      $("status").textContent = i18n[state.lang].statusCopyFail;
    }
  });

  // init
  setMode("text");
  setTrials(2);

  const savedLang = localStorage.getItem(LANG_KEY) || "en";
  applyLang(savedLang);
  renderAttempts();
</script>
</body>
</html>
