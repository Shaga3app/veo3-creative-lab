<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shaga3app ¬∑ AI Creative Playground</title>

  <style>
    :root{
      /* defaults */
      --bg:#0b0f18;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.12);
      --accent:#5b5cff;
      --accent2:#22c55e;
      --btnText:#07120a;

      --radius:18px;
      --radius2:16px;
      --shadow:0 18px 40px rgba(0,0,0,.35);

      --heroGradA: rgba(91,92,255,.25);
      --heroGradB: rgba(34,197,94,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 900px at 25% -10%, var(--heroGradA), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, var(--heroGradB), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap{max-width:900px;margin:0 auto;padding:16px 14px 36px;}
    .card{
      background:linear-gradient(180deg, var(--panel), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* top bar */
    .topBar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--panel2);
    }
    .brandLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .brandLogo{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
    }
    .brandLogo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:42vw;
      opacity:.95;
    }

    .topRight{display:flex;align-items:center;gap:10px;flex:0 0 auto;}
    .pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid color-mix(in srgb, var(--accent) 55%, transparent);
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .langBtn{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); color: var(--text);
      background: rgba(255,255,255,.06);
      font-weight:900; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* hero */
    .hero{margin:18px 0 10px}
    .hero h1{font-size:52px;line-height:1.05;margin:6px 0 8px;font-weight:950;letter-spacing:-.02em}
    .hero p{color:var(--muted);font-size:16px;max-width:560px;line-height:1.4;margin:0}

    /* sections */
    .sectionLabel{
      margin:18px 0 8px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:color-mix(in srgb, var(--muted) 85%, transparent);
    }

    /* locked prompt */
    .lockedBox{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .lockedTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .lockedTag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:800;
    }
    .lockedPrompt{
      margin-top:10px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      line-height:1.45;
      color: rgba(229,231,235,.82);
      white-space:pre-wrap;
      max-height: 160px;
      overflow:auto;
    }

    /* preview + carousel */
    .previewCard{
      margin-top:12px;
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .previewHeader{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:10px;
      color:color-mix(in srgb, var(--muted) 90%, transparent);
      font-size:12px;font-weight:800;
    }
    .badge{
      padding:5px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight:900;
      color: rgba(229,231,235,.9);
      white-space:nowrap;
    }

    .mainStage{
      position:relative;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      min-height: 320px;
      aspect-ratio: 9 / 16;
    }
    .mainStage img,
    .mainStage video{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }
    .mainStage video{
      display:none;
      background:#000;
    }
    .playOverlay{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    .playBtn{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:12px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      backdrop-filter: blur(8px);
    }

    /* carousel thumbs */
    .thumbRowWrap{
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:10px;
    }
    .thumbRow{
      display:flex;gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .thumbRow::-webkit-scrollbar{height:8px}
    .thumbRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

    .thumb{
      flex:0 0 auto;
      width:110px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      cursor:pointer;
      scroll-snap-align:start;
      position:relative;
      transition: transform .12s ease, border-color .12s ease;
    }
    .thumb:hover{transform: translateY(-1px)}
    .thumb.on{border-color: color-mix(in srgb, var(--accent2) 70%, white 0%); box-shadow:0 0 0 2px rgba(34,197,94,.12) inset;}
    .thumb img{width:100%;height:70px;object-fit:cover;display:block}
    .thumbMeta{
      padding:7px 8px 8px;
      display:flex;justify-content:space-between;align-items:center;
      gap:6px;
      font-size:11px;
      color: rgba(229,231,235,.9);
    }
    .thumbTag{
      font-size:10px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .thumbPlay{
      position:absolute;left:8px;top:8px;
      width:28px;height:28px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
    }
    .thumbDots{
      display:flex;justify-content:center;gap:6px;
      padding-top:8px;
    }
    .dot{width:6px;height:6px;border-radius:999px;background:rgba(255,255,255,.18)}
    .dot.on{background: color-mix(in srgb, var(--accent2) 80%, transparent);}

    /* mode bar */
    .modeBar{
      margin-top:14px;
      display:flex;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      background: var(--panel2);
    }
    .modeBtn{
      flex:1;
      padding:10px;
      border-radius:12px;
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer;
      font-weight:900;
    }
    .modeBtn.on{
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      color:var(--text);
    }

    /* inputs */
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}

    .field{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .field label{font-size:13px;margin-bottom:6px;display:block;font-weight:800;color:rgba(229,231,235,.92)}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .field input::placeholder{color:rgba(148,163,184,.65)}
    .miniHint{margin-top:10px;font-size:12px;color: var(--muted);line-height:1.35;opacity:.95}

    /* progress */
    .result{
      display:none;
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: var(--panel2);
    }
    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar{
      height:100%;width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
    }

    /* buttons */
    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:none;
      font-weight:950;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      width:100%;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
    }
    .btn.primary{
      background:linear-gradient(180deg, var(--accent2), color-mix(in srgb, var(--accent2) 70%, #000 30%));
      color:var(--btnText);
      border:1px solid rgba(0,0,0,.10);
    }

    /* actions under inputs */
    .actionsUnderInputs{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .actionsUnderInputs .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media(min-width:720px){
      .actionsUnderInputs .row2{max-width:520px}
      .actionsUnderInputs .primaryWrap{max-width:520px}
    }

    /* RTL tweaks */
    body[dir="rtl"] .hero h1{letter-spacing:0}
    body[dir="rtl"] .brandTitle{max-width:50vw}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <!-- Top bar -->
      <div class="topBar">
        <div class="brandLeft">
          <div class="brandLogo"><img id="brandLogo" alt="logo"></div>
          <div class="brandTitle" id="brandTitle">Shaga3app ¬∑ AI Video Lab</div>
        </div>

        <div class="topRight">
          <button class="langBtn" id="langToggle" type="button">AR</button>
          <div class="pill" id="betaPill">Beta ¬∑ Shaga3app powered</div>
        </div>
      </div>

      <!-- Hero -->
      <div class="hero">
        <h1 id="heroTitle">Play with our<br>guided video<br>prompt</h1>
        <p id="heroDesc">You get up to <b id="triesInline">2</b> tries. The core concept is fixed by us; you just add your creative twist ‚ú®</p>
      </div>

      <!-- Locked prompt -->
      <div class="sectionLabel" id="baseLabel">BASE CONCEPT (LOCKED)</div>
      <div class="lockedBox">
        <div class="lockedTop">
          <div class="lockedTag" id="lockedTag">üîí Locked</div>
          <div class="lockedTag"><span id="trialsLabel">Trials left:</span> <b id="trialsLeft">2</b></div>
        </div>
        <div class="lockedPrompt" id="basePrompt"></div>
      </div>

      <!-- Preview + Carousel -->
      <div class="previewCard">
        <div class="previewHeader">
          <div id="selectedLabel">Selected demo</div>
          <div class="badge" id="formatBadge">9:16 ‚Ä¢ 5‚Äì8s</div>
        </div>

        <div class="mainStage">
          <img id="mainPoster" alt="Selected poster" />
          <video id="mainVideo" controls playsinline preload="none"></video>

          <div class="playOverlay">
            <button class="playBtn" id="playBtn" type="button">‚ñ∂ <span id="playTxt">Play</span></button>
          </div>
        </div>

        <div class="thumbRowWrap">
          <div class="thumbRow" id="thumbRow"></div>
          <div class="thumbDots" id="thumbDots"></div>
        </div>

        <div class="miniHint" id="saveWarn" style="margin-top:10px;">
          This page does not save your generated video. Please download it or copy the link before leaving.
        </div>
      </div>

      <!-- Mode -->
      <div class="sectionLabel" id="modeLabel">CHOOSE INPUT MODE</div>
      <div class="modeBar">
        <button class="modeBtn on" id="modeText" type="button">üìù <span id="modeTextTxt">Text prompt</span></button>
        <button class="modeBtn" id="modeImages" type="button">üñºÔ∏è <span id="modeImgTxt">Start + End images</span></button>
      </div>

      <div class="field span2" id="imagesBox" style="display:none; margin-top:10px;">
        <label id="lblImages">Start + End images</label>
        <input type="file" id="startImg" accept="image/*">
        <input type="file" id="endImg" accept="image/*" style="margin-top:8px;">

        <!-- I2V previews (added) -->
        <div id="i2vPreview" style="display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column; gap:6px;">
            <div style="font-size:12px; opacity:.75;" id="startPrevLbl">Start image</div>
            <img id="startPreview" alt="start preview"
                 style="width:120px; height:120px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.12); display:none;">
          </div>

          <div style="display:flex; flex-direction:column; gap:6px;">
            <div style="font-size:12px; opacity:.75;" id="endPrevLbl">End image</div>
            <img id="endPreview" alt="end preview"
                 style="width:120px; height:120px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.12); display:none;">
          </div>
        </div>

        <div class="miniHint" id="hintImages">Upload a start frame and an end frame to guide the motion.</div>
      </div>

      <!-- Inputs -->
      <div class="grid">
        <div class="field">
          <label id="lblSubject">Main subject / character</label>
          <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
        </div>
        <div class="field">
          <label id="lblLocation">Location / environment</label>
          <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
        </div>

        <div class="field span2">
          <label id="lblTwist">Extra creative twist</label>
          <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
        </div>
      </div>

      <!-- Buttons -->
      <div class="actionsUnderInputs">
        <div class="primaryWrap">
          <button class="btn primary" id="generateBtn" type="button">‚ö° <span id="genTxt">Generate video</span></button>
        </div>
        <div class="row2">
          <button class="btn secondary" id="copyBtn" type="button">üîó <span id="copyTxt">Copy link</span></button>
          <button class="btn secondary" id="downloadBtn" type="button">‚¨á <span id="dlTxt">Download</span></button>
        </div>
      </div>

      <!-- ‚úÖ Progress/status under Copy/Download, NEVER 100% until ready -->
      <div class="result" id="resultBox">
        <div class="miniHint" id="timerText" style="display:block;margin-top:0;margin-bottom:10px;"></div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="miniHint" id="resultNote" style="margin-top:10px;"></div>
      </div>

    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);

  /* ===========================
     I2V. Store selected images + show previews (added)
  =========================== */
  let I2V_START_FILE = null;
  let I2V_END_FILE = null;

  function setPreview(imgEl, file){
    if(!imgEl) return;
    if(!file){
      imgEl.src = "";
      imgEl.style.display = "none";
      return;
    }
    const url = URL.createObjectURL(file);
    imgEl.src = url;
    imgEl.style.display = "block";
  }

  function initI2VInputs(){
    const startInput = $("startImg");
    const endInput = $("endImg");
    const startPreview = $("startPreview");
    const endPreview = $("endPreview");

    if(startInput){
      startInput.addEventListener("change", () => {
        I2V_START_FILE = (startInput.files && startInput.files[0]) ? startInput.files[0] : null;
        setPreview(startPreview, I2V_START_FILE);
      });
    }

    if(endInput){
      endInput.addEventListener("change", () => {
        I2V_END_FILE = (endInput.files && endInput.files[0]) ? endInput.files[0] : null;
        setPreview(endPreview, I2V_END_FILE);
      });
    }
  }

  /* ===========================
     STEP 2A . Device ID (anti-abuse)
  =========================== */
  const DEVICE_ID_KEY = "shaga3_device_id";
  function getDeviceId(){
    try{
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if(!id){
        id = "dev_" + (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random().toString(16).slice(2)));
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    }catch(e){
      return "dev_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }
  }

  /* ===========================
     ‚úÖ Trials UI persistence (client-side mirror)
     . Server is the truth (MongoDB rate limit).
     . This keeps the NUMBER consistent after refresh.
     . Resets after 24h locally.
  =========================== */
  const TRIALS_MAX = 2; // match MAX_TRIALS in Lambda (default 2)
  const TRIALS_STATE_KEY = "shaga3_trials_state_v1";
  const TRIALS_WINDOW_MS = 24 * 60 * 60 * 1000;

  function loadTrialsState(){
    try{
      const raw = localStorage.getItem(TRIALS_STATE_KEY);
      if(!raw) return { windowStart: Date.now(), used: 0 };
      const s = JSON.parse(raw);
      if(!s || typeof s.windowStart !== "number" || typeof s.used !== "number"){
        return { windowStart: Date.now(), used: 0 };
      }
      // reset if window expired
      if(Date.now() - s.windowStart >= TRIALS_WINDOW_MS){
        return { windowStart: Date.now(), used: 0 };
      }
      // clamp
      s.used = Math.max(0, Math.min(TRIALS_MAX, Math.floor(s.used)));
      return s;
    }catch(e){
      return { windowStart: Date.now(), used: 0 };
    }
  }

  function saveTrialsState(state){
    try{ localStorage.setItem(TRIALS_STATE_KEY, JSON.stringify(state)); }catch(e){}
  }

  function getTrialsLeftFromState(state){
    return Math.max(0, TRIALS_MAX - (state.used || 0));
  }

  function setTrialsLeft(n){
    trials = Math.max(0, Math.min(TRIALS_MAX, Number(n||0)));
    $("trialsLeft").textContent = (currentLang==="ar") ? toArabicDigits(String(trials)) : String(trials);
    const triesNum = (currentLang==="ar") ? toArabicDigits(String(trials)) : String(trials);
    // update hero line (keeps same template)
    const t = i18n[currentLang];
    $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;
  }

  function consumeOneTrial(){
    const s = loadTrialsState();
    s.used = Math.min(TRIALS_MAX, (s.used||0) + 1);
    saveTrialsState(s);
    setTrialsLeft(getTrialsLeftFromState(s));
  }

  function hardLockTrialsToZero(){
    const s = loadTrialsState();
    s.used = TRIALS_MAX;
    saveTrialsState(s);
    setTrialsLeft(0);
  }

  /* API settings */
  const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
  const MODEL_ID = "veo-3.1-generate-001";

  // ‚úÖ IMPORTANT: Must match Lambda env var VEO3_API_KEY exactly
  const API_KEY = "v3_9f8c2d1a_6b7c8d9e_0a1b2c3d4e5f9n5v";

  const LAST_URL_KEY = "shaga3app_last_video_url";
  const LAST_BRAND_KEY = "shaga3app_last_brand";

  /* i18n */
  const i18n = {
    en: {
      heroTitle: "Play with our<br>guided video<br>prompt",
      heroDescStart: "You get up to ",
      heroDescEnd: " tries. The core concept is fixed by us; you just add your creative twist ‚ú®",
      baseLabel: "BASE CONCEPT (LOCKED)",
      locked: "üîí Locked",
      trialsLabel: "Trials left:",
      selectedDemo: "Selected demo",
      play: "Play",
      modeLabel: "CHOOSE INPUT MODE",
      modeText: "Text prompt",
      modeImg: "Start + End images",
      lblSubject: "Main subject / character",
      lblLocation: "Location / environment",
      lblTwist: "Extra creative twist",
      lblImages: "Start + End images",
      hintImages: "Upload a start frame and an end frame to guide the motion.",
      phSubject: "Who is the main character? (age, style, wardrobe, vibe)",
      phLocation: "Where is it happening? (city, time of day, lighting, atmosphere)",
      phTwist: "Optional: camera move, mood, style, or one special detail.",
      gen: "Generate video",
      dl: "Download",
      copy: "Copy link",
      saveWarn: "This page does not save your generated video. Please download it or copy the link before leaving.",
      waiting: "Waiting for video‚Ä¶",
      ready: "Ready ‚úÖ",
      copied: "Link copied ‚úÖ",
      newTag: "New",
      demoTag: "Demo",
      limitReached: "‚ùå You reached the max trials for today. Try again tomorrow.",
      startPrev: "Start image",
      endPrev: "End image"
    },
    ar: {
      heroTitle: "ÿ¨ÿ±Ÿëÿ® ŸÖÿπÿßŸÜÿß<br>ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÅŸäÿØŸäŸà<br>ŸÖŸèŸàÿ¨ŸëŸéŸá",
      heroDescStart: "ŸÑÿØŸäŸÉ ",
      heroDescEnd: " ŸÖÿ≠ÿßŸàŸÑÿßÿ™. ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ´ÿßÿ®ÿ™ÿ©ÿõ ÿ£ŸÜÿ™ ŸÅŸÇÿ∑ ÿ£ÿ∂ŸêŸÅ ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸäÿ© ‚ú®",
      baseLabel: "ÿßŸÑŸÖŸÅŸáŸàŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä (ŸÖŸÇŸÅŸàŸÑ)",
      locked: "üîí ŸÖŸÇŸÅŸàŸÑ",
      trialsLabel: "ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:",
      selectedDemo: "ÿßŸÑÿØŸäŸÖŸà ÿßŸÑŸÖÿÆÿ™ÿßÿ±",
      play: "ÿ™ÿ¥ÿ∫ŸäŸÑ",
      modeLabel: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ",
      modeText: "ŸÜÿµ ŸÅŸÇÿ∑",
      modeImg: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
      lblSubject: "ÿßŸÑÿ¥ÿÆÿµŸäÿ© / ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä",
      lblLocation: "ÿßŸÑŸÖŸÉÿßŸÜ / ÿßŸÑÿ®Ÿäÿ¶ÿ©",
      lblTwist: "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ®ÿØÿßÿπŸäÿ©",
      lblImages: "ÿµŸàÿ±ÿ™ÿßŸÜ: ÿ®ÿØÿßŸäÿ© + ŸÜŸáÿßŸäÿ©",
      hintImages: "ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ŸÑÿ™Ÿàÿ¨ŸäŸá ÿßŸÑÿ≠ÿ±ŸÉÿ©.",
      phSubject: "ŸÖŸäŸÜ ÿßŸÑÿ®ÿ∑ŸÑÿü (ÿ≥ŸÜ/ÿ≥ÿ™ÿßŸäŸÑ/ŸÖŸÑÿßÿ®ÿ≥/ÿ•ÿ≠ÿ≥ÿßÿ≥ ÿπÿßŸÖ)",
      phLocation: "ÿ£ŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜÿü (ŸÖÿØŸäŸÜÿ©/ŸàŸÇÿ™/ÿ•ÿ∂ÿßÿ°ÿ©/ÿ£ÿ¨Ÿàÿßÿ°)",
      phTwist: "ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß/ŸÖŸàÿØ/ÿ≥ÿ™ÿßŸäŸÑ/ÿ™ŸÅÿµŸäŸÑÿ© ŸÖŸÖŸäÿ≤ÿ©.",
      gen: "ÿ™ŸàŸÑŸäÿØ ŸÅŸäÿØŸäŸà",
      dl: "ÿ™ÿ≠ŸÖŸäŸÑ",
      copy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
      saveWarn: "ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿß ÿ™ÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑŸÅŸäÿØŸäŸà ÿßŸÑŸÜÿßÿ™ÿ¨. ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ≠ŸÖŸëŸÑ ÿßŸÑŸÅŸäÿØŸäŸà ÿ£Ÿà ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨.",
      waiting: "ÿ®ŸÜÿ≥ÿ™ŸÜŸâ ÿßŸÑŸÅŸäÿØŸäŸà‚Ä¶",
      ready: "ÿ¨ÿßŸáÿ≤ ‚úÖ",
      copied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ",
      newTag: "ÿ¨ÿØŸäÿØ",
      demoTag: "ÿØŸäŸÖŸà",
      limitReached: "‚ùå ŸàÿµŸÑÿ™ ŸÑŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÜŸáÿßÿ±ÿØÿ©. ÿ¨ÿ±Ÿëÿ® ÿ®ŸÉÿ±ÿ©.",
      startPrev: "ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©",
      endPrev: "ÿµŸàÿ±ÿ© ÿßŸÑŸÜŸáÿßŸäÿ©"
    }
  };

  function toArabicDigits(str){
    const map = {"0":"Ÿ†","1":"Ÿ°","2":"Ÿ¢","3":"Ÿ£","4":"Ÿ§","5":"Ÿ•","6":"Ÿ¶","7":"Ÿß","8":"Ÿ®","9":"Ÿ©"};
    return String(str).replace(/[0-9]/g, d => map[d]);
  }

  let currentLang = "en";

  /* Brand config */
  function getBrandFromUrl(){
    const u = new URL(location.href);
    const b = (u.searchParams.get("brand") || "").trim().toLowerCase();
    if(b) return b;
    try{
      const last = localStorage.getItem(LAST_BRAND_KEY);
      if(last) return last;
    }catch(e){}
    return "shaga3";
  }

  const FALLBACK_BRANDS = {
    shaga3: {
      id:"shaga3",
      title_en:"Shaga3app ¬∑ AI Creative Playground",
      title_ar:"ÿ¥ÿ¨Ÿëÿπ 3 ÿ¢ÿ® ¬∑ ŸÖŸÑÿπÿ® ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
      beta_en:"Beta ¬∑ Shaga3app powered",
      beta_ar:"ÿ®Ÿäÿ™ÿß ¬∑ ÿ®ÿØÿπŸÖ Shaga3app",
      logo:"assets/brand-logos/shaga3app.png",
      theme:{
        bg:"#0b0f18",
        accent:"#5b5cff",
        accent2:"#22c55e",
        heroGradA:"rgba(91,92,255,.25)",
        heroGradB:"rgba(34,197,94,.12)"
      },
      basePrompt_en:
`BASE (LOCKED)
Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
Include an ultra-realistic Coca-Cola can and an Egyptian flag in the scene, naturally integrated (not placed/fake).
The scene follows this base concept, and we will inject the user details below.`,
      basePrompt_ar:
`ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)
ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© Ÿàÿ∫ŸÜŸäÿ©.
ŸÑÿßÿ≤ŸÖ Ÿäÿ∏Ÿáÿ± ÿπŸÑÿ®ÿ© ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ŸàÿßŸÇÿπŸäÿ© ÿ¨ÿØŸãÿß ŸàÿπŸÑŸÖ ŸÖÿµÿ± ÿ¨ŸàŸëŸá ÿßŸÑŸÖÿ¥ŸáÿØ . ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä ŸàŸÖÿ™ŸÜÿßÿ≥ŸÇÿå ŸÖŸÜ ÿ∫Ÿäÿ± ŸÖÿß Ÿäÿ®ÿßŸÜŸàÿß ŸÖÿ™ÿ≠ÿ∑ŸëŸäŸÜ ŸÉÿØŸá ÿ£Ÿà ŸÅŸäŸÉ.
ÿßŸÑŸÖÿ¥ŸáÿØ ŸÖÿßÿ¥Ÿä ÿπŸÑŸâ ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿØŸäÿå Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.`,
      demos: demoPack("purple")
    },
    cocacola: {
      id:"cocacola",
      title_en:"Coca-Cola ¬∑ AI Video Lab",
      title_ar:"ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ¬∑ AI Video Lab",
      beta_en:"Demo ¬∑ Coca-Cola",
      beta_ar:"ÿØŸäŸÖŸà ¬∑ ŸÉŸàŸÉÿßŸÉŸàŸÑÿß",
      logo:"assets/brand-logos/cocacola.png",
      theme:{
        bg:"#12070a",
        accent:"#e11d2e",
        accent2:"#ffb000",
        heroGradA:"rgba(225,29,46,.22)",
        heroGradB:"rgba(255,176,0,.10)"
      },
      basePrompt_en:
`BASE (LOCKED)
Create a vertical 9:16 cinematic video, 5‚Äì8 seconds long, with smooth camera moves and rich, realistic lighting.
The scene must feature an ultra-realistic Coca-Cola can naturally integrated (not placed/fake).
Keep it premium, cinematic, and believable. We will inject user details below.`,
      basePrompt_ar:
`ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)
ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© Ÿàÿ∫ŸÜŸäÿ©.
ŸÑÿßÿ≤ŸÖ Ÿäÿ∏Ÿáÿ± ÿπŸÑÿ®ÿ© ŸÉŸàŸÉÿßŸÉŸàŸÑÿß ŸàÿßŸÇÿπŸäÿ© ÿ¨ÿØŸãÿß ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ¥ŸáÿØ ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä (ŸÖÿ¥ ŸÖÿ™ÿ≠ÿ∑Ÿàÿ∑Ÿá ŸÉÿØŸá).
ÿßŸÑŸÖÿ¥ŸáÿØ Ÿäÿ®ŸÇŸâ ÿ®ÿ±ŸäŸÖŸäŸàŸÖ Ÿàÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ŸàŸÖŸÇŸÜÿπ. Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.`,
      demos: demoPack("red")
    },
    tui: {
      id:"tui",
      title_en:"TUI ¬∑ AI Video Lab",
      title_ar:"TUI ¬∑ AI Video Lab",
      beta_en:"Demo ¬∑ TUI",
      beta_ar:"ÿØŸäŸÖŸà ¬∑ TUI",
      logo:"assets/brand-logos/tui.png",
      theme:{
        bg:"#061821",
        accent:"#2aa8ff",
        accent2:"#7fe0ff",
        heroGradA:"rgba(42,168,255,.20)",
        heroGradB:"rgba(127,224,255,.10)"
      },
      basePrompt_en:
`BASE (LOCKED)
Create a vertical 9:16 cinematic travel-style video, 5‚Äì8 seconds long, with smooth camera moves and bright, realistic lighting.
The scene should feel like a premium TUI destination moment (clean, uplifting, high-end).
We will inject user details below.`,
      basePrompt_ar:
`ÿßŸÑÿ£ÿ≥ÿßÿ≥ (ŸÖŸÇŸÅŸàŸÑ)
ÿßÿπŸÖŸÑ ŸÅŸäÿØŸäŸà ÿ≥ŸäŸÜŸÖÿßÿ¶Ÿä ÿπŸÖŸàÿØŸä Ÿ©:Ÿ°Ÿ¶ ÿ®ÿ∑ÿßÿ®ÿπ ÿ≥ŸÅÿ±/ÿ≥Ÿäÿßÿ≠ÿ©ÿå ŸÖÿØÿ™Ÿá ŸÖŸÜ Ÿ• ŸÑŸÄ Ÿ® ÿ´ŸàÿßŸÜŸäÿå ÿ®ÿ≠ÿ±ŸÉÿ© ŸÉÿßŸÖŸäÿ±ÿß ŸÜÿßÿπŸÖÿ© Ÿàÿ•ÿ∂ÿßÿ°ÿ© ŸàÿßŸÇÿπŸäÿ© ŸÖÿ¥ÿ±ŸÇÿ©.
ÿßŸÑŸÖÿ¥ŸáÿØ Ÿäÿ≠ÿ≥ÿ≥ŸÉ ÿ®ŸÑÿ≠ÿ∏ÿ© Ÿàÿ¨Ÿáÿ© ÿ≥ŸÅÿ± ÿ®ÿ±ŸäŸÖŸäŸàŸÖ ÿπŸÑŸâ ÿ≥ÿ™ÿßŸäŸÑ TUI (ŸÜÿ∂ŸäŸÅÿå ŸÖÿ®Ÿáÿ¨ÿå ÿ±ÿßŸÇŸä).
Ÿàÿ•ÿ≠ŸÜÿß ŸáŸÜÿ∂ŸäŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≠ÿ™.`,
      demos: demoPack("blue")
    }
  };

  function demoPack(color){
    const posters = [
      `https://picsum.photos/seed/${color}-a/400/700`,
      `https://picsum.photos/seed/${color}-b/400/700`,
      `https://picsum.photos/seed/${color}-c/400/700`,
      `https://picsum.photos/seed/${color}-d/400/700`,
      `https://picsum.photos/seed/${color}-e/400/700`,
      `https://picsum.photos/seed/${color}-f/400/700`,
      `https://picsum.photos/seed/${color}-g/400/700`,
      `https://picsum.photos/seed/${color}-h/400/700`,
      `https://picsum.photos/seed/${color}-i/400/700`,
      `https://picsum.photos/seed/${color}-j/400/700`
    ];
    const vids = [
      "https://samplelib.com/lib/preview/mp4/sample-5s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-10s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-5s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-10s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-5s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-10s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-5s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-10s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-5s.mp4",
      "https://samplelib.com/lib/preview/mp4/sample-10s.mp4"
    ];
    return posters.map((p, idx)=>({
      id: "demo-" + idx,
      kind: "demo",
      poster: p,
      video: vids[idx],
      tag: "demo"
    }));
  }

  async function loadBrandConfig(brandId){
    try{ localStorage.setItem(LAST_BRAND_KEY, brandId); }catch(e){}
    try{
      const r = await fetch(`brands/${brandId}.json?t=${Date.now()}`, {cache:"no-store"});
      if(r.ok){
        const txt = await r.text();
        const parsed = JSON.parse(txt);
        return normalizeBrand(parsed, brandId);
      }
    }catch(e){}
    return FALLBACK_BRANDS[brandId] || FALLBACK_BRANDS.shaga3;
  }

  function normalizeBrand(raw, brandId){
    const fb = FALLBACK_BRANDS[brandId] || FALLBACK_BRANDS.shaga3;
    const theme = raw.theme || raw.colors || {};
    const demos = Array.isArray(raw.demos) ? raw.demos : fb.demos;
    return {
      id: raw.id || brandId,
      title_en: raw.title_en || raw.title || fb.title_en,
      title_ar: raw.title_ar || fb.title_ar,
      beta_en: raw.beta_en || fb.beta_en,
      beta_ar: raw.beta_ar || fb.beta_ar,
      logo: raw.logo || fb.logo,
      theme: {
        bg: theme.bg || fb.theme.bg,
        accent: theme.accent || fb.theme.accent,
        accent2: theme.accent2 || fb.theme.accent2,
        heroGradA: theme.heroGradA || fb.theme.heroGradA,
        heroGradB: theme.heroGradB || fb.theme.heroGradB
      },
      basePrompt_en: raw.basePrompt_en || fb.basePrompt_en,
      basePrompt_ar: raw.basePrompt_ar || fb.basePrompt_ar,
      demos
    };
  }

  function applyTheme(theme){
    const root = document.documentElement.style;
    root.setProperty("--bg", theme.bg);
    root.setProperty("--accent", theme.accent);
    root.setProperty("--accent2", theme.accent2);
    root.setProperty("--heroGradA", theme.heroGradA);
    root.setProperty("--heroGradB", theme.heroGradB);
    root.setProperty("--btnText", "#07120a");
  }

  function setBrandUI(cfg){
    $("brandTitle").textContent = (currentLang === "ar") ? cfg.title_ar : cfg.title_en;
    $("betaPill").textContent = (currentLang === "ar") ? cfg.beta_ar : cfg.beta_en;

    const img = $("brandLogo");
    img.src = cfg.logo || "assets/brand-logos/shaga3app.png";
    img.onerror = () => { img.src = "assets/brand-logos/shaga3app.png"; };

    document.title = (currentLang === "ar") ? cfg.title_ar : cfg.title_en;
  }

  /* Carousel / preview */
  let brandCfg = null;
  let items = [];
  let selectedIndex = 0;

  function renderBasePrompt(){
    if(!brandCfg) return;
    $("basePrompt").textContent = (currentLang === "ar") ? brandCfg.basePrompt_ar : brandCfg.basePrompt_en;
  }

  function setSelected(index){
    selectedIndex = Math.max(0, Math.min(items.length-1, index));
    [...$("thumbRow").children].forEach((el,i)=>el.classList.toggle("on", i===selectedIndex));
    updateDots();
    showPoster(items[selectedIndex]);
  }

  function showPoster(it){
    $("mainPoster").src = it.poster || "";
    $("mainPoster").style.display = "block";

    $("mainVideo").pause();
    $("mainVideo").removeAttribute("src");
    $("mainVideo").load();
    $("mainVideo").style.display = "none";
  }

  function playInline(it){
    $("mainVideo").src = it.video;
    $("mainVideo").style.display = "block";
    $("mainPoster").style.display = "none";
    $("mainVideo").load();
    $("mainVideo").play().catch(()=>{});
  }

  function openVideoViewer(url){
    if(!url) return;
    window.open(url, "_blank", "noopener");
  }

  $("playBtn").addEventListener("click", ()=>{
    const it = items[selectedIndex];
    if(!it) return;

    if(it.kind === "new"){
      openVideoViewer(it.video);
      return;
    }
    playInline(it);
  });

  function renderThumbs(){
    const row = $("thumbRow");
    row.innerHTML = "";
    $("thumbDots").innerHTML = "";
    if(!items.length) return;

    items.forEach((it, idx)=>{
      const d = document.createElement("div");
      d.className = "thumb" + (idx===selectedIndex ? " on" : "");
      d.innerHTML = `
        <div class="thumbPlay">‚ñ∂</div>
        <img alt="poster" src="${it.poster || ""}">
        <div class="thumbMeta">
          <span class="thumbTag">${
            (currentLang==="ar")
              ? (it.kind==="new" ? i18n.ar.newTag : i18n.ar.demoTag)
              : (it.kind==="new" ? i18n.en.newTag : i18n.en.demoTag)
          }</span>
          <span style="opacity:.75">${idx+1}</span>
        </div>
      `;
      d.addEventListener("click", ()=> setSelected(idx));
      row.appendChild(d);
    });

    buildDots();
    updateDots();
  }

  function buildDots(){
    const dots = $("thumbDots");
    dots.innerHTML = "";
    const pages = Math.min(10, Math.max(1, Math.ceil(items.length / 2)));
    for(let i=0;i<pages;i++){
      const dot = document.createElement("div");
      dot.className = "dot";
      dots.appendChild(dot);
    }
  }

  function updateDots(){
    const dots = [...$("thumbDots").children];
    if(!dots.length) return;
    const page = Math.min(dots.length-1, Math.floor(selectedIndex / 2));
    dots.forEach((d,i)=>d.classList.toggle("on", i===page));
  }

  /* Mode switching */
  const imagesBox = $("imagesBox");
  $("modeText").addEventListener("click", ()=>{
    $("modeText").classList.add("on");
    $("modeImages").classList.remove("on");
    imagesBox.style.display = "none";
  });
  $("modeImages").addEventListener("click", ()=>{
    $("modeImages").classList.add("on");
    $("modeText").classList.remove("on");
    imagesBox.style.display = "block";
  });

  /* Prompt builder + API */
  function buildPrompt(){
    const base = $("basePrompt").textContent || "";
    const subject = ($("subject").value || "").trim();
    const location = ($("location").value || "").trim();
    const twist = ($("twist").value || "").trim();

    const parts = [];
    if(subject) parts.push(`Main subject: ${subject}`);
    if(location) parts.push(`Location: ${location}`);
    if(twist) parts.push(`Creative twist: ${twist}`);

    return `${base}\n\n---\n${parts.join("\n")}`.trim();
  }

  async function postJSON(payload){
    const url = API_URL + "?t=" + Date.now();
    const r = await fetch(url,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-API-KEY": API_KEY
      },
      body: JSON.stringify(payload),
    });
    const text = await r.text();
    let data;
    try{ data = JSON.parse(text); }catch(e){ data = { raw:text }; }
    if(!r.ok){
      const msg = data?.error || data?.message || data?.raw || ("HTTP " + r.status);
      throw new Error(`${msg} (HTTP ${r.status})`);
    }
    return data;
  }

  // ‚úÖ initialize trials from localStorage mirror
  let trialsState = loadTrialsState();
  let trials = getTrialsLeftFromState(trialsState);
  let generating = false;

  const LAST_URL_KEY2 = "shaga3app_last_video_url"; // keep original key name usage
  function saveLastUrl(url){
    try{ localStorage.setItem(LAST_URL_KEY2, url); }catch(e){}
  }
  function loadLastUrl(){
    try{ return localStorage.getItem(LAST_URL_KEY2) || ""; }catch(e){ return ""; }
  }

  // ‚úÖ UX: bar stays <= 95% until video is REALLY ready
  function setTimerText(secondsLeft){
    if(currentLang === "ar"){
      $("timerText").textContent =
        secondsLeft > 0
          ? `ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ŸàŸÑŸäÿØ‚Ä¶ (${toArabicDigits(secondsLeft)} ÿ´)`
          : i18n.ar.waiting;
    } else {
      $("timerText").textContent =
        secondsLeft > 0
          ? `Generating‚Ä¶ (~${secondsLeft}s)`
          : i18n.en.waiting;
    }
  }
  function setReadyText(){
    $("timerText").textContent = (currentLang==="ar") ? i18n.ar.ready : i18n.en.ready;
  }

  function showLimitReached(){
    $("resultBox").style.display = "block";
    $("bar").style.width = "0%";
    $("timerText").textContent = (currentLang==="ar") ? i18n.ar.limitReached : i18n.en.limitReached;
    $("resultNote").textContent = "";
  }

  function isTrialLimitErrorMessage(msg){
    const m = String(msg||"").toUpperCase();
    return (
      m.includes("TRIAL_LIMIT_REACHED") ||
      m.includes("LIMIT_REACHED") ||
      m.includes("HTTP 429") ||
      m.includes("(HTTP 429)") ||
      m.includes("429")
    );
  }

  async function generate(){
    if(generating) return;

    // ‚úÖ if UI says 0 trials, block immediately (prevents fake ‚Äú2‚Äù after refresh)
    if(trials <= 0){
      showLimitReached();
      return;
    }

    generating = true;

    // show progress UI (under copy/download)
    $("resultBox").style.display = "block";
    $("bar").style.width = "0%";
    $("resultNote").textContent = "";

    // show initial text immediately
    setTimerText(60);

    const maxSeconds = 60;
    const start = Date.now();
    let rafId;

    const tick = ()=>{
      const elapsed = (Date.now()-start)/1000;

      // ‚úÖ NEVER 100% while waiting ‚Äî cap at 95%
      const p = Math.min(95, (elapsed/maxSeconds)*95);
      $("bar").style.width = p + "%";

      const remain = Math.max(0, Math.ceil(maxSeconds - elapsed));
      setTimerText(remain);

      rafId = requestAnimationFrame(tick);
    };
    tick();

    try{
      const prompt = buildPrompt();

      const gen = await postJSON({
        action:"generate",
        modelId: MODEL_ID,
        prompt,
        deviceId: getDeviceId()
      });

      // ‚úÖ ONLY NOW we consume a trial locally (server accepted)
      consumeOneTrial();

      const operationName = gen.operationName || gen.name;

      // If API returns immediately ready
      if(gen.done && gen.downloadUrl){
        onGenerated(gen.downloadUrl);
        return;
      }

      if(!operationName) throw new Error("No operationName returned from generate");

      const pollEveryMs = 3000;
      const maxPolls = 25;
      let doneUrl = "";

      for(let i=0;i<maxPolls;i++){
        await new Promise(res=>setTimeout(res, pollEveryMs));

        const chk = await postJSON({
          action:"check",
          modelId: MODEL_ID,
          operationName,
          deviceId: getDeviceId()
        });

        if(chk.done && chk.downloadUrl){ doneUrl = chk.downloadUrl; break; }
        if(chk.done && chk.response && chk.response.downloadUrl){ doneUrl = chk.response.downloadUrl; break; }
      }

      if(!doneUrl) throw new Error("Still processing. Try again in a few seconds.");

      onGenerated(doneUrl);

    }catch(err){
      const msg = (err?.message || "Unknown error");

      // ‚úÖ If server says limit reached ‚Üí show Arabic/English + lock local to 0
      if(isTrialLimitErrorMessage(msg)){
        hardLockTrialsToZero();
        showLimitReached();
      }else{
        $("timerText").textContent = "Error: " + msg;
        $("bar").style.width = "0%";
      }
    }finally{
      generating = false;
      if(rafId) cancelAnimationFrame(rafId);
    }
  }

  function onGenerated(downloadUrl){
    // ‚úÖ NOW we can jump to 100%
    $("bar").style.width = "100%";
    setReadyText();

    saveLastUrl(downloadUrl);

    const newItem = {
      id: "new-" + Date.now(),
      kind: "new",
      poster: items[selectedIndex]?.poster || (brandCfg?.demos?.[0]?.poster || ""),
      video: downloadUrl,
      tag: "new"
    };

    items = items.filter(x => x.kind !== "new");
    items.unshift(newItem);

    selectedIndex = 0;
    renderThumbs();
    setSelected(0);

    $("resultNote").textContent = (currentLang==="ar")
      ? "‚úÖ ÿßÿ™ŸàŸÑÿØ ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ. ÿßÿ∂ÿ∫ÿ∑ ¬´ÿ™ÿ¥ÿ∫ŸäŸÑ¬ª ŸÑŸÖÿ¥ÿßŸáÿØÿ™Ÿá ÿ®ÿ≥ÿ±ÿπÿ©."
      : "‚úÖ New video generated. Tap ‚ÄúPlay‚Äù to open it fast.";
  }

  /* Buttons */
  $("generateBtn").addEventListener("click", generate);

  function getCurrentVideoUrl(){
    const it = items[selectedIndex];
    if(it?.video) return it.video;
    return loadLastUrl();
  }

  $("downloadBtn").addEventListener("click", ()=>{
    const url = getCurrentVideoUrl();
    if(!url) return;
    saveLastUrl(url);
    openVideoViewer(url);
  });

  $("copyBtn").addEventListener("click", async ()=>{
    const url = getCurrentVideoUrl();
    if(!url) return;
    saveLastUrl(url);
    try{
      await navigator.clipboard.writeText(url);
      alert((currentLang==="ar") ? i18n.ar.copied : i18n.en.copied);
    }catch(e){
      const msg = (currentLang==="ar") ? "ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÖŸÜ ŸáŸÜÿß:" : "Copy link from here:";
      prompt(msg, url);
    }
  });

  /* Language */
  function applyLang(lang){
    currentLang = lang;
    const t = i18n[lang];

    $("heroTitle").innerHTML = t.heroTitle;
    const triesNum = (lang === "ar") ? toArabicDigits(String(trials)) : String(trials);
    $("heroDesc").innerHTML = `${t.heroDescStart}<b id="triesInline">${triesNum}</b>${t.heroDescEnd}`;

    $("baseLabel").textContent = t.baseLabel;
    $("lockedTag").textContent = t.locked;
    $("trialsLabel").textContent = t.trialsLabel;

    $("selectedLabel").textContent = t.selectedDemo;
    $("playTxt").textContent = t.play;

    $("modeLabel").textContent = t.modeLabel;
    $("modeTextTxt").textContent = t.modeText;
    $("modeImgTxt").textContent = t.modeImg;

    $("lblSubject").textContent = t.lblSubject;
    $("lblLocation").textContent = t.lblLocation;
    $("lblTwist").textContent = t.lblTwist;
    $("lblImages").textContent = t.lblImages;
    $("hintImages").textContent = t.hintImages;

    // I2V preview labels (added)
    if($("startPrevLbl")) $("startPrevLbl").textContent = t.startPrev;
    if($("endPrevLbl")) $("endPrevLbl").textContent = t.endPrev;

    $("subject").placeholder = t.phSubject;
    $("location").placeholder = t.phLocation;
    $("twist").placeholder = t.phTwist;

    $("genTxt").textContent = t.gen;
    $("dlTxt").textContent = t.dl;
    $("copyTxt").textContent = t.copy;
    $("saveWarn").textContent = t.saveWarn;

    document.body.dir = (lang === "ar") ? "rtl" : "ltr";
    document.documentElement.lang = (lang === "ar") ? "ar" : "en";
    $("langToggle").textContent = (lang === "ar") ? "EN" : "AR";

    // keep trials numbers consistent after toggle
    $("trialsLeft").textContent = (lang==="ar") ? toArabicDigits(String(trials)) : String(trials);

    renderBasePrompt();
    renderThumbs();
    setBrandUI(brandCfg || FALLBACK_BRANDS.shaga3);
  }

  $("langToggle").addEventListener("click", () => {
    applyLang(currentLang === "en" ? "ar" : "en");
  });

  /* Boot */
  async function boot(){
    // ‚úÖ load trials from local mirror FIRST (fix refresh showing 2)
    trialsState = loadTrialsState();
    trials = getTrialsLeftFromState(trialsState);
    setTrialsLeft(trials); // updates both hero + locked box

    const brandId = getBrandFromUrl();
    brandCfg = await loadBrandConfig(brandId);

    applyTheme(brandCfg.theme);
    applyLang("en");
    setBrandUI(brandCfg);

    items = (brandCfg.demos && brandCfg.demos.length) ? brandCfg.demos.slice() : FALLBACK_BRANDS.shaga3.demos.slice();
    selectedIndex = 0;

    renderBasePrompt();
    renderThumbs();
    setSelected(0);

    // init I2V inputs after UI exists (added)
    initI2VInputs();
  }

  boot();
</script>
</body>
</html>
