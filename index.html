<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI Video Lab</title>

  <style>
    :root{
      --bg:#0b0f18;
      --panel:rgba(0,0,0,.18);
      --panel2:rgba(255,255,255,.06);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.10);
      --accent:#5b5cff;
      --ok:#22c55e;
      --shadow: 0 14px 38px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 30% -10%, color-mix(in srgb, var(--accent) 25%, transparent), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
    }

    .wrap{max-width:880px;margin:0 auto;padding:16px 14px 44px;}
    .card{
      background:linear-gradient(180deg,var(--panel2),var(--panel));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* Top bar */
    .topBar{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900;font-size:14px;
      flex:1;min-width:0;
    }
    .brandLogo{
      width:28px;height:28px;border-radius:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brandLogo img{width:100%;height:100%;object-fit:contain;display:block}

    .brandName{
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    .pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid color-mix(in srgb, var(--accent) 45%, transparent);
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      font-size:12px;font-weight:900;
      flex:0 0 auto;
      white-space:nowrap;
    }

    /* Hero */
    .hero{padding:10px 4px 6px}
    .hero h1{
      margin:12px 0 6px;
      font-size:40px;line-height:1.05;
      font-weight:950;
      letter-spacing:-.02em;
    }
    .hero p{margin:0;color:var(--muted);font-size:15px;max-width:560px}

    .label{
      margin:18px 0 8px;
      font-size:12px;
      letter-spacing:.12em;
      color:var(--muted);
      text-transform:uppercase;
    }

    /* Locked prompt box */
    .locked{
      background:rgba(0,0,0,.20);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .locked .lockedTop{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:900;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .locked pre{
      margin:0;
      padding:12px;
      border-radius:14px;
      border:2px dashed rgba(255,255,255,.14);
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      color:rgba(255,255,255,.78); /* dimmed text */
      font-size:12.5px;
      line-height:1.45;
    }

    /* Fields */
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:740px){.grid{grid-template-columns:1fr 1fr}.span2{grid-column:1/-1}}

    .field{
      background:rgba(0,0,0,.20);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
    }
    .field label{display:block;font-size:13px;font-weight:900;margin-bottom:6px;color:rgba(255,255,255,.88)}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }

    /* Video card (app-like) */
    .videoCard{
      margin-top:14px;
      background:rgba(0,0,0,.20);
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
    }

    /* MAIN PREVIEW: poster OR video */
    .preview{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
    }
    .preview img,
    .preview video{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .preview video{display:none}
    .preview .overlayTop{
      position:absolute;top:10px;left:10px;right:10px;
      display:flex;gap:8px;align-items:center;justify-content:flex-end;
      pointer-events:none;
    }
    .chip{
      pointer-events:none;
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35); /* darker so text visible */
      color:rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
    }

    /* Carousel strip */
    .stripWrap{padding:10px 10px 6px;border-top:1px solid var(--line)}
    .strip{
      display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;
      scroll-snap-type:x mandatory;
    }
    .thumb{
      flex:0 0 auto;
      width:92px;height:92px; /* square thumbnails (fast) */
      border-radius:14px;
      overflow:hidden;
      border:2px solid transparent;
      background:rgba(255,255,255,.04);
      cursor:pointer;
      scroll-snap-align:start;
      position:relative;
    }
    .thumb.selected{border-color:var(--ok)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .badge{
      position:absolute;bottom:6px;left:6px;
      font-size:11px;font-weight:900;
      padding:3px 7px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:rgba(255,255,255,.9);
      backdrop-filter: blur(8px);
    }

    /* Pagination dots */
    .dots{
      display:flex;gap:6px;justify-content:center;
      padding:6px 0 2px;
    }
    .dot{
      width:6px;height:6px;border-radius:99px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    .dot.on{
      background:color-mix(in srgb, var(--ok) 75%, rgba(255,255,255,.18));
      border-color:color-mix(in srgb, var(--ok) 55%, rgba(255,255,255,.12));
    }

    /* Generate button inside the card (not sticky) */
    .actions{
      border-top:1px solid var(--line);
      padding:12px;
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
    }
    .btn{
      border:none;
      padding:12px 16px;
      border-radius:14px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background:linear-gradient(180deg,var(--ok), color-mix(in srgb, var(--ok) 72%, #000));
      color:#07120a;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .status{
      display:none;
      padding:10px 12px;
      border-top:1px solid var(--line);
      color:rgba(255,255,255,.85);
      font-size:12.5px;
    }
    .progress{
      margin-top:8px;
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--ok))}
    .err{color:#ffb4b4}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="topBar">
        <div class="brand">
          <span class="brandLogo"><img id="brandLogo" alt="Brand logo"></span>
          <span class="brandName" id="brandTitle">AI Video Lab</span>
        </div>
        <div class="pill" id="betaText">Beta</div>
      </div>

      <div class="hero">
        <h1 id="heroTitle">AI Video Lab</h1>
        <p id="heroDesc">Pick a demo, add your twist, and generate. The result will instantly replace the main preview.</p>
      </div>

      <div class="label">BASE CONCEPT (LOCKED)</div>
      <div class="locked">
        <div class="lockedTop">
          <div class="tag">ðŸ”’ Locked</div>
          <div class="tag"><span>Trials left:</span> <b id="trialsLeft">3</b></div>
        </div>
        <pre id="basePrompt">Loadingâ€¦</pre>
      </div>

      <div class="label">YOUR INPUT</div>
      <div class="grid">
        <div class="field">
          <label>Main subject / character</label>
          <input id="subject" placeholder="Who is the main character? (age, style, wardrobe, vibe)">
        </div>
        <div class="field">
          <label>Location / environment</label>
          <input id="location" placeholder="Where is it happening? (city, time of day, lighting, atmosphere)">
        </div>
        <div class="field span2">
          <label>Extra creative twist (optional)</label>
          <input id="twist" placeholder="Optional: camera move, mood, style, or one special detail.">
        </div>
      </div>

      <div class="videoCard">
        <!-- Main preview -->
        <div class="preview">
          <img id="mainPoster" alt="Selected demo poster">
          <video id="mainVideo" controls playsinline></video>

          <div class="overlayTop">
            <div class="chip" id="chipMeta">9:16 Â· 5â€“8s</div>
          </div>
        </div>

        <!-- Carousel strip -->
        <div class="stripWrap">
          <div class="strip" id="strip"></div>
          <div class="dots" id="dots"></div>
        </div>

        <!-- Status / progress -->
        <div class="status" id="statusBox">
          <div id="statusText">Generatingâ€¦</div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button class="btn secondary" id="copyBtn" type="button">ðŸ”— Copy link</button>
          <button class="btn secondary" id="downloadBtn" type="button">â¬‡ Download</button>
          <button class="btn primary" id="generateBtn" type="button">âš¡ Generate video</button>
        </div>
      </div>

    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  /* ===========================
     Your Lambda + Model
  =========================== */
  const API_URL = "https://hhkaj4azuk6zqykrqdk2dmo6bi0mixvp.lambda-url.eu-central-1.on.aws/";
  const MODEL_ID = "veo-3.1-generate-001";

  /* ===========================
     State
  =========================== */
  let cfg = null;
  let items = []; // {id, posterUrl, videoUrl, label}
  let selectedId = null;

  let trials = 3;
  let generating = false;
  const LAST_URL_KEY = "shaga3app_last_video_url";

  function getBrandKey(){
    const u = new URL(location.href);
    return (u.searchParams.get("brand") || "shaga3").toLowerCase();
  }

  function saveLastUrl(url){
    try { localStorage.setItem(LAST_URL_KEY, url); } catch(e) {}
  }
  function loadLastUrl(){
    try { return localStorage.getItem(LAST_URL_KEY) || ""; } catch(e) { return ""; }
  }

  /* ===========================
     Brand config loader
  =========================== */
  async function loadBrandConfig(){
    const brand = getBrandKey();
    const url = `brands/${brand}.json?v=${Date.now()}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error(`Cannot load ${url} (HTTP ${r.status})`);
    return await r.json();
  }

  function applyTheme(c){
    document.documentElement.style.setProperty("--accent", c.accent || "#5b5cff");
    document.documentElement.style.setProperty("--ok", c.ok || "#22c55e");
  }

  function applyBrandUI(c){
    $("brandTitle").textContent = c.title || "AI Video Lab";
    $("heroTitle").textContent = c.title || "AI Video Lab";
    $("betaText").textContent = c.beta_en || "Beta";

    // Logo (must exist)
    $("brandLogo").src = (c.logo || "assets/brand-logos/shaga3app.png") + "?v=" + Date.now();

    // Base prompt
    $("basePrompt").textContent = c.basePrompt_en || "BASE (LOCKED)\n\nCreate a 9:16 cinematic videoâ€¦";
  }

  /* ===========================
     Carousel + Selection
  =========================== */
  function renderDots(){
    const dots = $("dots");
    dots.innerHTML = "";
    items.forEach((it, idx) => {
      const d = document.createElement("div");
      d.className = "dot" + (it.id === selectedId ? " on" : "");
      dots.appendChild(d);
    });
  }

  function renderStrip(){
    const strip = $("strip");
    strip.innerHTML = "";
    items.forEach((it) => {
      const el = document.createElement("div");
      el.className = "thumb" + (it.id === selectedId ? " selected" : "");
      el.innerHTML = `
        <img src="${it.posterUrl}" alt="poster">
        <div class="badge">${it.label || "Demo"}</div>
      `;
      el.onclick = () => selectItem(it.id);
      strip.appendChild(el);
    });
    renderDots();
  }

  function showPoster(posterUrl){
    $("mainPoster").src = posterUrl || "";
    $("mainPoster").style.display = "block";
    $("mainVideo").style.display = "none";
    $("mainVideo").removeAttribute("src");
    $("mainVideo").load();
  }

  function showVideo(url){
    $("mainVideo").src = url;
    $("mainVideo").style.display = "block";
    $("mainPoster").style.display = "none";
    $("mainVideo").load();
    $("mainVideo").play().catch(()=>{});
  }

  function selectItem(id){
    selectedId = id;
    const it = items.find(x => x.id === id);
    if(!it) return;

    // If item has videoUrl show video; else show poster
    if(it.videoUrl){
      showVideo(it.videoUrl);
      saveLastUrl(it.videoUrl);
    }else{
      showPoster(it.posterUrl);
    }

    renderStrip();
  }

  function addGeneratedToCarousel(videoUrl){
    const id = "gen-" + Date.now();
    const posterFallback = items[0]?.posterUrl || "assets/demo/shaga3/1.jpg";

    // Put as first item
    items.unshift({
      id,
      posterUrl: posterFallback,  // (poster thumb placeholder; you can replace later)
      videoUrl,
      label: "New"
    });

    selectedId = id;
    renderStrip();
  }

  /* ===========================
     Prompt builder
  =========================== */
  function buildPrompt(){
    const base = $("basePrompt").textContent || "";
    const subject = ($("subject").value || "").trim();
    const location = ($("location").value || "").trim();
    const twist = ($("twist").value || "").trim();

    const parts = [];
    if(subject) parts.push(`Main subject: ${subject}`);
    if(location) parts.push(`Location: ${location}`);
    if(twist) parts.push(`Creative twist: ${twist}`);

    return `${base}\n\n---\n${parts.join("\n")}`.trim();
  }

  async function postJSON(payload){
    const url = API_URL + "?t=" + Date.now();
    const r = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }

    if(!r.ok){
      const msg = data?.error || data?.message || data?.raw || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return data;
  }

  /* ===========================
     Progress UI
  =========================== */
  function showStatus(msg){
    $("statusBox").style.display = "block";
    $("statusText").textContent = msg;
  }
  function hideStatus(){
    $("statusBox").style.display = "none";
    $("bar").style.width = "0%";
  }

  /* ===========================
     Generate (Real)
  =========================== */
  async function realGenerate(){
    if(generating) return;
    if(trials <= 0) return;
    generating = true;

    trials--;
    $("trialsLeft").textContent = String(trials);

    $("generateBtn").disabled = true;
    showStatus("Generatingâ€¦");
    $("bar").style.width = "10%";

    const maxSeconds = 60;
    const start = Date.now();
    let rafId = null;

    const tick = () => {
      const elapsed = (Date.now() - start) / 1000;
      const p = Math.min(95, 10 + (elapsed / maxSeconds) * 85);
      $("bar").style.width = p + "%";
      rafId = requestAnimationFrame(tick);
    };
    tick();

    try{
      const prompt = buildPrompt();

      const gen = await postJSON({
        action: "generate",
        modelId: MODEL_ID,
        prompt
      });

      // Some responses might be direct
      const directUrl = gen.downloadUrl || gen.response?.downloadUrl;
      if(gen.done && directUrl){
        $("bar").style.width = "100%";
        showStatus("Done âœ…");

        // âœ… show immediately in main preview
        showVideo(directUrl);
        saveLastUrl(directUrl);

        // âœ… add to carousel and select
        addGeneratedToCarousel(directUrl);
        selectItem(items[0].id);

        return;
      }

      const operationName = gen.operationName || gen.name;
      if(!operationName) throw new Error("No operationName returned");

      // poll
      const pollEveryMs = 3000;
      const maxPolls = 25;
      let doneUrl = "";

      for(let i=0;i<maxPolls;i++){
        await new Promise(res => setTimeout(res, pollEveryMs));
        const chk = await postJSON({
          action: "check",
          modelId: MODEL_ID,
          operationName
        });

        doneUrl = chk.downloadUrl || chk.response?.downloadUrl || "";
        if(chk.done && doneUrl) break;
      }

      if(!doneUrl) throw new Error("Still processing. Try again in a few seconds.");

      $("bar").style.width = "100%";
      showStatus("Done âœ…");

      // âœ… show immediately in main preview
      showVideo(doneUrl);
      saveLastUrl(doneUrl);

      // âœ… add to carousel and select
      addGeneratedToCarousel(doneUrl);
      selectItem(items[0].id);

    }catch(err){
      showStatus("Error: " + (err?.message || "Unknown error"));
      $("statusText").classList.add("err");
      $("bar").style.width = "0%";
    }finally{
      generating = false;
      $("generateBtn").disabled = false;
      if(rafId) cancelAnimationFrame(rafId);
      setTimeout(()=>hideStatus(), 2000);
    }
  }

  /* ===========================
     Copy / Download
  =========================== */
  function getCurrentVideoUrl(){
    const v = $("mainVideo");
    if(v && v.src) return v.src;
    return loadLastUrl();
  }

  function downloadFile(url){
    if(!url) return;
    const a = document.createElement("a");
    a.href = url;
    a.download = "video.mp4";
    a.target = "_blank";
    a.rel = "noopener";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  $("copyBtn").addEventListener("click", async ()=>{
    const url = getCurrentVideoUrl();
    if(!url) return alert("No video yet.");
    saveLastUrl(url);

    try{
      await navigator.clipboard.writeText(url);
      alert("Link copied âœ…");
    }catch(e){
      prompt("Copy link:", url);
    }
  });

  $("downloadBtn").addEventListener("click", ()=>{
    const url = getCurrentVideoUrl();
    if(!url) return alert("No video yet.");
    saveLastUrl(url);
    downloadFile(url);
  });

  $("generateBtn").addEventListener("click", realGenerate);

  /* ===========================
     Init
  =========================== */
  (async function init(){
    try{
      cfg = await loadBrandConfig();
      applyTheme(cfg);
      applyBrandUI(cfg);

      // Build items from demo posters (poster only; no mp4 preload)
      const posters = Array.isArray(cfg.demoPosters) ? cfg.demoPosters : [];
      items = posters.map((p, i) => ({
        id: "demo-" + i,
        posterUrl: p,
        videoUrl: "", // poster-only demo (fast)
        label: "Demo"
      }));

      // fallback if no posters
      if(items.length === 0){
        items = [{
          id:"demo-0",
          posterUrl:"assets/demo/shaga3/1.jpg",
          videoUrl:"",
          label:"Demo"
        }];
      }

      selectedId = items[0].id;
      renderStrip();
      showPoster(items[0].posterUrl);

      // restore last generated video (optional convenience)
      const last = loadLastUrl();
      if(last){
        // show generated result in main preview if exists
        showVideo(last);
        addGeneratedToCarousel(last);
        selectItem(items[0].id); // keeps generated as selected
      }

    }catch(e){
      $("basePrompt").textContent = "Error loading brand config: " + (e?.message || e);
      console.error(e);
    }
  })();
</script>
</body>
</html>
